<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Slient Plant</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mpwang.github.io/"/>
  <updated>2022-06-11T12:06:17.790Z</updated>
  <id>http://mpwang.github.io/</id>
  
  <author>
    <name>Randall Wang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用Intel NUC作为家用服务器</title>
    <link href="http://mpwang.github.io/2022/06/05/pve-openclash/"/>
    <id>http://mpwang.github.io/2022/06/05/pve-openclash/</id>
    <published>2022-06-04T23:52:24.000Z</published>
    <updated>2022-06-11T12:06:17.790Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orge6531f7">1. 硬件与安装</a></li><li class="tab"><a class="btn" href="#tab-orga3b1ec9">2. PVE 使用</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orge6531f7"><ul><a href="#orge6531f7">1. 硬件与安装</a><li><a href="#org692f2d3">1.1. Intel NUC11 与 proxmox</a></li><li><a href="#orgbc6efcf">1.2. 安装 PVE</a></li></ul></div><div class="tab-pane" id="tab-orga3b1ec9"><ul><a href="#orga3b1ec9">2. PVE 使用</a><li><a href="#org35b4f83">2.1. 安装 Openwrt 作为旁路由</a></li><li><a href="#org659aa1e">2.1.1. 设置 Openclash</a></li><li><a href="#orgbb9093e">2.2. 设置旁路由</a></li><li><a href="#org4fe01ef">2.2.1. 修改 Openwrt 设置</a></li><li><a href="#orga474ffb">2.2.2. 修改主路由设置</a></li><li><a href="#orgcbe76d9">2.2.3. windows 机器设置 chrome 浏览器</a></li><li><a href="#org13c5a49">2.3. Pi-Hole</a></li><li><a href="#org6786794">2.4. HomeAssistant</a></li><li><a href="#org79a3156">2.5. aliyundrive-webdav</a></li><li><a href="#orga5f5b0e">2.6. Samba</a></li></ul></div></div></div><div id="outline-container-orge6531f7" class="outline-2"><h2 id="orge6531f7"><span class="section-number-2">1.</span> 硬件与安装</h2><div class="outline-text-2" id="text-1"></div><div id="outline-container-org692f2d3" class="outline-3"><h3 id="org692f2d3"><span class="section-number-3">1.1.</span> Intel NUC11 与 proxmox</h3><div class="outline-text-3" id="text-1-1"><p><a href="https://nucfans.com/p/1305.html" target="_blank" rel="noopener">从初代到11代，NUC 捡漏指南 <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>Intel NUC 11 低功耗，安静，体积比 Mac mini 还小，硬件强大，配上 16G 内存，一块 120G 的普通 SSD 作为 proxmox 的安装盘，一块 1T nvme 接口的 SSD 作为数据盘，可以满足大部分的需求。</p><p>使用 proxmox 作为虚拟化管理软件，可以方便地创建系统级容器(LXC)</p></div></div><div id="outline-container-orgbc6efcf" class="outline-3"><h3 id="orgbc6efcf"><span class="section-number-3">1.2.</span> 安装 PVE</h3><div class="outline-text-3" id="text-1-2"><p><a href="https://pve.proxmox.com/wiki/Prepare_Installation_Media#_instructions_for_windows" target="_blank" rel="noopener">https://pve.proxmox.com/wiki/Prepare_Installation_Media#_instructions_for_windows <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>使用 Etcher 烧录 ISO 文件至 USB 盘，插入目标主机，开机进入 BIOS 编辑引导盘从 USB 盘开始，安装 PVE</p></div></div></div><div id="outline-container-orga3b1ec9" class="outline-2"><h2 id="orga3b1ec9"><span class="section-number-2">2.</span> PVE 使用</h2><div class="outline-text-2" id="text-2"><p>使用 PVE 创建虚拟机或 LXC</p></div><div id="outline-container-org35b4f83" class="outline-3"><h3 id="org35b4f83"><span class="section-number-3">2.1.</span> 安装 Openwrt 作为旁路由</h3><div class="outline-text-3" id="text-2-1"><ul class="org-ul"><li>IMG 镜像文件来源<a href="https://github.com/ApertureG/OpenWrt/releases" target="_blank" rel="noopener">https://github.com/ApertureG/OpenWrt/releases <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><p>PVE 安装 Openwrt 设置  <a href="https://felixqu.com/2021/09/05/setup-openwrt-on-pve/" target="_blank" rel="noopener">https://felixqu.com/2021/09/05/setup-openwrt-on-pve/ <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>注意复制上传的镜像文件路径以及创建虚拟机之后编辑引导顺序</p></li></ul></div><div id="outline-container-org659aa1e" class="outline-4"><h4 id="org659aa1e"><span class="section-number-4">2.1.1.</span> 设置 Openclash</h4><div class="outline-text-4" id="text-2-1-1"><p>Openwrt 镜像中已经安装了 openclash，登录 Openwrt 在服务中找到 openclash</p><p>配置文件管理，可以先手动上传一份配置文件，再设置配置文件订阅</p></div></div></div><div id="outline-container-orgbb9093e" class="outline-3"><h3 id="orgbb9093e"><span class="section-number-3">2.2.</span> 设置旁路由</h3><div class="outline-text-3" id="text-2-2"></div><div id="outline-container-org4fe01ef" class="outline-4"><h4 id="org4fe01ef"><span class="section-number-4">2.2.1.</span> 修改 Openwrt 设置</h4><div class="outline-text-4" id="text-2-2-1"><p>登录 openwrt</p><p>网络 -> 接口 LAN -> 修改</p><p>－般配置 -> 基本配置 -> IPv4 网关: 填写主路由 IP                     -> IPv4 广播: 设置为主路由网段，最后一位为 255                     -> 使用自定义的 DNS 服务器: 填写主路由 IP         -> 物理设置 -> 桥接接口: 取消勾选                     -> 接口: 选择对应的硬件 LAN 接口</p><p>DHCP 服务器 -> IPv6 设置 -> DHCPv6 服务: 修改为已禁用</p><p>保存&应用</p></div></div><div id="outline-container-orga474ffb" class="outline-4"><h4 id="orga474ffb"><span class="section-number-4">2.2.2.</span> 修改主路由设置</h4><div class="outline-text-4" id="text-2-2-2"><p>登录主路由</p><p>内部网络(LAN) -> DHCP 服务器 -> 基本设置 -> 默认网关: 填写为 Openwrt 的 IP                                         -> DNS 服务器设置: 填写为 Openwrt 的 IP</p><p>这种设置为主路由不关闭 DHCP 服务器，只设置 DHCP 的默认网关</p><p>保存&应用</p></div></div><div id="outline-container-orgcbe76d9" class="outline-4"><h4 id="orgcbe76d9"><span class="section-number-4">2.2.3.</span> windows 机器设置 chrome 浏览器</h4><div class="outline-text-4" id="text-2-2-3"><p>设置后发现接入家用网络的 windows 机器出现以下现象</p><ul class="org-ul"><li>github 无法访问</li><li>youtube 可以访问，但是无法播放视频</li></ul><p>解决方法</p><p>chrome://settings 搜索 dns</p><p>security -> Advanced -> Use secure DNS 选择 With Cloudflare 1.1.1.1</p></div></div></div><div id="outline-container-org13c5a49" class="outline-3"><h3 id="org13c5a49"><span class="section-number-3">2.3.</span> Pi-Hole</h3><div class="outline-text-3" id="text-2-3"><p>可以选择创建 Ubuntu 容器安装 Pi-Hole 用于广告过滤以及网络流量监控</p><p>网络拓扑在加入 Pi-Hole 之后</p><p></p></div></div><div id="outline-container-org6786794" class="outline-3"><h3 id="org6786794"><span class="section-number-3">2.4.</span> HomeAssistant</h3><div class="outline-text-3" id="text-2-4"><p>安装 HomeAssistant 将小米设备接入 Apple HomeKit，通过 Siri 控制家族智能设备</p><p>following the instruction of <a href="https://www.youtube.com/watch?v=tZflVxBq6Sw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=tZflVxBq6Sw <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>HomeAssistant 虚拟机启动报错问题:</p><blockquote><p>in the Proxmox VM. When you see the Proxmox logo when booting a VM, hit escape and then go to Device Manager -> Secure BootConfiguration then disable Attempt Secure Boot.</p></blockquote></div></div><div id="outline-container-org79a3156" class="outline-3"><h3 id="org79a3156"><span class="section-number-3">2.5.</span> aliyundrive-webdav</h3><div class="outline-text-3" id="text-2-5"><p>将阿里云盘作为文件夹挂载到 windows 电脑中</p><p><a href="https://opssh.cn/luyou/189.html" target="_blank" rel="noopener">https://opssh.cn/luyou/189.html <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p><a href="https://github.com/messense/aliyundrive-webdav" target="_blank" rel="noopener">https://github.com/messense/aliyundrive-webdav <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div></div><div id="outline-container-orga5f5b0e" class="outline-3"><h3 id="orga5f5b0e"><span class="section-number-3">2.6.</span> Samba</h3><div class="outline-text-3" id="text-2-6"><p>设置 Sambda 服务器，用于局域网共享文件夹</p><p>将 1T 的 SSD 格式化之后挂载到 PVE.</p><p>挂载路径 <b>/mnt/data*，创建用于共享的文件夹 */mnt/data/share</b></p><p>PVE 创建 Ubuntu LXC ，创建后不启动，如 LXC ID 为 104</p><p>在 PVE 上编辑配置文件 <b>/etc/pve/lxc/104.conf</b> 加入 <a href="https://pve.proxmox.com/wiki/Linux_Container#_bind_mount_points" target="_blank" rel="noopener">bind mount <i class="fa fa-external-link" aria-hidden="true"></i></a>，将共享文件夹挂载到容器内的 <b>/mnt/share</b> 路径</p><blockquote><p>mp0: /mnt/data/share,mp=/mnt/share</p></blockquote><p>启动容器，安装 Samba</p><pre class="example">apt update && apt upgrade -yapt install net-tools #Needed for ifconfig, etc.apt install samba# 新建用户adduser --system smbusr# 设置密码smbpasswd -a smbusr</pre><p>编辑文件 /etc/samba/smb.conf 加入</p><pre class="example">[Share]    comment = Share    path = /mnt/share    read only = no    writeable = yes    browsable = yes    force user = smbusr</pre><pre class="example">service smbd restartufw allow samba</pre></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Misc" scheme="http://mpwang.github.io/tags/Misc/"/>
    
  </entry>
  
  <entry>
    <title>windows11使用WSLg方式使用Emacs</title>
    <link href="http://mpwang.github.io/2022/05/31/emacs-on-win11-wslg/"/>
    <id>http://mpwang.github.io/2022/05/31/emacs-on-win11-wslg/</id>
    <published>2022-05-30T17:49:44.000Z</published>
    <updated>2022-05-30T18:57:49.392Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orgcf3383f">1. wslg</a></li><li class="tab"><a class="btn" href="#tab-org9be858c">2. emacs</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orgcf3383f"><ul><a href="#orgcf3383f">1. wslg</a><li><a href="#org5b2b993">1.1. 中文字体</a></li></ul></div><div class="tab-pane" id="tab-org9be858c"><ul><a href="#org9be858c">2. emacs</a><li><a href="#org54445df">2.1. 安装 Emacs 29</a></li><li><a href="#org66ffd8c">2.2. Emacs 中文输入法 pyim</a></li><li><a href="#org3ab6aed">2.3. Emacs 复制文本至 Windows 剪贴板</a></li></ul></div></div></div><div id="outline-container-orgcf3383f" class="outline-2"><h2 id="orgcf3383f"><span class="section-number-2">1.</span> wslg</h2><div class="outline-text-2" id="text-1"><p>在 windows 下使用原生的 Emacs 一直是个麻烦的事情，比如以下问题</p><ul class="org-ul"><li>windows 文件路径形式的匹配，</li><li>缺少 Linux 常用命令(使用如 <a href="http://gnuwin32.sourceforge.net/" target="_blank" rel="noopener">GnuWin32 <i class="fa fa-external-link" aria-hidden="true"></i></a>, <a href="https://github.com/uutils/coreutils" target="_blank" rel="noopener">coreutils <i class="fa fa-external-link" aria-hidden="true"></i></a>等项目)</li><li>环境变量的设置</li><li>编译麻烦</li></ul><p>而且最大的问题出在性能上，无法和在 Linux/MacOS 上使用经验相媲美。</p><p>windows 11 推出后支持使用 <a href="https://docs.microsoft.com/en-us/windows/wsl/tutorials/gui-apps" target="_blank" rel="noopener">wslg <i class="fa fa-external-link" aria-hidden="true"></i></a> 的形式使用 Linux 应用图形化界面。目前看来在 windows 上以这种形式使用 Emacs 体验十分不错。</p><p>在安装好 WSL2 之后，选择使用 Ubuntu 20.0 创建虚拟机。</p></div><div id="outline-container-org5b2b993" class="outline-3"><h3 id="org5b2b993"><span class="section-number-3">1.1.</span> 中文字体</h3><div class="outline-text-3" id="text-1-1"><p>配置 Ubuntu 系统的中文字体, 按照<a href="https://kknews.cc/code/pjv5rb8.html" target="_blank" rel="noopener">这篇文章 <i class="fa fa-external-link" aria-hidden="true"></i></a>的 1.5.1 及 1.5.2 两个章节操作，安装中文支持及配置中文字体。</p></div></div></div><div id="outline-container-org9be858c" class="outline-2"><h2 id="org9be858c"><span class="section-number-2">2.</span> emacs</h2><div class="outline-text-2" id="text-2"></div><div id="outline-container-org54445df" class="outline-3"><h3 id="org54445df"><span class="section-number-3">2.1.</span> 安装 Emacs 29</h3><div class="outline-text-3" id="text-2-1"><p>使用本地编译方式安装 Emacs 29.0.50</p><ul class="org-ul"><li><b>–with-native-compilation</b> Emacs Lisp bytecode is translated to C and then machine code, yielding performance benefits.</li><li>WSLg uses Wayland and Emacs 29.0.50 master has the pure GTK feature instead of relying on the older X window system.</li></ul><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">git clone git://git.sv.gnu.org/emacs.git emacs-sourcecd emacs-sourcesudo apt install build-essential libgtk-3-dev libgnutls28-dev libtiff5-dev libgif-dev libjpeg-dev libpng-dev libxpm-dev libncurses-dev texinfo# Native JSONsudo apt install libjansson4 libjansson-dev# Native Complilationsudo apt install libgccjit0 libgccjit-10-dev gcc-10 g++-10./audogen.shexport CC=/usr/bin/gcc-10 CXX=/usr/bin/gcc-10./configure --with-native-compilation --with-json --with-pgtkmake -j6sudo make install</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org66ffd8c" class="outline-3"><h3 id="org66ffd8c"><span class="section-number-3">2.2.</span> Emacs 中文输入法 pyim</h3><div class="outline-text-3" id="text-2-2"><p>使用 wslg 方式使用 Emacs，windows 的中文输入法在 Emacs 应用上无法生效。使用 Emacs 原生的<a href="https://github.com/tumashu/pyim" target="_blank" rel="noopener">中文输入法 pyim <i class="fa fa-external-link" aria-hidden="true"></i></a> 来解决这个问题，无需使用系统输入法来回切换，使用起来也十分流畅。</p><p>以下是使用 use-package 配置 pyim 使用五笔输入法的例子，需要安装 <b>pyim</b> <b>pyim-wbdict</b></p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">use-package</span> pyim</span><br><span class="line">    <span class="keyword">:ensure</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">:config</span></span><br><span class="line">    <span class="list">(<span class="keyword">use-package</span> pyim-wbdict</span><br><span class="line">      <span class="keyword">:config</span></span><br><span class="line">      <span class="keyword">:ensure</span> <span class="literal">nil</span></span><br><span class="line">      <span class="keyword">:config</span> <span class="list">(<span class="keyword">pyim-wbdict-gbk-enable</span>)</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="list">(<span class="keyword">setq</span> default-input-method <span class="string">"pyim"</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">setq</span> pyim-default-scheme <span class="quoted">'wubi</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">pyim-wbdict-v86-enable</span>)</span></span><br><span class="line">    <span class="comment">;; (pyim-wbdict-v98-enable)</span></span><br><span class="line">    <span class="comment">;; (pyim-wbdict-v98-morphe-enable)</span></span><br><span class="line">    <span class="comment">;; (pyim-wbdict-v86-single-enable)</span></span><br><span class="line"></span><br><span class="line">    <span class="list">(<span class="keyword">setq</span> pyim-page-tooltip <span class="quoted">'popup</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">setq</span> pyim-page-length <span class="number">5</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">add-hook</span> <span class="quoted">'emacs-startup-hook</span> #<span class="quoted">'(lambda () (pyim-restart-1 <span class="literal">t</span>))</span>)</span></span><br><span class="line">    )</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org3ab6aed" class="outline-3"><h3 id="org3ab6aed"><span class="section-number-3">2.3.</span> Emacs 复制文本至 Windows 剪贴板</h3></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
  </entry>
  
  <entry>
    <title>代码之外的功夫</title>
    <link href="http://mpwang.github.io/2020/05/22/beyond-coding/"/>
    <id>http://mpwang.github.io/2020/05/22/beyond-coding/</id>
    <published>2020-05-22T08:53:11.000Z</published>
    <updated>2020-05-22T10:44:59.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orge4d8c70">1. 代码之外的功夫</a></li><li class="tab"><a class="btn" href="#tab-orgd24adfa">2. 信息的信噪比</a></li><li class="tab"><a class="btn" href="#tab-org9b691eb">3. 提高搜索信息的效率</a></li><li class="tab"><a class="btn" href="#tab-orgcfe708b">4. 知识组织的步骤</a></li><li class="tab"><a class="btn" href="#tab-orga66cfcf">5. 善用工具</a></li><li class="tab"><a class="btn" href="#tab-org075f424">6. 学习</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orge4d8c70"><ul><a href="#orge4d8c70">1. 代码之外的功夫</a></ul></div><div class="tab-pane" id="tab-orgd24adfa"><ul><a href="#orgd24adfa">2. 信息的信噪比</a><li><a href="#org9a01648">2.1. 信息不再贫乏</a></li><li><a href="#orgcedbef2">2.2. 认知科学: 大脑的主动识别模式</a></li><li><a href="#org4c01eb8">2.3. 提高信息来源的质量</a></li><li><a href="#orgfa55574">2.4. 高质量的信息来源</a></li></ul></div><div class="tab-pane" id="tab-org9b691eb"><ul><a href="#org9b691eb">3. 提高搜索信息的效率</a><li><a href="#org2d67983">3.1. 时代的改变</a></li><li><a href="#org7178063">3.2. 正确地使用搜索引擎</a></li><li><a href="#org2466e15">3.3. 搜索引擎之外</a></li></ul></div><div class="tab-pane" id="tab-orgcfe708b"><ul><a href="#orgcfe708b">4. 知识组织的步骤</a><li><a href="#org1de86aa">4.1. 学习计划的制定和安排</a></li><li><a href="#org0df7db5">4.2. 学习材料的收集和储存</a></li><li><a href="#org0b91397">4.3. 资料的阅读和消化</a></li><li><a href="#org2285639">4.4. 知识的思考和产出</a></li></ul></div><div class="tab-pane" id="tab-orga66cfcf"><ul><a href="#orga66cfcf">5. 善用工具</a><li><a href="#orge85f244">5.1. 你是工具增强过的人类</a></li><li><a href="#orga904bf8">5.2. 使用好的工具</a></li></ul></div><div class="tab-pane" id="tab-org075f424"><ul><a href="#org075f424">6. 学习</a><li><a href="#orgbc3550f">6.1. 知识更新速度快</a></li><li><a href="#org0d1dbdf">6.2. 动机</a></li><li><a href="#org1e50d34">6.3. 方式</a></li><li><a href="#org46fa2cf">6.4. 自我教育</a></li></ul></div></div></div><div id="outline-container-orge4d8c70" class="outline-2"><h2 id="orge4d8c70"><span class="section-number-2">1.</span> 代码之外的功夫</h2><div class="outline-text-2" id="text-1"><p>根据我在公司的分享材料整理, 细节大多靠自己口头表述, 此处只列出大纲</p></div></div><div id="outline-container-orgd24adfa" class="outline-2"><h2 id="orgd24adfa"><span class="section-number-2">2.</span> 信息的信噪比</h2><div class="outline-text-2" id="text-2"><blockquote><p>在今天的中国,你基本上不用做什么,只需要不使用中国互联网,你就很自然地超过大多数人了</p></blockquote><p><a href="https://coolshell.cn/articles/19464.html" target="_blank" rel="noopener">如何超过大多数人 <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div><div id="outline-container-org9a01648" class="outline-3"><h3 id="org9a01648"><span class="section-number-3">2.1.</span> 信息不再贫乏</h3><div class="outline-text-3" id="text-2-1"><p>随手可及的信息</p><ul class="org-ul"><li>独立博客</li><li>播客</li><li>聚合类网站</li><li>应用</li><li>社交网站</li></ul><p>缺乏的是有效的搜索信息以及快速从大量的信息中提取有用信息的技能</p></div></div><div id="outline-container-orgcedbef2" class="outline-3"><h3 id="orgcedbef2"><span class="section-number-3">2.2.</span> 认知科学: 大脑的主动识别模式</h3><div class="outline-text-3" id="text-2-2"><p><img src="/2020/05/22/beyond-coding/2020-05-22_17-02-15_6386ebc5477f7d735f01e8791183620c_b.jpg"></p><blockquote><p>一个视错觉的经典例子: 正方形的轮廓线并没有被直接描画出来，但是人眼能够立刻从背景中识别出一个白色的正方形形状</p></blockquote><p>信息质量很重要</p></div></div><div id="outline-container-org4c01eb8" class="outline-3"><h3 id="org4c01eb8"><span class="section-number-3">2.3.</span> 提高信息来源的质量</h3><div class="outline-text-3" id="text-2-3"><ul class="org-ul"><li>拒绝劣质消息来源</li><li>朋友圈/微博/抖音不是学习的好地方</li><li>阅读第一手资料(权威来源,官方文档,知名公司技术博客,原始出处的书籍和文章)</li><li>阅读英文文档(中文翻译可能滞后)</li></ul></div></div><div id="outline-container-orgfa55574" class="outline-3"><h3 id="orgfa55574"><span class="section-number-3">2.4.</span> 高质量的信息来源</h3><div class="outline-text-3" id="text-2-4"><p>出版社O'Reilly / No Starch Press / The Pragmatic Bookshelf / Manning Publications</p><p>聚合类网站InfoQ / Solidot / Plannet Python / Hacker News</p><p>技术博客coolshell 湾区日报</p></div></div></div><div id="outline-container-org9b691eb" class="outline-2"><h2 id="org9b691eb"><span class="section-number-2">3.</span> 提高搜索信息的效率</h2><div class="outline-text-2" id="text-3"></div><div id="outline-container-org2d67983" class="outline-3"><h3 id="org2d67983"><span class="section-number-3">3.1.</span> 时代的改变</h3><div class="outline-text-3" id="text-3-1"><p>搜索引擎改变了人类记忆和搜索知识的方式</p><p>百科全书式的记忆重要性下降了</p><p>重视知识的组织和联系</p></div></div><div id="outline-container-org7178063" class="outline-3"><h3 id="org7178063"><span class="section-number-3">3.2.</span> 正确地使用搜索引擎</h3><div class="outline-text-3" id="text-3-2"><p>掌握搜索引擎的高级搜索技巧 (自行 Google)</p></div></div><div id="outline-container-org2466e15" class="outline-3"><h3 id="org2466e15"><span class="section-number-3">3.3.</span> 搜索引擎之外</h3><div class="outline-text-3" id="text-3-3"><p>垂直细分领域</p><ul class="org-ul"><li>stackoverflow / stackexchange / segmentfault</li><li>github (很多人意料之外,在 github 其实可能搜出很有用的信息)</li></ul></div></div></div><div id="outline-container-orgcfe708b" class="outline-2"><h2 id="orgcfe708b"><span class="section-number-2">4.</span> 知识组织的步骤</h2><div class="outline-text-2" id="text-4"><ul class="org-ul"><li>学习计划的制定和安排</li><li>学习材料的收集和储存</li><li>资料的阅读和消化</li><li>知识的思考和产出</li></ul></div><div id="outline-container-org1de86aa" class="outline-3"><h3 id="org1de86aa"><span class="section-number-3">4.1.</span> 学习计划的制定和安排</h3></div><div id="outline-container-org0df7db5" class="outline-3"><h3 id="org0df7db5"><span class="section-number-3">4.2.</span> 学习材料的收集和储存</h3><div class="outline-text-3" id="text-4-2"><p>知识的获取 来源</p><ul class="org-ul"><li>RSS</li><li>BLOG</li><li>Podcasts</li></ul><p>应用</p><ul class="org-ul"><li>Pocket</li><li>Evernote / Notion</li></ul></div></div><div id="outline-container-org0b91397" class="outline-3"><h3 id="org0b91397"><span class="section-number-3">4.3.</span> 资料的阅读和消化</h3><div class="outline-text-3" id="text-4-3"><blockquote><p>好记性不如烂笔头</p></blockquote><p>知识的加工和组织处理知识,加深神经元的连接</p><p>纸和笔重视纸和笔,成本最低,自由度最高,使用最便利</p><p>应用</p><ul class="org-ul"><li>PDF 阅读软件 MarginNote3</li><li>平板 iPad/Surface</li><li>思维导图</li></ul><p>康奈尔笔记法: 用自己的话进行复述,列出大纲,使用自己的理解</p></div></div><div id="outline-container-org2285639" class="outline-3"><h3 id="org2285639"><span class="section-number-3">4.4.</span> 知识的思考和产出</h3><div class="outline-text-3" id="text-4-4"><p>产出 记录</p><p><a href="http://hexo.io" target="_blank" rel="noopener">hexo <i class="fa fa-external-link" aria-hidden="true"></i></a> static website generator</p><p><a href="https://pages.github.com" target="_blank" rel="noopener">github pages websites for you and your projects <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>markdown</p></div></div></div><div id="outline-container-orga66cfcf" class="outline-2"><h2 id="orga66cfcf"><span class="section-number-2">5.</span> 善用工具</h2><div class="outline-text-2" id="text-5"></div><div id="outline-container-orge85f244" class="outline-3"><h3 id="orge85f244"><span class="section-number-3">5.1.</span> 你是工具增强过的人类</h3><div class="outline-text-3" id="text-5-1"><p>你手上的手机的算力超过 50 年前 1969 年美国执行登月行动时整个 NASA 的计算能力</p><p>设想自己在没有智能手机和笔记本情况下的生产力</p></div></div><div id="outline-container-orga904bf8" class="outline-3"><h3 id="orga904bf8"><span class="section-number-3">5.2.</span> 使用好的工具</h3><div class="outline-text-3" id="text-5-2"><ul class="org-ul"><li>高效的工作环境 ( ConEmu / zsh / FreeCommander / PyCharm )</li><li>熟悉你的工具 掌握每天都使用的工具是提高效率的重要部分</li><li>投资硬件 (屏幕/键盘/工作台/轨迹球)</li></ul><p>最重要的是,用好手上的工具,比盲目追求好工具/新工具重要</p></div></div></div><div id="outline-container-org075f424" class="outline-2"><h2 id="org075f424"><span class="section-number-2">6.</span> 学习</h2><div class="outline-text-2" id="text-6"></div><div id="outline-container-orgbc3550f" class="outline-3"><h3 id="orgbc3550f"><span class="section-number-3">6.1.</span> 知识更新速度快</h3><div class="outline-text-3" id="text-6-1"><p>前端:jQuery AngularJS Angular2/4/6Vue.js React TypeScriptNodeJs Deno WebAssembly</p><p>后端:Hadoop Spark Storm微服务 容器 K8S</p></div></div><div id="outline-container-org0d1dbdf" class="outline-3"><h3 id="org0d1dbdf"><span class="section-number-3">6.2.</span> 动机</h3><div class="outline-text-3" id="text-6-2"><p>回报</p><p>学习的回报相比其它行业周期更短</p><p>正向反馈循环</p><p>一件事有兴趣才会做得好,做得好才会更有兴趣,更有兴趣才会做得更好没有人会喜欢一直做一件自己做不好的事情</p></div></div><div id="outline-container-org1e50d34" class="outline-3"><h3 id="org1e50d34"><span class="section-number-3">6.3.</span> 方式</h3><div class="outline-text-3" id="text-6-3"><ul class="org-ul"><li>时间管理之外, 应该更重视精力管理</li><li>重视睡眠</li><li>系统性学习: 深度工作 ( <a href="https://book.douban.com/subject/27056409/" target="_blank" rel="noopener">Deep Work <i class="fa fa-external-link" aria-hidden="true"></i></a> )</li><li>碎片化学习: 泛读, 利用好碎片化时间, 播客(音频可以填充碎片时间或者不方便看书的时间)</li><li>保持技术敏感</li></ul></div></div><div id="outline-container-org46fa2cf" class="outline-3"><h3 id="org46fa2cf"><span class="section-number-3">6.4.</span> 自我教育</h3><div class="outline-text-3" id="text-6-4"><ul class="org-ul"><li>MIT OpenWareCourse</li><li>Coursera</li><li>edX</li><li>Khan Academy</li><li>网易公开课</li><li>TED 演讲</li></ul></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
      <category term="生产力" scheme="http://mpwang.github.io/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/"/>
    
  </entry>
  
  <entry>
    <title>Python 项目开发规范</title>
    <link href="http://mpwang.github.io/2019/10/20/python-convention/"/>
    <id>http://mpwang.github.io/2019/10/20/python-convention/</id>
    <published>2019-10-20T14:00:00.000Z</published>
    <updated>2019-10-20T15:33:36.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-org93e67ae">1. Python 项目开发规范</a></li><li class="tab"><a class="btn" href="#tab-orgf50cfc7">2. 代码风格</a></li><li class="tab"><a class="btn" href="#tab-org3ca70c9">3. 语言规范</a></li><li class="tab"><a class="btn" href="#tab-orge9ccec3">4. 编程原则与最佳实践</a></li><li class="tab"><a class="btn" href="#tab-org0008a04">5. References</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-org93e67ae"><ul><a href="#org93e67ae">1. Python 项目开发规范</a><li><a href="#org3fe422d">1.1. 阅读指南</a></li></ul></div><div class="tab-pane" id="tab-orgf50cfc7"><ul><a href="#orgf50cfc7">2. 代码风格</a><li><a href="#orgcfc6f06">2.1. 代码格式器</a></li><li><a href="#orgb6359d4">2.1.1. black 的使用</a></li><li><a href="#org44a1cae">2.2. import</a></li><li><a href="#org4a527c8">2.2.1. 禁止使用 import <code>*</code></a></li><li><a href="#orgb750803">2.2.2. import 语句的顺序</a></li><li><a href="#org89f08b9">2.3. 命名</a></li><li><a href="#org58c6837">2.3.1. 描述</a></li><li><a href="#org78db293">2.3.2. 避免使用的命名</a></li><li><a href="#org403829b">2.3.3. 命名约定</a></li><li><a href="#org49feec2">2.3.4. 变量名形式</a></li><li><a href="#orge4ecf4f">2.4. Main 方法</a></li><li><a href="#orgb2bab8b">2.5. 注释</a></li><li><a href="#org1345ac8">2.5.1. 解释为什么</a></li><li><a href="#org148001b">2.5.2. 错误的注释比没有注释还糟糕</a></li><li><a href="#org2272701">2.5.3. docstring</a></li><li><a href="#org283224e">2.5.4. inline comment</a></li><li><a href="#orge2d805e">2.6. 类型注解</a></li></ul></div><div class="tab-pane" id="tab-org3ca70c9"><ul><a href="#org3ca70c9">3. 语言规范</a><li><a href="#orgd6f2239">3.1. 导入</a></li><li><a href="#org3246861">3.1.1. 例外</a></li><li><a href="#org58fe324">3.2. 包</a></li><li><a href="#org7de52e2">3.3. 类</a></li><li><a href="#orgfb89587">3.4. 异常</a></li><li><a href="#orgf390a05">3.4.1. 自定义异常</a></li><li><a href="#orgd708034">3.4.2. 异常抛出的形式</a></li><li><a href="#org044ffd1">3.4.3. 注意异常捕获的范围</a></li><li><a href="#org7257321">3.4.4. 尽量减少 try except 语法块内代码的数量</a></li><li><a href="#org50cc356">3.4.5. 使用 try except else finally 结构</a></li><li><a href="#orgf424303">3.4.6. assert</a></li><li><a href="#orgf39f83d">3.5. 全局变量</a></li><li><a href="#org790671a">3.6. 列表表达式 (list compreshensions)</a></li><li><a href="#org2b2fe2f">3.7. 默认迭代器和操作符</a></li><li><a href="#org49f7f05">3.8. lambda 表达式</a></li><li><a href="#org7c2be79">3.9. 条件表达式</a></li><li><a href="#org1c4dfd2">3.10. 函数参数默认值</a></li><li><a href="#org797804c">3.11. True/False 求值</a></li><li><a href="#org669259f">3.12. 格式化字符串</a></li><li><a href="#org74c2c59">3.12.1. 例外</a></li></ul></div><div class="tab-pane" id="tab-orge9ccec3"><ul><a href="#orge9ccec3">4. 编程原则与最佳实践</a><li><a href="#orgbf4a7a6">4.1. 使用 pylint</a></li><li><a href="#orgfb26bab">4.2. 自底向上编程</a></li><li><a href="#org5644270">4.3. 防御式编程</a></li><li><a href="#org351475a">4.4. 避免使用 magic number</a></li><li><a href="#org897eabf">4.5. 处理字典 key 不存在时的默认值</a></li></ul></div><div class="tab-pane" id="tab-org0008a04"><ul><a href="#org0008a04">5. References</a></ul></div></div></div><div id="outline-container-org93e67ae" class="outline-2"><h2 id="org93e67ae"><span class="section-number-2">1.</span> Python 项目开发规范</h2><div class="outline-text-2" id="text-1"><p>本文旨在提供 Python 项目的开发规范参考以及工具指南,一些最佳实践以及通用的编程原则.</p><p>本文对于风格规范/工具/流程的选择不可避免的有偏向性,不同的项目组可以根据自身的情况去调整.</p><p>每个团队和项目都有自己的代码风格与编程约定,重点不在于哪种风格规范/工具/流程更好,而在于开发者可以在 项目中使用一致的风格规范/工具/流程.这有助于开发者理解项目以及提高项目的可维护性.</p></div><div id="outline-container-org3fe422d" class="outline-3"><h3 id="org3fe422d"><span class="section-number-3">1.1.</span> 阅读指南</h3><div class="outline-text-3" id="text-1-1"><p>由于 Python 2 将于 2020 年正式停止维护, 新的工程项目禁止使用 Python 2,应当使用 Python 3, 推荐使用 <code>>= Python 3.6.5</code> 的版本.</p><p>请注意以下所有的讨论都是基于 Python 3, 或者是在忽略/没有考虑兼容 Python2 的情况下进行.</p></div></div></div><div id="outline-container-orgf50cfc7" class="outline-2"><h2 id="orgf50cfc7"><span class="section-number-2">2.</span> 代码风格</h2><div class="outline-text-2" id="text-2"><pre class="example">代码风格应该遵循 PEP8 风格</pre><p>代码风格指南是关于代码格式的细致规定,但是幸运的是我们不需要记住这些多代码风格的规则.使用代码格式器(formatter)可以帮助我们自动格式 化代码以遵循代码风格.</p><p>流行的 Python 风格有</p><ul class="org-ul"><li><a href="https://www.python.org/dev/peps/pep-0008/" target="_blank" rel="noopener">PEP8 风格 <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://google.github.io/styleguide/pyguide.html" target="_blank" rel="noopener">Google style <i class="fa fa-external-link" aria-hidden="true"></i></a></li></ul><p>我们选择的 PEP8 风格. 具体的细节规定请自行阅读 PEP8 文档.</p></div><div id="outline-container-orgcfc6f06" class="outline-3"><h3 id="orgcfc6f06"><span class="section-number-3">2.1.</span> 代码格式器</h3><div class="outline-text-3" id="text-2-1"><pre class="example">formatter 选择使用 Black.</pre><p>流行的代码格式器有</p><ul class="org-ul"><li><a href="https://github.com/psf/black" target="_blank" rel="noopener">Black <i class="fa fa-external-link" aria-hidden="true"></i></a> PEP8</li><li><a href="https://github.com/google/yapf" target="_blank" rel="noopener">yapf <i class="fa fa-external-link" aria-hidden="true"></i></a> 对应 Google style</li><li><a href="https://github.com/hhatto/autopep8" target="_blank" rel="noopener">autopep8 <i class="fa fa-external-link" aria-hidden="true"></i></a> PEP8</li></ul><p>Black 使用的代码风格可以视为比 PEP8 风格还严格的一个子集,格式化之后的代码风格可以通过 PEP8 风格的检查.</p></div><div id="outline-container-orgb6359d4" class="outline-4"><h4 id="orgb6359d4"><span class="section-number-4">2.1.1.</span> black 的使用</h4><div class="outline-text-4" id="text-2-1-1"><p>black 可以通用命令行使用对单个文件或者整个文件夹的文件进行格式化.建议将 black 添加到 PyCharm 的 external tool 中并绑定快捷键.</p><p>配置 PyCharm</p><pre class="example">File -> Settings -> Tools -> External Toolsthe Click + icon to add a new external tool with the following values:- Name: Black- Description:- Programe: 选择安装的 Black.exe- Arguments: $FilePath$</pre><p>使用 右击文件 -> External Tools -> Black</p><p>绑定快捷键</p><pre class="example">File -> Settings -> Keymap搜索 external tool 找到 Balck 对应的条目, 点击编程绑定一个快捷键 Alt+Shift+F</pre></div></div></div><div id="outline-container-org44a1cae" class="outline-3"><h3 id="org44a1cae"><span class="section-number-3">2.2.</span> import</h3><div class="outline-text-3" id="text-2-2"><pre class="example">使用独立的一行导入一个模块</pre><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> extres.vcenter.datatype <span class="keyword">import</span> SaltCallFailedException</span><br><span class="line"><span class="keyword">from</span> extres.vcenter.datatype <span class="keyword">import</span> VCenterInitializeOptions</span><br><span class="line"><span class="keyword">from</span> extres.vcenter.datatype <span class="keyword">import</span> VCenterVMCloneSpec</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> extres.vcenter.datatype <span class="keyword">import</span> SaltCallFailedException, VCenterInitializeOptions, VCenterVMCloneSpec</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="keyword">from</span> extres.vcenter.datatype <span class="keyword">import</span> (</span><br><span class="line">    SaltCallFailedException,</span><br><span class="line">    VCenterInitializeOptions,</span><br><span class="line">    VCenterVMCloneSpec,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div></div><div id="outline-container-org4a527c8" class="outline-4"><h4 id="org4a527c8"><span class="section-number-4">2.2.1.</span> 禁止使用 import <code>*</code></h4><div class="outline-text-4" id="text-2-2-1"><pre class="example">原则上禁止避免使用 import *, 应该显式地列出每一个需要导入的模块</pre><p>使用 <code>import *</code> 会污染当前命名空间的变量,无法找到变量的定义是来哪个模块, 在被 import 的模块上的改动可能会在预期外地影响到其它模块, 可能会引起难以排查的问题.</p><p>在某些必须需要使用或者是惯用法 <code>from foo import *</code> 的场景下,应该在模块 foo 的末尾使用 <code>__all__</code> 控制被导出的变量.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># foo.py</span></span><br><span class="line">CONST_VALUE = <span class="number">1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">__all__ = (<span class="string">"CONST_VALUE"</span>, <span class="string">"Apple"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bar.py</span></span><br><span class="line"><span class="comment"># noinspection PyUnresolvedReferences</span></span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgb750803" class="outline-4"><h4 id="orgb750803"><span class="section-number-4">2.2.2.</span> import 语句的顺序</h4><div class="outline-text-4" id="text-2-2-2"><p>使用 PyCharm 的 Optimize imports 功能格式化导入语句,避免手动管理 import 语句的顺序, 除非 某些包的 import 需要有明确的先后顺序.</p><p>注意 Optimize imports 功能会将模块内没有使用的 import 语句删除,需要小心这一点以避免误删 import 引起问题.</p><p>在这种情况下需要加上注释以说明没有使用到的 import 语句需要保留.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># noinspection PyUnresolvedReferences</span></span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-org89f08b9" class="outline-3"><h3 id="org89f08b9"><span class="section-number-3">2.3.</span> 命名</h3><div class="outline-text-3" id="text-2-3"><p>名字(变量名,函数名,类名,方法名)本身是表达代码信息的重要组成部分,选取合适的名字就是选取了合适的抽象.</p><p>合适的名字可以让阅读代码本身就得到清晰的信息,减少需要注释或者外部文档进行说明的需求.</p></div><div id="outline-container-org58c6837" class="outline-4"><h4 id="org58c6837"><span class="section-number-4">2.3.1.</span> 描述</h4><div class="outline-text-4" id="text-2-3-1"><p>函数名, 类方法以动词开头; 类名, 类属性以名词开头.</p></div></div><div id="outline-container-org78db293" class="outline-4"><h4 id="org78db293"><span class="section-number-4">2.3.2.</span> 避免使用的命名</h4><div class="outline-text-4" id="text-2-3-2"><ul class="org-ul"><li>在任何地方都避免使用短横线 <code>-</code></li><li>避免使用 <code>__xxx__</code> 形式的名字, 这种形式的名字(magic method)保留给 Python 解析器使用</li><li>避免使用单个字符作为作为变量名(异常或者迭代器除外)</li></ul></div></div><div id="outline-container-org403829b" class="outline-4"><h4 id="org403829b"><span class="section-number-4">2.3.3.</span> 命名约定</h4><div class="outline-text-4" id="text-2-3-3"><ul class="org-ul"><li><p>不要使用双下划线开头的形式(<code>__XXX</code>),使用单下划线开头(<code>_XXX</code>)的形式以表示是私有变量.</p><p>虽然双下划线开关的变量 Python 解释器会有特殊的处理(name mangling),但是 Python 语言没有真正的私有变量,使用双下划线变量名会影响可读性以及让该变量相关的单元测试更难编写,我们强烈不推荐使用这种形式, 更推 荐统一使用单下划线开头的形式</p></li><li>将相互关联的类以及函数放在一个模块中, 不需要限制一个模块只能有一个类</li><li>类的命名使用 <code>CamelCase</code> 命名(例如 CapWords),但是类所在的文件名使用 snake_case(例如 <code>cap_words.py</code>)</li><li>单元测试中的方法名可以使用下划线,这样的模式 <code>test<methoundertest>_<state></state></methoundertest></code> 是允许的, 例如 <code>testPop_EmptyStack</code></li></ul></div></div><div id="outline-container-org49feec2" class="outline-4"><h4 id="org49feec2"><span class="section-number-4">2.3.4.</span> 变量名形式</h4><div class="outline-text-4" id="text-2-3-4"><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><colgroup><col class="org-left"><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left">名字</th><th scope="col" class="org-left">公开变量</th><th scope="col" class="org-left">内部变量</th></tr></thead><tbody><tr><td class="org-left">包</td><td class="org-left">lower_with_under</td><td class="org-left"> </td></tr><tr><td class="org-left">模块</td><td class="org-left">lower_with_under</td><td class="org-left">_lower_with_under</td></tr><tr><td class="org-left">类</td><td class="org-left">CapWords</td><td class="org-left">_CapWords</td></tr><tr><td class="org-left">异常</td><td class="org-left">CapWords</td><td class="org-left"> </td></tr><tr><td class="org-left">函数</td><td class="org-left">lower_with_under()</td><td class="org-left">_lower_with_under()</td></tr><tr><td class="org-left">全局常量/类常量</td><td class="org-left">CAPS_WITH_UNDER</td><td class="org-left">_CAPS_WITH_UNDER</td></tr><tr><td class="org-left">全局变量/类变量</td><td class="org-left">lower_with_under</td><td class="org-left">_lower_with_under</td></tr><tr><td class="org-left">对象变量</td><td class="org-left">lower_with_under</td><td class="org-left">_lower_with_under (protected)</td></tr><tr><td class="org-left">方法名</td><td class="org-left">lower_with_under</td><td class="org-left">_lower_with_under (protected)</td></tr><tr><td class="org-left">函数/方法 参数名</td><td class="org-left">lower_with_under</td><td class="org-left"> </td></tr><tr><td class="org-left">局部变量名</td><td class="org-left">lower_with_under</td><td class="org-left"> </td></tr></tbody></table></div></div></div><div id="outline-container-orge4ecf4f" class="outline-3"><h3 id="orge4ecf4f"><span class="section-number-3">2.4.</span> Main 方法</h3><div class="outline-text-3" id="text-2-4"><pre class="example">在编写可执行的 Python 脚本时, 必须使用 if __name__ == '__main__'</pre><p>单元测试, 自动文档生成以及静态代码分析等工具都会 import 模块, 必须使用<code>__name__</code> 检查以防止该脚本被 import 时会被运行,这通常会造成严重的后果!</p><p>可执行脚本必须提供=main=方法作为入口.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgb2bab8b" class="outline-3"><h3 id="orgb2bab8b"><span class="section-number-3">2.5.</span> 注释</h3><div class="outline-text-3" id="text-2-5"></div><div id="outline-container-org1345ac8" class="outline-4"><h4 id="org1345ac8"><span class="section-number-4">2.5.1.</span> 解释为什么</h4><div class="outline-text-4" id="text-2-5-1"><p>一些非直观的代码需要进行注释, 注释应当从解释代码的意义,和为什么这么实现的角度出发, 简单和不言自明的代码不需要进行注释.</p><p>bad</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 遍历 items 输出 i</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> items:</span><br><span class="line">    print(str(i))</span><br></pre></td></tr></table></figure></div><p>good</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># true if and only if i is a power of 2</span></span><br><span class="line"><span class="keyword">if</span> i & (i-<span class="number">1</span>) == <span class="number">0</span>:</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org148001b" class="outline-4"><h4 id="org148001b"><span class="section-number-4">2.5.2.</span> 错误的注释比没有注释还糟糕</h4><div class="outline-text-4" id="text-2-5-2"><p>当代码发生变化时, 相关的注释也需要同步更新. 错误的注释往往比没有注释还具有误导性.</p></div></div><div id="outline-container-org2272701" class="outline-4"><h4 id="org2272701"><span class="section-number-4">2.5.3.</span> docstring</h4><div class="outline-text-4" id="text-2-5-3"><p>公开的类与函数应当使用 docstring 描述作用, 入参与返回值的作用.</p></div></div><div id="outline-container-org283224e" class="outline-4"><h4 id="org283224e"><span class="section-number-4">2.5.4.</span> inline comment</h4><div class="outline-text-4" id="text-2-5-4"><pre class="example">避免将代码与注释写在同一行, 在代码块之前进行注释</pre><p>inline comment 是指在代码与注释在同一行, 注释在行尾.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> i & (i-<span class="number">1</span>) == <span class="number">0</span>:  <span class="comment"># true if i is a power of 2</span></span><br></pre></td></tr></table></figure></div><p>不少编辑器以及风格检查器都会有行长限制检查, inline comment 容易使行长超过限制以及带来阅读上的障碍.</p><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">_referring_method_schema = getattr(referring_method, <span class="string">"_swagger_auto_schema"</span>, <span class="keyword">None</span>)  <span class="comment"># add swagger documentation of download_media_type</span></span><br><span class="line">_swagger_auto_scema = swagger_auto_schema(  <span class="comment"># generate GET action swagger schema</span></span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> <span class="string">"post"</span> <span class="keyword">in</span> bind_to_methos:  <span class="comment"># generate POST action swagger schema</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add swagger documentation of download_media_type</span></span><br><span class="line">_referring_method_schema = getattr(referring_method, <span class="string">"_swagger_auto_schema"</span>, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate GET action swagger schema</span></span><br><span class="line">_swagger_auto_scema = swagger_auto_schema(</span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate POST action swagger schema</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"post"</span> <span class="keyword">in</span> bind_to_methos:</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-orge2d805e" class="outline-3"><h3 id="orge2d805e"><span class="section-number-3">2.6.</span> 类型注解</h3><div class="outline-text-3" id="text-2-6"><pre class="example">强烈推荐尽可能多地使用类型注解</pre><p>Python 3 <a href="https://www.python.org/dev/peps/pep-0484/" target="_blank" rel="noopener">PEP484 <i class="fa fa-external-link" aria-hidden="true"></i></a>加入 type hint 的特性为 Python 添加了一个类型系统.该特性可以帮助开发者在开发阶段提前发现问题, 以及帮助大型项目使用 type checker 对代码进行分析.</p><p>Python 3 使用类型注解(type annotations)的方法来加入类型信息, Python 3 依旧是一门动态语言, 解析器在运行 时(runtime)会忽略所有的类型注解.</p><p>我们鼓励尽可能多地使用类型注释, 请熟悉 PEP484 的内容.</p><p>示例</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name: str)</span> -> <span class="title">None</span>:</span></span><br><span class="line">    print(f<span class="string">"Hello, {name}"</span>)</span><br></pre></td></tr></table></figure></div><p>类型注释规范请参考 <a href="https://google.github.io/styleguide/pyguide.html#319-type-annotations" target="_blank" rel="noopener">Type Annotated Code <i class="fa fa-external-link" aria-hidden="true"></i></a>, 考虑到目前采用 type hint 特性的项目还不多, 对于类型注释的规范暂不作规定.</p><p>在使用类型注解的同时应该使用 type checker 工具来进行静态代码分析.</p><p>可供选择的工具有:</p><ul class="org-ul"><li><a href="http://mypy-lang.org/" target="_blank" rel="noopener">mypy <i class="fa fa-external-link" aria-hidden="true"></i></a> from dropbox</li><li><a href="https://github.com/google/pytype" target="_blank" rel="noopener">pytype <i class="fa fa-external-link" aria-hidden="true"></i></a> from google</li><li><a href="https://github.com/microsoft/pyright" target="_blank" rel="noopener">pyright <i class="fa fa-external-link" aria-hidden="true"></i></a> from microsoft</li><li><a href="https://github.com/facebook/pyre-check" target="_blank" rel="noopener">pyre-check <i class="fa fa-external-link" aria-hidden="true"></i></a> from facebook</li></ul><p>我们的选择是使用 <code>mypy</code> <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup></p><p>使用 PyCharm 开发的团队可以使用 <a href="https://plugins.jetbrains.com/plugin/11086-mypy" target="_blank" rel="noopener">mypy plugin <i class="fa fa-external-link" aria-hidden="true"></i></a>.</p><p>我们推荐在持续集成(CI)流程中加入对代码类型检查的步骤.</p></div></div></div><div id="outline-container-org3ca70c9" class="outline-2"><h2 id="org3ca70c9"><span class="section-number-2">3.</span> 语言规范</h2><div class="outline-text-2" id="text-3"></div><div id="outline-container-orgd6f2239" class="outline-3"><h3 id="orgd6f2239"><span class="section-number-3">3.1.</span> 导入</h3><div class="outline-text-3" id="text-3-1"><pre class="example">仅对包和模板使用导入</pre><p>使用一致的方式来表明对象的来源, x.Obj 表示 Obj 对象定义在模块 x 中.</p><p>使用 <code>import x</code> 来导入包和模块.</p><p>使用 <code>from x import y</code> , 其中 x 是包前缀, y 是不带前缀的模块名.</p><p>使用 <code>from x import y as z</code>, 如果两个要导入的模块都叫做 y 或者 y 太长了.</p><p>例如, 模块 <code>sound.effects.echo</code> 可以用如下方式导入后, 使用 EchoFilter</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sound.effects <span class="keyword">import</span> echo</span><br><span class="line">...</span><br><span class="line">echo.EchoFilter(input, output, delay=<span class="number">0.7</span>, atten=<span class="number">4</span>)</span><br></pre></td></tr></table></figure></div><p>不使用直接 import 模板内成员的做法. 如:</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sound.effects.echo <span class="keyword">import</span> EchoFilter</span><br><span class="line">...</span><br><span class="line">EchoFilter(input, output, delay=<span class="number">0.7</span>, atten=<span class="number">4</span>)</span><br></pre></td></tr></table></figure></div></div><div id="outline-container-org3246861" class="outline-4"><h4 id="org3246861"><span class="section-number-4">3.1.1.</span> 例外</h4><div class="outline-text-4" id="text-3-1-1"><p>在使用 <code>typing</code> 模块时, 不需要遵守这条规则</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Any, List, Dict</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-org58fe324" class="outline-3"><h3 id="org58fe324"><span class="section-number-3">3.2.</span> 包</h3><div class="outline-text-3" id="text-3-2"><pre class="example">使用模块的全路径名来导入每个模块</pre><p>使用绝对导入(absolute import), 不使用相对导入(relative import), 即使模块在相同的文件夹中.</p><p>避免包名冲突, 或者由于路径的问题导入错误的包. 更容易定位到模块.</p><p>使用相对导入依赖于文件之间的相对位置, 在大型项目中不同的包内也许有同名的模块, 这可能会在代码重构移动文件时带来潜在的问题.</p></div></div><div id="outline-container-org7de52e2" class="outline-3"><h3 id="org7de52e2"><span class="section-number-3">3.3.</span> 类</h3><div class="outline-text-3" id="text-3-3"><pre class="example">类没有必要继承 object, 除非你需要考虑兼容 Python 2</pre><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div><p>NO</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># only for pyton2 compatibility</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div><pre class="example">在 __init__ 方法中定义所有的实例变量</pre><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, side)</span>:</span></span><br><span class="line">        self._side = side</span><br><span class="line">        self.area = side ** <span class="number">2</span></span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, side)</span>:</span></span><br><span class="line">        self._side = side</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 在 __init__ 之外定义了实例变量 self.area</span></span><br><span class="line">        self.area = self._side ** <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> self.area</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgfb89587" class="outline-3"><h3 id="orgfb89587"><span class="section-number-3">3.4.</span> 异常</h3><div class="outline-text-3" id="text-3-4"><p>谨慎地使用异常</p></div><div id="outline-container-orgf390a05" class="outline-4"><h4 id="orgf390a05"><span class="section-number-4">3.4.1.</span> 自定义异常</h4><div class="outline-text-4" id="text-3-4-1"><pre class="example">自定义异常类名以 Error 结尾, 继承 Exception</pre><p>模块可以定义自己的异常类, 必须继承已经存在的异常类, 名字必须以 Error 结尾.</p><p>大多数情况下如果没有特殊的处理要求, 类的 body 简单地使用 pass 即可.</p><pre class="example">class MyError(Exception):    pass</pre></div></div><div id="outline-container-orgd708034" class="outline-4"><h4 id="orgd708034"><span class="section-number-4">3.4.2.</span> 异常抛出的形式</h4><div class="outline-text-4" id="text-3-4-2"><pre class="example">使用抛出异常实例的形式</pre><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">raise</span> MyError()</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> MyError(<span class="string">"Error Message"</span>)</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">raise</span> MyError</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org044ffd1" class="outline-4"><h4 id="org044ffd1"><span class="section-number-4">3.4.3.</span> 注意异常捕获的范围</h4><div class="outline-text-4" id="text-3-4-3"><pre class="example">不要使用 except: 捕获所有异常</pre><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">   ...</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div><p>除非:</p><ul class="org-ul"><li>你会再次抛出异常</li><li>你明确地知道你不会再次抛出异常, 你会在这里正确地处理这个异常.比如在 thread 内记录下错误并阻止这个异常向上传递后引起 thread 退出</li></ul><p>在异常这方面, Python 非常宽容, <code>except:</code> 会捕获包括 Python 语法错误在内的任何错误. 使用 <code>except:</code> 很容易隐藏真正的 bug</p></div></div><div id="outline-container-org7257321" class="outline-4"><h4 id="org7257321"><span class="section-number-4">3.4.4.</span> 尽量减少 try except 语法块内代码的数量</h4><div class="outline-text-4" id="text-3-4-4"><p>try except 语法块内代码的数量越多, 在你预期之外的代码抛出异常的机会就会越大, 在这种情况下 try except会将真正有可能出错的代码隐藏起来.</p></div></div><div id="outline-container-org50cc356" class="outline-4"><h4 id="org50cc356"><span class="section-number-4">3.4.5.</span> 使用 try except else finally 结构</h4><div class="outline-text-4" id="text-3-4-5"><p>使用完整的 try/except/else/finally 结构, 会让代码逻辑变得更清晰</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 可能的异常抛出点</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">except</span> MyError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理异常情况</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 正常情况</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 无论正常或者异常情况下都需要运行的代码</span></span><br><span class="line">    <span class="comment"># 比如说释放资源</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgf424303" class="outline-4"><h4 id="orgf424303"><span class="section-number-4">3.4.6.</span> assert</h4><div class="outline-text-4" id="text-3-4-6"><pre class="example">assert 只用于确保代码内部的正确性, 不能用于确保调用是正确的或者有异常发生</pre><p>不要使用 assert 来进行参数校验, 合适的情况下使用 build-in 的异常.</p><p>assert 不能代替异常, 如果后继需要检查出错的情况, 使用异常而不是 assert.</p><p>而且 assert 语句在运行时可能会被关闭, 比如 <code>python -O</code>解析器会忽略所有 assert 语句以提高性能.</p><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect_to_next_port</span><span class="params">(self, minimum)</span>:</span></span><br><span class="line">  <span class="string">"""Connects to the next available port.</span><br><span class="line"></span><br><span class="line">  Args:</span><br><span class="line">    minimum: A port value greater or equal to 1024.</span><br><span class="line"></span><br><span class="line">  Returns:</span><br><span class="line">    The new minimum port.</span><br><span class="line"></span><br><span class="line">  Raises:</span><br><span class="line">    ConnectionError: If no available port is found.</span><br><span class="line">  """</span></span><br><span class="line">  <span class="keyword">if</span> minimum < <span class="number">1024</span>:</span><br><span class="line">    <span class="comment"># Note that this raising of ValueError is not mentioned in the doc</span></span><br><span class="line">    <span class="comment"># string's "Raises:" section because it is not appropriate to</span></span><br><span class="line">    <span class="comment"># guarantee this specific behavioral reaction to API misuse.</span></span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">'Minimum port must be at least 1024, not %d.'</span> % (minimum,))</span><br><span class="line">  port = self._find_next_open_port(minimum)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> port:</span><br><span class="line">    <span class="keyword">raise</span> ConnectionError(<span class="string">'Could not connect to service on %d or higher.'</span> % (minimum,))</span><br><span class="line">  <span class="keyword">assert</span> port >= minimum, <span class="string">'Unexpected port %d when minimum was %d.'</span> % (port, minimum)</span><br><span class="line">  <span class="keyword">return</span> port</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect_to_next_port</span><span class="params">(self, minimum)</span>:</span></span><br><span class="line">  <span class="string">"""Connects to the next available port.</span><br><span class="line"></span><br><span class="line">  Args:</span><br><span class="line">    minimum: A port value greater or equal to 1024.</span><br><span class="line"></span><br><span class="line">  Returns:</span><br><span class="line">    The new minimum port.</span><br><span class="line">  """</span></span><br><span class="line">  <span class="keyword">assert</span> minimum >= <span class="number">1024</span>, <span class="string">'Minimum port must be at least 1024.'</span></span><br><span class="line">  port = self._find_next_open_port(minimum)</span><br><span class="line">  <span class="keyword">assert</span> port <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line">  <span class="keyword">return</span> port</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-orgf39f83d" class="outline-3"><h3 id="orgf39f83d"><span class="section-number-3">3.5.</span> 全局变量</h3><div class="outline-text-3" id="text-3-5"><pre class="example">尽量避免使用全局变量</pre><p>尽量避免使用全局变量, 全局变量的生命周期是永久的,只有在程序退出时占用的内存才会被清除.</p><p>使用类变量来代替, 但也有一些例外情况.</p><ul class="org-ul"><li>脚本的默认选项</li><li>模块级的常量. 例如 PI = 3.14.159, 常量应用使用全大写,使用下划线连接单词.</li><li>有时候用全局变量来缓存值或者作为函数返回值很有用.</li><li>如果有需要, 全局变量应该仅在模块内部使用, (命名使用下划线开头 <code>_XXX</code>), 外部模块通过该模块的公 共方法来访问全局变量.</li></ul></div></div><div id="outline-container-org790671a" class="outline-3"><h3 id="org790671a"><span class="section-number-3">3.6.</span> 列表表达式 (list compreshensions)</h3><div class="outline-text-3" id="text-3-6"><pre class="example">适用于简单的情况, 禁止在列表表达式中使用多重 for 循环或者多重过滤</pre><p>列表表达式以及生成器表达式(generator expressions)提供了一种简洁的方式来创建列表和生成器, 而不必使用<code>map</code> <code>filter</code> 或者 <code>lambda</code> <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>.</p><p>创建简单的过滤器表示式以及映射表达式, 使用列表表达式, 原则是表达式的内容不过度复杂.</p><p>复杂的逻辑请使用 for 循环.</p><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">evens = [str(x) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">100</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">result = ((x, complicated_transform(x))</span><br><span class="line">          <span class="keyword">for</span> x <span class="keyword">in</span> some_function(paramter)</span><br><span class="line">          <span class="keyword">if</span> x <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>)</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">evens = list(map(str, filter(<span class="keyword">lambda</span> x: x% <span class="number">2</span> == <span class="number">0</span>, range(<span class="number">0</span>, <span class="number">100</span>))))</span><br><span class="line"></span><br><span class="line">result = ((x, y, z) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>) <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">5</span>) <span class="keyword">if</span> x != y <span class="keyword">for</span> z <span class="keyword">in</span> range(<span class="number">5</span>) <span class="keyword">if</span> y != z)</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org2b2fe2f" class="outline-3"><h3 id="org2b2fe2f"><span class="section-number-3">3.7.</span> 默认迭代器和操作符</h3><div class="outline-text-3" id="text-3-7"><pre class="example">如果类型支持, 就使用默认迭代器和操作符. 比如列表, 字典及文件等.</pre><p>容器类型, 像字典和列表, 定义了默认的迭代器和关系测试操作符(in 和 not in).</p><p>如果可能的话使用默认的迭代器和操作符, 大多数 build-in 类型定义了迭代器方法.</p><p>需要注意的一点是, 这样去遍历容器的话, 不能在遍历时修改容器.</p><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> adict: ...</span><br><span class="line"><span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> adict: ...</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> adict.items(): ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> obj <span class="keyword">in</span> alist: ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> afile: ...</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> adict.keys(): ...</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> adict.hash_key(key): ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> afile.readlines(): ...</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org49f7f05" class="outline-3"><h3 id="org49f7f05"><span class="section-number-3">3.8.</span> lambda 表达式</h3><div class="outline-text-3" id="text-3-8"><pre class="example">lambda 方法体为一行表达式的情况下可以使用</pre><p>例: <code>sorted(data, key=lambda x: x.key)</code></p><p>当方法体比一行表达式复杂应该使用=def=定义的函数, 通常可以将这些帮助函数定义在需要使用 <code>lambda</code> 的函数内, 作为嵌套函数.</p><p>示例</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort_data</span><span class="params">(data)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">get_key</span><span class="params">(item)</span>:</span></span><br><span class="line">       <span class="comment"># some logic to extract key from item</span></span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">   sorted(data, key=get_key)</span><br></pre></td></tr></table></figure></div><p>标准库的=operator=有一些常用的函数, 优先考虑使用. 如可以用 <code>operator.mul</code> 来代替 <code>lambda x, y: x * y</code>.</p></div></div><div id="outline-container-org7c2be79" class="outline-3"><h3 id="org7c2be79"><span class="section-number-3">3.9.</span> 条件表达式</h3><div class="outline-text-3" id="text-3-9"><pre class="example">简单的情况下适用, 复杂情况或多重条件判断时使用完整的 if else 语句.</pre><p>条件表达式类于 C/Java 里的三元操作符, 可以用来简化简单的 if 语句.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> cond:</span><br><span class="line">    x = <span class="number">2</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    x = <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简化为</span></span><br><span class="line"><span class="keyword">return</span> x = <span class="number">2</span> <span class="keyword">if</span> cond <span class="keyword">else</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></div><p>当 if 判断条件太复杂或者有多重判断的情况使用条件表达式会破坏可读性</p><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bad_example = <span class="number">1</span> <span class="keyword">if</span> predicate1(value) <span class="keyword">else</span> <span class="number">2</span> <span class="keyword">if</span> predicate2(value) <span class="keyword">else</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org1c4dfd2" class="outline-3"><h3 id="org1c4dfd2"><span class="section-number-3">3.10.</span> 函数参数默认值</h3><div class="outline-text-3" id="text-3-10"><pre class="example">禁止使用可变对象作为函数参数的默认值</pre><p>函数参数的默认值为可变对象,比 <code>[]</code>, 函数如果修改了该变量, 会影响默认值的值.</p><p>我们视这种用法是一种会引起潜在问题的错误用法.</p><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(a, b=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> b <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        b = []</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(a, b=[])</span>:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div><p>示例:</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(a=[])</span>:</span></span><br><span class="line">    a.append(<span class="number">1</span>)</span><br><span class="line">    print(a)</span><br><span class="line"></span><br><span class="line">foo()  <span class="comment"># 输出 1</span></span><br><span class="line">foo()  <span class="comment"># 输出 1 1</span></span><br><span class="line">foo()  <span class="comment"># 输出 1 1 1</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org797804c" class="outline-3"><h3 id="org797804c"><span class="section-number-3">3.11.</span> True/False 求值</h3><div class="outline-text-3" id="text-3-11"><pre class="example">在可能的情况下使用隐式的 False 值</pre><p>在 Python 语言中以下的值在被作为布尔值使用时候, 会被认为是 False.</p><p>内建类型的"空值":</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>, <span class="keyword">None</span>, [], {}, <span class="string">''</span></span><br></pre></td></tr></table></figure></div><p>Python 的惯用法是使用这些隐式的 False 值, 例如 <code>if foo:</code> 而不是 <code>if foo != []:</code>.</p><p>优点是可读性强, 速度更快, 大多数情况下都不会引起问题, 但是需要注意以下几点:</p><ul class="org-ul"><li><code>'0'</code> 字符串 0 是被当作 True 对待.</li><li>永远不要直接比较布尔值, 如 <code>if value == False:</code>, 使用 <code>if not value:</code>.如果需要区分 <code>False</code> 与 <code>None</code> 的情况, 使用类似这样的语句 <code>if not x and x is not None:</code>.</li><li>检查 None 时必须使用 <code>if foo is None:</code> 或者 <code>is not None</code>.当检查某个值是否为 None 时如果使用 <code>if not foo:</code> 不要忘记 foo 如果为其它的"空值"也会通过检查.</li><li>判断 seqences 类型(strings, lists, tuples)是否为空, 使用 <code>if seq:</code> or <code>if not seq</code>, 而不是 <code>if len(seq):</code> or <code>if not len(seq):</code>.</li><li>数字 <code>0</code> 会被当作 False, 在判断是否为数字=0=的时候, 需要直接比较数字 0: <code>if foo == 0:</code></li></ul></div></div><div id="outline-container-org669259f" class="outline-3"><h3 id="org669259f"><span class="section-number-3">3.12.</span> 格式化字符串</h3><div class="outline-text-3" id="text-3-12"><p>在 Python 3 中推荐使用 f-string, 不使用老式的 <code>%</code> 以及 <code>str.format</code> 进行格式化.</p><p>bad</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name = <span class="string">"World!"</span></span><br><span class="line">print(<span class="string">"Hello, %s"</span> % name)</span><br><span class="line">print(<span class="string">"Hello, {}"</span>.format(name))</span><br></pre></td></tr></table></figure></div><p>better</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name = <span class="string">"World!"</span></span><br><span class="line">print(f<span class="string">"Hello, {name}"</span>)</span><br></pre></td></tr></table></figure></div><p><a href="https://realpython.com/python-f-strings/" target="_blank" rel="noopener">f-string tutorial <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div><div id="outline-container-org74c2c59" class="outline-4"><h4 id="org74c2c59"><span class="section-number-4">3.12.1.</span> 例外</h4><div class="outline-text-4" id="text-3-12-1"><p>在使用标准库 logging 进行日志输出时, 仍然推荐使用 <code>%s</code> 的格式化风格,而不是 <code>f-string</code>.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">logger = logging.getLoggerName(__name__)</span><br><span class="line">name = <span class="string">"World!"</span></span><br><span class="line">logger.debug(<span class="string">"Hello, %s"</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># instead of</span></span><br><span class="line"><span class="comment"># logger.debug("Hello, {name}")</span></span><br></pre></td></tr></table></figure></div><p>这是因为包含 <code>%s</code> 的字符串和变量是作为参数传递给 logger 的方法,logging 类库对于 <code>%s</code> 有特殊的优化,以及对于变量的字符串化会推迟到最后 <sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>.</p><p>而直接使用 <code>f-string</code> 作为第一个变量传递给 logger 的方法, 相当于先将变量字符串化然后再传递给 logger的方法.</p></div></div></div></div><div id="outline-container-orge9ccec3" class="outline-2"><h2 id="orge9ccec3"><span class="section-number-2">4.</span> 编程原则与最佳实践</h2><div class="outline-text-2" id="text-4"></div><div id="outline-container-orgbf4a7a6" class="outline-3"><h3 id="orgbf4a7a6"><span class="section-number-3">4.1.</span> 使用 pylint</h3><div class="outline-text-3" id="text-4-1"><pre class="example">使用 pylint</pre><p><a href="https://www.pylint.org/" target="_blank" rel="noopener">pylint 官网 <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p><code>pylint</code> 是一个在 Python 源代码中查找 bug 的工具. 对于 C 和 C++ 这样的强类型静态语言来说, 这些 bug 通常由编译器来捕获.由于 Python 的动态特性, 有些警告可能不对. 不过虚报的情况应该比较少.</p><p>确保对你的代码运行 pylint. 在 CI 流程中加入 pylint 检查的步骤.</p><p>抑制不准确的警告, 以便其他正确的警告可以暴露出来。</p><p>使用 PyCharm 开发的团队可以使用<a href="https://plugins.jetbrains.com/plugin/11084-pylint/reviews" target="_blank" rel="noopener">pylint plugin <i class="fa fa-external-link" aria-hidden="true"></i></a>.</p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-pylint/index.html" target="_blank" rel="noopener">Pylint 的介绍与入门 <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div></div><div id="outline-container-orgfb26bab" class="outline-3"><h3 id="orgfb26bab"><span class="section-number-3">4.2.</span> 自底向上编程</h3><div class="outline-text-3" id="text-4-2"><p>自底向上编程(bottom up): 从最底层,依赖最少的地方开始设计结构及编写代码,再编写调用这些代码的逻辑, 自底向上构造程序.</p><ul class="org-ul"><li>采取自底向上的设计方式会让代码更少以及开发过程更加敏捷.</li><li>自底向上的设计更容易产生符合<a href="https://blog.cleancoder.com/uncle-bob/2014/05/08/SingleReponsibilityPrinciple.html" target="_blank" rel="noopener">单一责任原则(SRP) <i class="fa fa-external-link" aria-hidden="true"></i></a>的代码.</li><li>组件之间的调用关系清晰, 组件更易复用, 更易编写单元测试案例.</li></ul><p>举一个简单的例子: 现需要编写调用外部系统 API 获取数据来完成业务逻辑的代码.</p><p>应该先编写一个独立的模块将调用外部系统 API 获取数据的接口封装在一些函数中,然后再编写如何调用这些函数 来完成业务逻辑. 而不是先写业务逻辑,然后在需要调用外部 API 时再去实现相关代码, 这会产生调用 API 的代码直接耦合在业务逻辑中的代码.</p></div></div><div id="outline-container-org5644270" class="outline-3"><h3 id="org5644270"><span class="section-number-3">4.3.</span> 防御式编程</h3><div class="outline-text-3" id="text-4-3"><pre class="example">使用 assert 语句确保程序处于的正确状态</pre><p>不要过度使用 assert, assert 应该只用于确保核心的部分.</p><p>注意 assert 不能代替运行时的异常, 不要忘记 assert 语句可能会被解析器忽略.</p><p>assert 语句通常可用于以下场景: - 确保公共类或者函数被正确地调用</p><pre class="example">例如一个公共函数可以处理 list 或 dict 类型参数, 在函数开头使用 `assert isinstance(param, (list, dict))`确保函数接受的参数是 list 或 dict</pre><ul class="org-ul"><li>assert 用于确保不变量. 防止需求改变时引起代码行为的改变</li></ul><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> target == x:</span><br><span class="line">    run_x_code()</span><br><span class="line"><span class="keyword">elif</span> target == y:</span><br><span class="line">    run_y_code()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    run_z_code()</span><br></pre></td></tr></table></figure></div><p>假设该代码上线时是正确的, target 只会是 x, y, z 三种情况, 但是稍后如果需求改变了, target 允许 w 的情况出现. 当 target 为 w 时该代码就会错误地调用 run_z_code, 这通常会引起糟糕的后果.</p><p>我们可以使用 assert 来确保不变量</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assert</span> target <span class="keyword">in</span> (x, y, z)</span><br><span class="line"><span class="keyword">if</span> target == x:</span><br><span class="line">    run_x_code()</span><br><span class="line"><span class="keyword">elif</span> target == y:</span><br><span class="line">    run_y_code()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> target == z</span><br><span class="line">    run_z_code()</span><br></pre></td></tr></table></figure></div><p>不要使用 assert 的场景:</p><ul class="org-ul"><li>不要使用 assert 在校验用户输入的数据, 需要校验的情况下应该抛出异常</li><li>不要将 assert 用于允许正常失败的情况, 将 assert 用于检查不允许失败的情况.</li><li>用户不应该直接看到 <code>AssertionError</code>, 如果用户可以看到, 将这种情况视为一个 BUG</li></ul></div></div><div id="outline-container-org351475a" class="outline-3"><h3 id="org351475a"><span class="section-number-3">4.4.</span> 避免使用 magic number</h3><div class="outline-text-3" id="text-4-4"><p>赋予特殊的常量一个名字, 避免重复地直接使用它们的字面值.合适的时候使用枚举值 <code>Enum</code>.</p><p>使用常量在重构时只需要修改一个地方,如果直接使用字面值在重构时将修改所有使用到的地方.</p><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_potential_energy</span><span class="params">(mass, height)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> mass * height * <span class="number">9.81</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django ORM</span></span><br><span class="line">Config.objects.filter(enabled=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">GRAVITATIONAL_CONSTANT = <span class="number">9.81</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_potential_energy</span><span class="params">(mass, height)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> mass * height * GRAVITATIONAL_CONSTANT</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfigStatus</span>:</span></span><br><span class="line">    ENABLED = <span class="number">1</span></span><br><span class="line">    DISABLED = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Config.objects.filter(enabled=ConfigStatus.ENABLED)</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org897eabf" class="outline-3"><h3 id="org897eabf"><span class="section-number-3">4.5.</span> 处理字典 key 不存在时的默认值</h3><div class="outline-text-3" id="text-4-5"><pre class="example">使用 dict.setdefault 或者 defaultdict</pre><p>例子</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># group words by frequency</span></span><br><span class="line">words = [(<span class="number">1</span>, <span class="string">'apple'</span>), (<span class="number">2</span>, <span class="string">'banana'</span>), (<span class="number">1</span>, <span class="string">'cat'</span>)]</span><br><span class="line">frequency = {}</span><br></pre></td></tr></table></figure></div><p>No</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    <span class="keyword">if</span> freq <span class="keyword">not</span> <span class="keyword">in</span> frequency:</span><br><span class="line">        frequency[freq] = []</span><br><span class="line">    frequency[freq].append(word)</span><br></pre></td></tr></table></figure></div><p>Yes</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    frequency.setdefault(freq, []).append(word)</span><br></pre></td></tr></table></figure></div><p>或者使用 <a href="https://docs.python.org/2/library/collections.html#collections.defaultdict" target="_blank" rel="noopener">defaultdict <i class="fa fa-external-link" aria-hidden="true"></i></a></p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">frequency = defaultdict(list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    frequency[freq].append(word)</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-org0008a04" class="outline-2"><h2 id="org0008a04"><span class="section-number-2">5.</span> References</h2><div class="outline-text-2" id="text-5"><ul class="org-ul"><li><a href="https://google.github.io/styleguide/pyguide.html" target="_blank" rel="noopener">Google Python Style Guide <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://github.com/emre/notes/blob/master/python/when-to-use-assert.md" target="_blank" rel="noopener">When to Use Assert <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="http://www.paulgraham.com/progbot.html" target="_blank" rel="noopener">Bottom up programming <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://refactoring.guru/refactoring/catalog" target="_blank" rel="noopener">Refactoring <i class="fa fa-external-link" aria-hidden="true"></i></a></li></ul></div></div><div id="footnotes"><h2 class="footnotes">Footnotes: </h2><div id="text-footnotes"><div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">mypy 的开发直接影响了 PEP484 的诞生, 而且有非常成功的使用案例, 例如 <a href="https://blogs.dropbox.com/tech/2019/09/our-journey-to-type-checking-4-million-lines-of-python/" target="_blank" rel="noopener">dropbox 如何对 4 百万行 Python 代码进行类型检查 <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div></div><div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">注意在 Python 3 中 map filter 返回的是生成器而不是列表, 在隋性计算方面有所区别.</p></div></div><div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara"><a href="https://docs.python.org/3/howto/logging.html#optimization" target="_blank" rel="noopener">logging optimization <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python 动态创建模块</title>
    <link href="http://mpwang.github.io/2019/02/23/python-dynamic-module-creation/"/>
    <id>http://mpwang.github.io/2019/02/23/python-dynamic-module-creation/</id>
    <published>2019-02-23T07:10:57.000Z</published>
    <updated>2019-10-20T15:34:57.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-org60dcdd2">1. 使用 types.ModuleType</a></li><li class="tab"><a class="btn" href="#tab-org3ce8abb">2. import 模块</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-org60dcdd2"><ul><a href="#org60dcdd2">1. 使用 types.ModuleType</a></ul></div><div class="tab-pane" id="tab-org3ce8abb"><ul><a href="#org3ce8abb">2. import 模块</a></ul></div></div></div><div id="outline-container-org60dcdd2" class="outline-2"><h2 id="org60dcdd2"><span class="section-number-2">1.</span> 使用 types.ModuleType</h2><div class="outline-text-2" id="text-1"><p>几乎 Python 中所有的东西都是对象, Python 标准库 <a href="https://docs.python.org/dev/library/types.html" target="_blank" rel="noopener">types <i class="fa fa-external-link" aria-hidden="true"></i></a> 提供了 build-in 对象的类型. 我们需要 <code>types.ModuleType</code> 来动态创建 module.</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">import typeshello = types.ModuleType("hello")</span><br></pre></td></tr></table></figure></div><p>现在我们创建了一个空白的模块, 现在我们可以创建一个函数并将函数加入到 hello 模块中.</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">def say_hello():    print("hello")setattr(hello, "say_hello", say_hello)</span><br></pre></td></tr></table></figure></div><p>现在可以通过 <code>hello.say_hello</code> 来调用 <code>say_hello</code></p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">hello.say_hello()</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org3ce8abb" class="outline-2"><h2 id="org3ce8abb"><span class="section-number-2">2.</span> import 模块</h2><div class="outline-text-2" id="text-2"><p>以上动态创建的模块 hello, 并不能通过 <code>import hello</code> 的方式使用.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hello</span><br></pre></td></tr></table></figure></div><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">ModuleNotFoundErrorTraceback (most recent call last)</span><br><span class="line"><ipython-input-2-f81fb083bdeb> in <module></module></ipython-input-2-f81fb083bdeb></span><br><span class="line">----> 1 import hello</span><br><span class="line"></span><br><span class="line">ModuleNotFoundError: No module named 'hello'</span><br></pre></td></tr></table></figure></div><p>Python 的 import 机制很简明, <code>sys.modules</code> 在其中是关键点.</p><p>当我们使用 <code>import hello</code> 的时候, Python 解析器会在 <code>sys.modules</code> 字典中查找 key 为 'hello' 的值.如果 key 存在, 返回已经被初始化的模块.</p><p>如果 key 不存在的话, Python 解析器会遍历 <a href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH" target="_blank" rel="noopener">PYTHONPATH <i class="fa fa-external-link" aria-hidden="true"></i></a> 中的文件系统, 寻找名字为 hello 的文件或者模块,如果找到的话初始化 hello 并注册到 sys.modules 中, 否则抛出 <code>ImportError</code> 异常.</p></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>如何使用 Org 文档写 Hexo 博客</title>
    <link href="http://mpwang.github.io/2019/02/13/how-to-write-hexo-blog-with-org-mode/"/>
    <id>http://mpwang.github.io/2019/02/13/how-to-write-hexo-blog-with-org-mode/</id>
    <published>2019-02-13T14:39:15.000Z</published>
    <updated>2019-02-13T16:43:33.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orgcfce239">1. Hexo 与 Org-mode</a></li><li class="tab"><a class="btn" href="#tab-orgafff4fb">2. hexo-renderer-org</a></li><li class="tab"><a class="btn" href="#tab-org64e951a">3. 配合使用 Hexo 的文章资源文件夹</a></li><li class="tab"><a class="btn" href="#tab-orgc26a402">4. 配合 Hexo 主题: NexT</a></li><li class="tab"><a class="btn" href="#tab-org99d99fd">5. 技巧</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orgcfce239"><ul><a href="#orgcfce239">1. Hexo 与 Org-mode</a></ul></div><div class="tab-pane" id="tab-orgafff4fb"><ul><a href="#orgafff4fb">2. hexo-renderer-org</a><li><a href="#org1d9399b">2.1. 安装</a></li><li><a href="#org6ea8c0b">2.2. 工作原理</a></li><li><a href="#org9fe38e4">2.3. emacs 的配置</a></li><li><a href="#org65275b6">2.4. hexo 的配置</a></li><li><a href="#org9e7a404">2.4.1. 不要使用 emacs htmlize 功能</a></li><li><a href="#org9713123">2.5. Enjoy</a></li></ul></div><div class="tab-pane" id="tab-org64e951a"><ul><a href="#org64e951a">3. 配合使用 Hexo 的文章资源文件夹</a></ul></div><div class="tab-pane" id="tab-orgc26a402"><ul><a href="#orgc26a402">4. 配合 Hexo 主题: NexT</a></ul></div><div class="tab-pane" id="tab-org99d99fd"><ul><a href="#org99d99fd">5. 技巧</a></ul></div></div></div><div id="outline-container-orgcfce239" class="outline-2"><h2 id="orgcfce239"><span class="section-number-2">1.</span> Hexo 与 Org-mode</h2><div class="outline-text-2" id="text-1"><p><a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">Hexo <i class="fa fa-external-link" aria-hidden="true"></i></a> 是一个快速、简洁且高效的用于生成静态网页的博客框架, 生成的网页可以方便地托管到 <a href="https://pages.github.com/" target="_blank" rel="noopener">Github Pages <i class="fa fa-external-link" aria-hidden="true"></i></a>, 可以快速方便地创建个人博客.</p><p>Hexo 默认使用<a href="http://daringfireball.net/projects/markdown/" target="_blank" rel="noopener"> Markdown <i class="fa fa-external-link" aria-hidden="true"></i></a> 格式解析文章, 本文介绍如何使用 <a href="https://orgmode.org/" target="_blank" rel="noopener">org <i class="fa fa-external-link" aria-hidden="true"></i></a> 文档生成 Hexo 博客文章.</p></div></div><div id="outline-container-orgafff4fb" class="outline-2"><h2 id="orgafff4fb"><span class="section-number-2">2.</span> hexo-renderer-org</h2><div class="outline-text-2" id="text-2"><p>hexo-renderer-org 是 hexo 的一个插件, 用于将 org 文档生成 hexo 的博客文章. Hexo 解析 Markdown 文档的能力保持不变, 相当于给 Hexo 加上org 文档的支持.</p><p>使用我维护的 <a href="https://github.com/mpwang/hexo-renderer-org" target="_blank" rel="noopener">hexo-renderer-org <i class="fa fa-external-link" aria-hidden="true"></i></a> 项目<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>.</p></div><div id="outline-container-org1d9399b" class="outline-3"><h3 id="org1d9399b"><span class="section-number-3">2.1.</span> 安装</h3><div class="outline-text-3" id="text-2-1"><p>在 Hexo 博客文件夹下安装 hexo-renderer-org</p><div class="org-src-container"><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install https://github.com/mpwang/hexo-renderer-org<span class="comment">#master --save</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org6ea8c0b" class="outline-3"><h3 id="org6ea8c0b"><span class="section-number-3">2.2.</span> 工作原理</h3><div class="outline-text-3" id="text-2-2"><p>安装了 hexo-renderer-org 之后, hexo 命令会使用 emacsclient 去连接 emacs server, 使用 org export 功能将 org 文档转换成 html, 所以要求 emacs 开启 server 进程.</p></div></div><div id="outline-container-org9fe38e4" class="outline-3"><h3 id="org9fe38e4"><span class="section-number-3">2.3.</span> emacs 的配置</h3><div class="outline-text-3" id="text-2-3"><p><div class="note warning">            <p>spacemacs 用户配置</p>          </div></p><p>启用 emacs server 进程以及设置 emacs server socket 文件所在的文件夹.</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; If non-nil, start an Emacs server if one is not already running.</span></span><br><span class="line"><span class="comment">;; (default nil)</span></span><br><span class="line">dotspacemacs-enable-server <span class="literal">t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;; Set the emacs server socket location.</span></span><br><span class="line"><span class="comment">;; If nil, uses whatever the Emacs default is, otherwise a directory path</span></span><br><span class="line"><span class="comment">;; like \"~/.emacs.d/server\". It has no effect if</span></span><br><span class="line"><span class="comment">;; `dotspacemacs-enable-server' is nil.</span></span><br><span class="line"><span class="comment">;; (default nil)</span></span><br><span class="line">dotspacemacs-server-socket-dir <span class="string">"~/.emacs.d/server"</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org65275b6" class="outline-3"><h3 id="org65275b6"><span class="section-number-3">2.4.</span> hexo 的配置</h3><div class="outline-text-3" id="text-2-4"><p>在 hexo 博客的配置文件 <code>_config.yml</code> 中添加</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">org:  # 指定 emacs 执行文件路径  emacs: '/usr/local/bin/emacs'  # 指定 emacsclient 执行文件路径  emacsclient: '/usr/local/bin/emacsclient'  # 是否生成自动注脚, t 为开启, nil 为关闭  common: |    #+OPTIONS: html-postamble:nil  clean_cache: true  daemonize: true  # emacs server file 路径, 如果不指定, 以下为默认值  server_file: "~/.emacs.d/server/server"</span><br></pre></td></tr></table></figure></div></div><div id="outline-container-org9e7a404" class="outline-4"><h4 id="org9e7a404"><span class="section-number-4">2.4.1.</span> 不要使用 emacs htmlize 功能</h4><div class="outline-text-4" id="text-2-4-1"><p>README 文档里的 htmlize 功能我没有成功过, 设置 <code>htmlize: true</code> 之后生成的内容会出错. 不过这个问题影响不大, 代码高亮交给 <code>highlight.js</code> 去处理.</p></div></div></div><div id="outline-container-org9713123" class="outline-3"><h3 id="org9713123"><span class="section-number-3">2.5.</span> Enjoy</h3><div class="outline-text-3" id="text-2-5"><p>现在在开启 emacs 的情况下, 执行以下命令即可以享受用强大的 org-mode 写文档, 并生成 Hexo 博客.</p><div class="org-src-container"><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean && hexo generate && hexo server --debug</span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-org64e951a" class="outline-2"><h2 id="org64e951a"><span class="section-number-2">3.</span> 配合使用 Hexo 的文章资源文件夹</h2><div class="outline-text-2" id="text-3"><p>Hexo3 加入了<a href="https://hexo.io/zh-cn/docs/asset-folders.html" target="_blank" rel="noopener">文章资源文件夹 <i class="fa fa-external-link" aria-hidden="true"></i></a>的支持, 文章相关的图片可以放在文章同名文件夹里面, 并使用以下代码引用图片</p><pre class="example">{% asset_img slug [title] %}</pre><p></p><p>而在 org 文档中配合 org-download, 我们还可以实现更强大的功能. 在 Hexo 博客文件夹中创建 <code>.dir-local.el</code>, 添加以下代码</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="list">(<span class="keyword">nil</span> .</span><br><span class="line">   <span class="list">(<span class="list">(<span class="keyword">eval</span> .</span><br><span class="line">          <span class="list">(<span class="keyword">progn</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">;; make drag-and-drop image save in the same name folder as org file</span></span><br><span class="line">            <span class="comment">;; ex: `aa-bb-cc.org' then save image test.png to `aa-bb-cc/test.png'</span></span><br><span class="line">            <span class="list">(<span class="keyword">defun</span> my-org-download-method <span class="list">(<span class="keyword">link</span>)</span></span><br><span class="line">              <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">filename</span></span><br><span class="line">                     <span class="list">(<span class="keyword">file-name-nondirectory</span></span><br><span class="line">                      <span class="list">(<span class="keyword">car</span> <span class="list">(<span class="keyword">url-path-and-query</span></span><br><span class="line">                            <span class="list">(<span class="keyword">url-generic-parse-url</span> link)</span>)</span>)</span>)</span>)</span></span><br><span class="line">                    <span class="list">(<span class="keyword">dirname</span> <span class="list">(<span class="keyword">file-name-sans-extension</span> buffer-file-name )</span> )</span>)</span></span><br><span class="line">                <span class="comment">;; if directory not exist, create it</span></span><br><span class="line">                <span class="list">(<span class="keyword">unless</span> <span class="list">(<span class="keyword">file-exists-p</span> dirname)</span></span><br><span class="line">                  <span class="list">(<span class="keyword">make-directory</span> dirname)</span>)</span></span><br><span class="line">                <span class="comment">;; return the path to save the download files</span></span><br><span class="line">                <span class="list">(<span class="keyword">expand-file-name</span> filename dirname)</span>)</span>)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">;; only modify `org-download-method' in this project</span></span><br><span class="line">            <span class="list">(<span class="keyword">setq-local</span> org-download-method <span class="quoted">'my-org-download-method</span>)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">            <span class="comment">;; for using hexo config post_asset_folder: true             ;;</span></span><br><span class="line">            <span class="comment">;; https://hexo.io/docs/asset-folders.html#Post-Asset-Folder ;;</span></span><br><span class="line">            <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">;; only modify `org-download-link-format' in this project</span></span><br><span class="line">            <span class="list">(<span class="keyword">setq-local</span> org-download-link-format <span class="string">"{%% asset_img %s %%}"</span>)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">;; only modify `org-download-abbreviate-filename-function' in</span></span><br><span class="line">            <span class="comment">;; this project</span></span><br><span class="line">            <span class="list">(<span class="keyword">setq-local</span> org-download-abbreviate-filename-function <span class="quoted">#'file-name-nondirectory</span>)</span></span><br><span class="line">            )</span>)</span>)</span>)</span>)</span></span><br></pre></td></tr></table></figure></div><p>现在你可以将图片支持拖拽到 org 文档中, emacs 会自动创建文章同名文件夹并异步下载图片, 在光标所在处自动插入对应的引用代码.</p><p>使用本功能必须配置 org 文档导出时忽略 <code>_</code> 字符的处理, 否则处理 <code>asset_img</code> 时会引起报错.</p><div class="org-src-container"><label class="org-src-name"><span class="listing-number">Listing 1: </span>emacs 配置中加入 org export 设置</label><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'ox</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="comment">;; disable interpret "_" and "^" for export ;;</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-export-with-sub-superscripts <span class="literal">nil</span>)</span>)</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgc26a402" class="outline-2"><h2 id="orgc26a402"><span class="section-number-2">4.</span> 配合 Hexo 主题: NexT</h2><div class="outline-text-2" id="text-4"><p>本网站采用了漂亮成熟的主题 <a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">NexT <i class="fa fa-external-link" aria-hidden="true"></i></a> 6.0.</p><p>以下是我使用 hexo-renderer-org 配合 NexT 主题的的一些调优.</p><p><div class="note warning">            <p>spacemacs 用户配置</p>          </div></p><p>使用方式: 在 <code>.spacemacs</code> 文件的 <code>dotspacemacs/user-config</code> 中添加</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">load</span> <span class="string">"~/.emacs.d/config-hexo.el"</span>)</span></span><br></pre></td></tr></table></figure></div><p>在 <code>~/.emacs.d/</code> 文件夹中创建 <code>config-hexo.el</code> 添加以下代码</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment">;; customization for using hexo-renderer-org to generate hexo static web pages ;;</span></span><br><span class="line"><span class="comment">;;                                                                             ;;</span></span><br><span class="line"><span class="comment">;; using themes/next https://theme-next.org/                                   ;;</span></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">defun</span> hexo-theme-next/link-add-font-awesome <span class="list">(<span class="keyword">text</span> backend info)</span></span><br><span class="line">  <span class="string">"Add fa-external-link class to <a> element."</a></span></span><br><span class="line">  <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">fa-external-element</span> <span class="string">"<i class="fa fa-external-link" aria-hidden="true"></i>"</span>)</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">when</span> <span class="list">(<span class="keyword">and</span> <span class="list">(<span class="keyword">eq</span> backend <span class="quoted">'hexo-html</span>)</span></span><br><span class="line">               <span class="list">(<span class="keyword">not</span> <span class="list">(<span class="keyword">string-match-p</span> fa-external-element text)</span>)</span>)</span></span><br><span class="line">      <span class="list">(<span class="keyword">replace-regexp-in-string</span> <span class="string">""</span> <span class="list">(<span class="keyword">concat</span> <span class="string">" "</span> fa-external-element)</span> text)</span></span><br><span class="line">      )</span>)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">defun</span> hexo-theme-next/center-quote <span class="list">(<span class="keyword">text</span> backend info)</span></span><br><span class="line">  <span class="string">"Transcode a CENTER-BLOCK from org to hexo theme/next centerquote tag plugin."</span></span><br><span class="line">  <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">blockquote-tag-start</span> <span class="string">"<blockquote class="blockquote-center">"</blockquote></span>)</span></span><br><span class="line">        <span class="list">(<span class="keyword">blockqoute-tag-end</span> <span class="string">""</span>)</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">when</span> <span class="list">(<span class="keyword">and</span> <span class="list">(<span class="keyword">eq</span> backend <span class="quoted">'hexo-html</span>)</span></span><br><span class="line">               <span class="list">(<span class="keyword">not</span> <span class="list">(<span class="keyword">string-match-p</span> blockquote-tag-start text)</span>)</span>)</span></span><br><span class="line">      <span class="list">(<span class="keyword">let*</span> <span class="list">(<span class="list">(<span class="keyword">result</span> text)</span></span><br><span class="line">             <span class="list">(<span class="keyword">result</span> <span class="list">(<span class="keyword">replace-regexp-in-string</span> <span class="string">"<div class="\" org-center\""="">"</div></span> blockquote-tag-start result)</span>)</span></span><br><span class="line">             <span class="list">(<span class="keyword">result</span> <span class="list">(<span class="keyword">replace-regexp-in-string</span> <span class="string">"</span></span></span></span></span></span></span></span></span></pre></td></tr></table></figure></div>" blockqoute-tag-end result)))<br><span class="line">        result)</span>)))<br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'ox</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="comment">;; disable interpret "_" and "^" for export ;;</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-export-with-sub-superscripts <span class="literal">nil</span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="list">(<span class="keyword">add-to-list</span> <span class="quoted">'org-export-filter-link-functions</span> <span class="quoted">#'hexo-theme-next/link-add-font-awesome</span>)</span></span><br><span class="line">  <span class="list">(<span class="keyword">add-to-list</span> <span class="quoted">'org-export-filter-center-block-functions</span> <span class="quoted">#'hexo-theme-next/center-quote</span>)</span></span><br><span class="line">  )</span></span><br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'ox-html</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="comment">;; todo keyword use theme/next label CSS class ;;</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-html-todo-kwd-class-prefix <span class="string">"label warning "</span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-html-postamble-format</span><br><span class="line">        <span class="quoted">'((<span class="string">"en"</span></span><br><span class="line">           <span class="string">"<p style="font-size: .7em; font-style: italic">Generated using %c</p>"</span>)</span><br><span class="line">          )</span>)</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="comment">;; generate TOC using hexo theme/next tabs plugin at the top of article ;;</span></span><br><span class="line">  <span class="comment">;;                                                                      ;;</span></span><br><span class="line">  <span class="comment">;; redefine org-html-toc                                                ;;</span></span><br><span class="line">  <span class="comment">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line">  <span class="list">(<span class="keyword">defun</span> org-html-toc <span class="list">(<span class="keyword">depth</span> info <span class="keyword">&optional</span> scope)</span></span><br><span class="line">    <span class="string">"Build a table of contents.</span><br><span class="line">DEPTH is an integer specifying the depth of the table.  INFO is</span><br><span class="line">a plist used as a communication channel.  Optional argument SCOPE</span><br><span class="line">is an element defining the scope of the table.  Return the table</span><br><span class="line">of contents as a string, or nil if it is empty."</span></span><br><span class="line">    <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">toc-entries</span></span><br><span class="line">           <span class="list">(<span class="keyword">mapcar</span> <span class="list">(<span class="keyword">lambda</span> <span class="list">(<span class="keyword">headline</span>)</span></span><br><span class="line">                     <span class="list">(<span class="keyword">cons</span> <span class="list">(<span class="keyword">org-html--format-toc-headline</span> headline info)</span></span><br><span class="line">                           <span class="list">(<span class="keyword">org-export-get-relative-level</span> headline info)</span>)</span>)</span></span><br><span class="line">                   <span class="list">(<span class="keyword">org-export-collect-headlines</span> info depth scope)</span>)</span>)</span>)</span></span><br><span class="line">      <span class="list">(<span class="keyword">when</span> toc-entries</span><br><span class="line">        <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">toc</span> <span class="list">(<span class="keyword">concat</span> <span class="string">"<ul class="\" nav-tabs\""="">\n"</ul></span></span><br><span class="line">                           <span class="list">(<span class="keyword">hexo-theme-next/toc-nav-tabs</span> toc-entries)</span></span><br><span class="line">                           <span class="string">""</span></span><br><span class="line">                           <span class="string">"<div class="\" tab-content\""="">\n"</div></span></span><br><span class="line">                           <span class="list">(<span class="keyword">hexo-theme-next/toc-text</span> toc-entries)</span></span><br><span class="line">                           <span class="string">"</span></span></span></span></span></span></span></span></span></span></div>\n"<br><span class="line">                           )</span>))<br><span class="line">          <span class="list">(<span class="keyword">if</span> scope toc</span><br><span class="line">            <span class="list">(<span class="keyword">concat</span>  <span class="string">"<div class="\" tabs\""="" id="\" org-toc\""="" style="\" font-size:"="" 12px;\"="">\n"</div></span></span><br><span class="line">                     toc</span><br><span class="line">                     <span class="string">"</span></span></span></span></div>\n" ))<br><span class="line">          )</span>)))<br><span class="line"></span><br><span class="line">  <span class="list">(<span class="keyword">defun</span> hexo-theme-next/get-href <span class="list">(<span class="keyword">headline</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">if</span> <span class="list">(<span class="keyword">string-match</span> <span class="string">"href=\"#\\(.*\\)\""</span> headline)</span></span><br><span class="line">        <span class="list">(<span class="keyword">match-string-no-properties</span> <span class="number">1</span> headline)</span></span><br><span class="line">      <span class="string">""</span>)</span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="list">(<span class="keyword">defun</span> hexo-theme-next/toc-nav-tabs <span class="list">(<span class="keyword">toc-entries</span>)</span></span><br><span class="line">    <span class="list">(<span class="keyword">mapconcat</span></span><br><span class="line">     <span class="list">(<span class="keyword">lambda</span> <span class="list">(<span class="keyword">entry</span>)</span></span><br><span class="line">       <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">headline</span> <span class="list">(<span class="keyword">car</span> entry)</span>)</span></span><br><span class="line">             <span class="list">(<span class="keyword">level</span> <span class="list">(<span class="keyword">cdr</span> entry)</span>)</span>)</span></span><br><span class="line">         <span class="list">(<span class="keyword">when</span> <span class="list">(<span class="keyword">=</span> level <span class="number">1</span>)</span></span><br><span class="line">           <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">ahref</span> <span class="list">(<span class="keyword">hexo-theme-next/get-href</span> headline)</span>)</span>)</span></span><br><span class="line">             <span class="list">(<span class="keyword">concat</span> <span class="string">"<li class="\" tab\""="">\n"</li></span></span><br><span class="line">                     <span class="list">(<span class="keyword">replace-regexp-in-string</span></span><br><span class="line">                      <span class="string">"<a href"<="" span=""></a></span><br><span class="line">                      <span class="string">"<a class="\" btn\""="" href"<="" span=""></a></span><br><span class="line">                      <span class="list">(<span class="keyword">replace-regexp-in-string</span> ahref <span class="list">(<span class="keyword">concat</span> <span class="string">"tab-"</span> ahref)</span> headline)</span>)</span></span><br><span class="line">                     <span class="string">"\n"</span>)</span>)</span>)</span>)</span>)</span></span><br><span class="line">     toc-entries <span class="string">""</span>)</span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="list">(<span class="keyword">defun</span> hexo-theme-next/toc-text <span class="list">(<span class="keyword">toc-entries</span>)</span></span><br><span class="line">    <span class="string">"Return innards of a table of contents, as a string.</span><br><span class="line">TOC-ENTRIES is an alist where key is an entry title, as a string,</span><br><span class="line">and value is its relative level, as an integer."</span></span><br><span class="line">    <span class="list">(<span class="keyword">let*</span> <span class="list">(<span class="list">(<span class="keyword">prev-level</span> <span class="list">(<span class="number">1</span>- <span class="list">(<span class="keyword">cdar</span> toc-entries)</span>)</span>)</span></span><br><span class="line">           <span class="list">(<span class="keyword">start-level</span> prev-level)</span>)</span></span><br><span class="line">      <span class="list">(<span class="keyword">concat</span></span><br><span class="line">       <span class="list">(<span class="keyword">mapconcat</span></span><br><span class="line">        <span class="list">(<span class="keyword">lambda</span> <span class="list">(<span class="keyword">entry</span>)</span></span><br><span class="line">          <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">headline</span> <span class="list">(<span class="keyword">car</span> entry)</span>)</span></span><br><span class="line">                <span class="list">(<span class="keyword">level</span> <span class="list">(<span class="keyword">cdr</span> entry)</span>)</span>)</span></span><br><span class="line">            <span class="list">(<span class="keyword">let</span> <span class="list">(<span class="list">(<span class="keyword">ahref</span> <span class="list">(<span class="keyword">hexo-theme-next/get-href</span> headline )</span>)</span>)</span></span><br><span class="line">              <span class="list">(<span class="keyword">concat</span></span><br><span class="line">               <span class="list">(<span class="keyword">let*</span> <span class="list">(<span class="list">(<span class="keyword">cnt</span> <span class="list">(<span class="keyword">-</span> level prev-level)</span>)</span></span><br><span class="line">                      <span class="list">(<span class="keyword">times</span> <span class="list">(<span class="keyword">if</span> <span class="list">(<span class="keyword">></span> cnt <span class="number">0</span>)</span> <span class="list">(<span class="number">1</span>- cnt)</span> <span class="list">(<span class="keyword">-</span> cnt)</span>)</span>)</span>)</span></span><br><span class="line">                 <span class="list">(<span class="keyword">setq</span> prev-level level)</span></span><br><span class="line">                 <span class="list">(<span class="keyword">if</span> <span class="list">(<span class="keyword">></span> cnt <span class="number">0</span>)</span></span><br><span class="line">                     <span class="list">(<span class="keyword">cond</span> <span class="list">(<span class="list">(<span class="keyword">=</span> level <span class="number">1</span>)</span></span><br><span class="line">                            <span class="list">(<span class="keyword">format</span> <span class="string">"<div class="\" tab-pane\""="" id="\" %s\""="">\n<ul>\n"</ul></div></span></span><br><span class="line">                                    <span class="list">(<span class="keyword">concat</span> <span class="string">"tab-"</span> ahref)</span>)</span>)</span></span><br><span class="line">                           <span class="list">(<span class="list">(<span class="keyword">></span> level <span class="number">1</span>)</span></span><br><span class="line">                            <span class="string">"<li>\n"</li></span>)</span>)</span></span><br><span class="line">                   <span class="list">(<span class="keyword">cond</span> <span class="list">(<span class="list">(<span class="keyword">=</span> level <span class="number">1</span>)</span></span><br><span class="line">                          <span class="list">(<span class="keyword">format</span> <span class="string">"\n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<div class="\" tab-pane\""="" id="\" %s\""="">\n<ul>\n"<br><span class="line">                                  <span class="list">(<span class="keyword">concat</span> <span class="string">"tab-"</span> ahref)</span>)</span>)<br><span class="line">                         <span class="list">(<span class="list">(<span class="keyword">></span> level <span class="number">1</span>)</span></span><br><span class="line">                          <span class="string">"\n<li>\n"</li></span>)</span>)</span>))<br><span class="line">               headline)</span>)))<br><span class="line">        toc-entries <span class="string">""</span>)</span><br><span class="line">       <span class="string">"</span></span></ul></div>"<br><span class="line">       )</span>))<br><span class="line">  )</span><br><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><colgroup><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left"> </th><th scope="col" class="org-left">功能</th></tr></thead><tbody><tr><td class="org-left">hexo-theme-next/link-add-font-awesome</td><td class="org-left">将所有链接后插入 font awesome <a href="https://fontawesome.com/v4.7.0/icon/external-link/" target="_blank" rel="noopener">箭头图标 <i class="fa fa-external-link" aria-hidden="true"></i></a></td></tr><tr><td class="org-left">hexo-theme-next/center-quote</td><td class="org-left">将 org 的 <code>#+BEGIN_CENTER</code> 代码块转换为 NexT 的 <a href="https://theme-next.org/docs/tag-plugins/#Centered-Quote" target="_blank" rel="noopener">centerquote <i class="fa fa-external-link" aria-hidden="true"></i></a> 标签</td></tr><tr><td class="org-left">org-html-todo-kwd-class-prefix</td><td class="org-left">给标题中的 TODO 关键字加上 NexT 的 <a href="https://theme-next.org/docs/tag-plugins/label/" target="_blank" rel="noopener">label <i class="fa fa-external-link" aria-hidden="true"></i></a> 样式</td></tr><tr><td class="org-left">org-html-postamble-format</td><td class="org-left">配合 <code>_config.yml</code> 中 <code>postamble:t</code> 使用, 自动在文章末尾加上 Generated 文字</td></tr><tr><td class="org-left">org-html-toc</td><td class="org-left">将文章开头 org 自动生成的 Table of Content 转换成 NexT 漂亮的 <a href="https://theme-next.org/docs/tag-plugins/tabs/" target="_blank" rel="noopener">tabs 标签 <i class="fa fa-external-link" aria-hidden="true"></i></a></td></tr></tbody></table><div id="outline-container-org99d99fd" class="outline-2"><h2 id="org99d99fd"><span class="section-number-2">5.</span> 技巧</h2><div class="outline-text-2" id="text-5"><p>有时候需要直接在 org 文档中包含 hexo 特殊标签字符时会 <code>hexo g</code> 会出错, 或者输出会消失, 比如本文中的 {%% asset_img %%} {% asset_img %} .</p><p>这是因为这些字符会被 Hexo 引擎特殊处理, 当你需要输出这些特殊字符, 可以在外面用 raw 标签包围, 这样 hexo 引擎就不会处理这些字符了.</p><p></p><pre class="example">{% raw %}{% asset_img %}{% endraw %}</pre><p></p></div></div><div id="footnotes"><h2 class="footnotes">Footnotes: </h2><div id="text-footnotes"><div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">hexo-renderer-org 最早是 <a href="https://github.com/coldnew/hexo-renderer-org" target="_blank" rel="noopener">coldnew <i class="fa fa-external-link" aria-hidden="true"></i></a> 开发的, 但是已经停止维护了,emacs 升级到 26.1 之后不能使用.</p><p class="footpara"><a href="https://github.com/MephistoMMM/hexo-renderer-org" target="_blank" rel="noopener">MephistoMMM <i class="fa fa-external-link" aria-hidden="true"></i></a> 修复了问题, 我自己 fork 之后又修复了几个问题, 目前已经可以稳定使用.</p></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
      <category term="Hexo" scheme="http://mpwang.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>org 文档使用 ob-ipython 进行 python literal programming</title>
    <link href="http://mpwang.github.io/2019/02/07/how-to-use-ob-ipython/"/>
    <id>http://mpwang.github.io/2019/02/07/how-to-use-ob-ipython/</id>
    <published>2019-02-07T14:25:37.000Z</published>
    <updated>2019-02-09T19:25:11.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orge91b059">1. ob-ipython</a></li><li class="tab"><a class="btn" href="#tab-org16608bf">2. 安装</a></li><li class="tab"><a class="btn" href="#tab-org6df32de">3. 配置</a></li><li class="tab"><a class="btn" href="#tab-org4318a6f">4. 使用 yasnippet</a></li><li class="tab"><a class="btn" href="#tab-orgec760ba">5. 显示图片及表格</a></li><li class="tab"><a class="btn" href="#tab-org48e34ba">6. Enjoy</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orge91b059"><ul><a href="#orge91b059">1. ob-ipython</a></ul></div><div class="tab-pane" id="tab-org16608bf"><ul><a href="#org16608bf">2. 安装</a><li><a href="#org3406279">2.1. 安装 ob-ipython</a></li><li><a href="#org66c2770">2.2. 安装 jupyter</a></li><li><a href="#org8e377b2">2.2.1. 手动安装 jupyter</a></li><li><a href="#org683e998">2.2.2. 使用 use-package</a></li></ul></div><div class="tab-pane" id="tab-org6df32de"><ul><a href="#org6df32de">3. 配置</a></ul></div><div class="tab-pane" id="tab-org4318a6f"><ul><a href="#org4318a6f">4. 使用 yasnippet</a></ul></div><div class="tab-pane" id="tab-orgec760ba"><ul><a href="#orgec760ba">5. 显示图片及表格</a></ul></div><div class="tab-pane" id="tab-org48e34ba"><ul><a href="#org48e34ba">6. Enjoy</a></ul></div></div></div><div id="outline-container-orge91b059" class="outline-2"><h2 id="orge91b059"><span class="section-number-2">1.</span> ob-ipython</h2><div class="outline-text-2" id="text-1"><p>使用 <a href="https://github.com/gregsexton/ob-ipython" target="_blank" rel="noopener"><code>ob-ipython</code> <i class="fa fa-external-link" aria-hidden="true"></i></a> 可以在 org 文档内运行代码块, 代码块内容会被发送到后台的<code>Jupyter</code> 进程运行, 返回结果会被插入到 org 文档中. org 文档丰富的显示类型使得使用 org 文档来代替 jupyter notebook 成为了一种不错的体验.</p><p>效果图</p><p><img src="/2019/02/07/how-to-use-ob-ipython/screenshot.jpg"></p></div></div><div id="outline-container-org16608bf" class="outline-2"><h2 id="org16608bf"><span class="section-number-2">2.</span> 安装</h2><div class="outline-text-2" id="text-2"><p>以下指引针对 spacemacs 用户, 其它配置的用户需要在自己的配置中添加对应的设置.</p></div><div id="outline-container-org3406279" class="outline-3"><h3 id="org3406279"><span class="section-number-3">2.1.</span> 安装 ob-ipython</h3><div class="outline-text-3" id="text-2-1"><p>在 <code>dotspacemacs-additional-packages</code> 中添加 ob-ipython.</p><p><code>SPC f e R</code> 重新载入 spacemacs 配置或者重启 spacemacs 下载安装 ob-ipython.</p></div></div><div id="outline-container-org66c2770" class="outline-3"><h3 id="org66c2770"><span class="section-number-3">2.2.</span> 安装 jupyter</h3><div class="outline-text-3" id="text-2-2"></div><div id="outline-container-org8e377b2" class="outline-4"><h4 id="org8e377b2"><span class="section-number-4">2.2.1.</span> 手动安装 jupyter</h4><div class="outline-text-4" id="text-2-2-1"><p>python3 安装 jupyter</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">pip3 install jupyter</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org683e998" class="outline-4"><h4 id="org683e998"><span class="section-number-4">2.2.2.</span> 使用 use-package</h4><div class="outline-text-4" id="text-2-2-2"><p>在 <code>dotspacemacs/user-config</code> 中添加</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">use-package</span> use-package-ensure-system-package</span><br><span class="line">  <span class="keyword">:ensure</span> <span class="literal">t</span>)</span></span><br><span class="line"><span class="list">(<span class="keyword">use-package</span> ob-ipython</span><br><span class="line">  <span class="keyword">:ensure-system-package</span> <span class="list">(<span class="list">(<span class="keyword">jupyter</span> . <span class="string">"pip3 install jupyter"</span>)</span>)</span>)</span></span><br></pre></td></tr></table></figure></div><p>使用 use-package 的 <a href="https://github.com/jwiegley/use-package#use-package-ensure-system-package" target="_blank" rel="noopener">use-package-ensure-system-package <i class="fa fa-external-link" aria-hidden="true"></i></a> 功能, 如果系统 <code>PATH</code> 中没有 jupyter, 自动运行下载命令.</p><p><code>SPC f e R</code> 重新载入 spacemacs 配置.</p></div></div></div></div><div id="outline-container-org6df32de" class="outline-2"><h2 id="org6df32de"><span class="section-number-2">3.</span> 配置</h2><div class="outline-text-2" id="text-3"><p>在 <code>dotspacemacs/user-config</code> 中添加</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; 设置 python 解析器路径</span></span><br><span class="line"><span class="list">(<span class="keyword">setq</span> python-shell-interpreter <span class="string">"/usr/local/bin/python3"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'org</span></span><br><span class="line">  <span class="list">(<span class="keyword">add-to-list</span> <span class="quoted">'org-babel-load-languages</span> <span class="quoted">'(ipython . t)</span>)</span></span><br><span class="line">  <span class="comment">;; 不再询问是否允许执行代码块</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-confirm-babel-evaluate <span class="literal">nil</span>)</span></span><br><span class="line">  <span class="comment">;; display/update images in the buffer after I evaluate</span></span><br><span class="line">  <span class="list">(<span class="keyword">add-hook</span> <span class="quoted">'org-babel-after-execute-hook</span> <span class="quoted">'org-display-inline-images</span> <span class="quoted">'append</span>)</span></span><br><span class="line">  )</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org4318a6f" class="outline-2"><h2 id="org4318a6f"><span class="section-number-2">4.</span> 使用 yasnippet</h2><div class="outline-text-2" id="text-4"><p>使用 <a href="https://github.com/joaotavora/yasnippet" target="_blank" rel="noopener">yasnippet <i class="fa fa-external-link" aria-hidden="true"></i></a> 帮助你快速的创建 ipython 代码块.</p><p>打开 org 文档, 点击菜单 YASnippet <code>New snippet</code>, 粘贴以下内容, 保存.</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line"># -*- mode: snippet -*-# name: ipython block# key: srcip# --#+BEGIN_SRC ipython :session ${1::ipyfile ${2:$$(let ((temporary-file-directory "./")) (make-temp-file (concat (file-name-sans-extension (file-name-nondirectory buffer-file-name)) "-py") nil ".png"))} }:exports ${3:both} :results raw drawer$0#+END_SRC</span><br></pre></td></tr></table></figure></div><p>现在你可以在 org 文档中输入关键字 <code>srcip</code> 然后使用 <code>M-/</code> 自动扩展, 然后连续按下 <code>TAB</code> 自动生成类似以下的代码</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">#+BEGIN_SRC ipython :session :ipyfile /Users/mpwang/org/test-py9bDtND.png :exports both :results raw drawer#+END_SRC</span><br></pre></td></tr></table></figure></div><p>假设你的 org 文件名为 test.org, 如果你的代码块会生成图片, 这段代码会自动创建随机生成的以 test 开头的文件名 <code>test-py9bDtND.png</code> 保存图片.</p></div></div><div id="outline-container-orgec760ba" class="outline-2"><h2 id="orgec760ba"><span class="section-number-2">5.</span> 显示图片及表格</h2><div class="outline-text-2" id="text-5"><p><a href="https://ipython.org/ipython-doc/1/config/overview.html#startup-files" target="_blank" rel="noopener">ipython startup files <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>设置 ipython startup 文件让 org 文档显示图片以及表格</p><p>在 <code>~/.ipython/profile_default/startup</code> 中添加 ob-ipython.py 文件, 插入以下内容, 保存.</p><div class="org-src-container"><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> IPython</span><br><span class="line"><span class="keyword">from</span> tabulate <span class="keyword">import</span> tabulate</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgFormatter</span><span class="params">(IPython.core.formatters.BaseFormatter)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> tabulate(obj, headers=<span class="string">'keys'</span>,</span><br><span class="line">                            tablefmt=<span class="string">'orgtbl'</span>, showindex=<span class="string">'always'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">ip = get_ipython()</span><br><span class="line">ip.display_formatter.formatters[<span class="string">'text/org'</span>] = OrgFormatter()</span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org48e34ba" class="outline-2"><h2 id="org48e34ba"><span class="section-number-2">6.</span> Enjoy</h2><div class="outline-text-2" id="text-6"><p>现在你已经可以在 org 文档代码块中使用 <code>C-c C-c</code> 执行 python 代码并且可以在 org文档中漂亮地显示图片以及表格了.</p><blockquote class="blockquote-center"><p>Emacs Rocks!</p></blockquote></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>spacemacs 与 org-mode 配置与使用技巧</title>
    <link href="http://mpwang.github.io/2019/02/06/productivity/"/>
    <id>http://mpwang.github.io/2019/02/06/productivity/</id>
    <published>2019-02-05T17:13:00.000Z</published>
    <updated>2019-02-10T17:20:55.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orgda6725c">1. Spacemacs 配置</a></li><li class="tab"><a class="btn" href="#tab-org8581aa6">2. Spacemacs 美化</a></li><li class="tab"><a class="btn" href="#tab-orgdce6e7c">3. Spacemacs 使用技巧</a></li><li class="tab"><a class="btn" href="#tab-org35d4b2b">4. org-mode 使用技巧</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orgda6725c"><ul><a href="#orgda6725c">1. Spacemacs 配置</a><li><a href="#orge35cce1">1.1. 使用中国镜像</a></li><li><a href="#org61ded8a">1.2. 配置代理</a></li><li><a href="#orgb6a163c">1.3. 使用 spacelpa</a></li></ul></div><div class="tab-pane" id="tab-org8581aa6"><ul><a href="#org8581aa6">2. Spacemacs 美化</a><li><a href="#org195db10">2.1. 字体</a></li><li><a href="#orgcfd613d">2.2. 字体: 使用 cnfonts 配置中英文对齐</a></li><li><a href="#org3342f8d">2.2.1. 安装</a></li><li><a href="#orgdd0a1df">2.2.2. 配置</a></li><li><a href="#org4a33b0f">2.2.3. 设置中英文对齐</a></li><li><a href="#orgb0774a6">2.3. <span class="todo TODO">TODO</span> 主题: doom-themes</a></li><li><a href="#orgf3b63e6">2.4. <span class="todo TODO">TODO</span> solaire-mode:</a></li><li><a href="#orga8c6d9f">2.5. mode line 显示时间</a></li></ul></div><div class="tab-pane" id="tab-orgdce6e7c"><ul><a href="#orgdce6e7c">3. Spacemacs 使用技巧</a><li><a href="#orgc0553b2">3.1. 导航: 使用 avy</a></li><li><a href="#orgff73048">3.2. 搜索: 使用 helm-swoop</a></li><li><a href="#org97c6aa4">3.3. 搜索: 使用外部工具搜索文件</a></li></ul></div><div class="tab-pane" id="tab-org35d4b2b"><ul><a href="#org35d4b2b">4. org-mode 使用技巧</a><li><a href="#orgdf13fb3">4.1. org-mode 配置重要提示</a></li><li><a href="#org5ec3761">4.2. 中英文之间自动插入空格</a></li><li><a href="#orgee9c973">4.3. 运行 shell 命令, 不需要离开 emacs</a></li><li><a href="#orgc5ed22d">4.4. 关闭图片显示</a></li><li><a href="#org2cd684a">4.5. 转义</a></li><li><a href="#org9f465ba">4.5.1. #+BEGIN_SRC 转义</a></li><li><a href="#org20002c1">4.5.2. org-table 中转义 <code>|</code> 字符</a></li></ul></div></div></div><div id="outline-container-orgda6725c" class="outline-2"><h2 id="orgda6725c"><span class="section-number-2">1.</span> Spacemacs 配置</h2><div class="outline-text-2" id="text-1"><p><a href="http://spacemacs.org/" target="_blank" rel="noopener">Spacemacs <i class="fa fa-external-link" aria-hidden="true"></i></a> 集合了 emacs 社区的努力, 为 emacs 提供一个成熟稳定, 开箱即用的 emacs 配置做了相当好的工作. 个人使用 Spacemacs 也有相当一段时间, 以下是一些配置 Spacemacs 的 tips.</p></div><div id="outline-container-orge35cce1" class="outline-3"><h3 id="orge35cce1"><span class="section-number-3">1.1.</span> 使用中国镜像</h3><div class="outline-text-3" id="text-1-1"><p>在 <code>dotspacemacs/user-init</code> 中添加 <a href="https://mirror.tuna.tsinghua.edu.cn/help/elpa/" target="_blank" rel="noopener">melpa 中国镜像 <i class="fa fa-external-link" aria-hidden="true"></i></a></p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"> <span class="comment">;; melpa china mirrors</span></span><br><span class="line"><span class="list">(<span class="keyword">setq</span> configuration-layer--elpa-archives</span><br><span class="line">      <span class="quoted">'((<span class="string">"melpa-cn"</span> . <span class="string">"http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/"</span>)</span><br><span class="line">        (<span class="string">"org-cn"</span>   . <span class="string">"http://mirrors.tuna.tsinghua.edu.cn/elpa/org/"</span>)</span><br><span class="line">        (<span class="string">"gnu-cn"</span>   . <span class="string">"http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/"</span>))</span>)</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org61ded8a" class="outline-3"><h3 id="org61ded8a"><span class="section-number-3">1.2.</span> 配置代理</h3><div class="outline-text-3" id="text-1-2"><p>连接国外的软件源由于网络问题, 通常较慢. 可以在 <code>dotspacemacs/user-init</code> 中设置代理</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; proxy</span></span><br><span class="line"><span class="list">(<span class="keyword">setq</span> url-proxy-services <span class="quoted">'((<span class="string">"no_proxy"</span> . <span class="string">"127.0.0.1"</span>)</span><br><span class="line">                          (<span class="string">"http"</span> . <span class="string">"127.0.0.1:1087"</span>)</span><br><span class="line">                          (<span class="string">"https"</span> . <span class="string">"127.0.0.1:1087"</span>)</span><br><span class="line">                          )</span>)</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgb6a163c" class="outline-3"><h3 id="orgb6a163c"><span class="section-number-3">1.3.</span> 使用 spacelpa</h3><div class="outline-text-3" id="text-1-3"><p><div class="note warning">            <p>spacemacs develop 分支特性</p>          </div></p><ul class="org-ul"><li>emacs version: 26.1</li><li>spacemacs develop version: 0.300</li></ul><p><a href="https://github.com/syl20bnr/spacemacs/issues/10438" target="_blank" rel="noopener">emacs26 下载 spacelpa 会遇到问题 <i class="fa fa-external-link" aria-hidden="true"></i></a>, 提前手动下载好 spacelpa 文件跳过自动下载及解压的步骤 (<a href="https://github.com/syl20bnr/spacemacs/issues/10438#issuecomment-387449474" target="_blank" rel="noopener">refer <i class="fa fa-external-link" aria-hidden="true"></i></a>).</p><div class="org-src-container"><figure class="highlight"><table><tr><td class="code"><pre><span class="line">mkdir ~/.emacs.d/.cache/stable-elpa/26.1cd ~/.emacs.d/.cache/stable-elpa/26.1wget https://github.com/syl20bnr/spacelpa/archive/v0.300.tar.gz -O spacelpa-0.300.tar.gztar -xzvf spacelpa-0.300.tar.gzecho -n "0.300" > version</span><br></pre></td></tr></table></figure></div><p><code>.spacemaces</code> 设置</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dotspacemacs-use-spacelpa <span class="literal">t</span></span><br></pre></td></tr></table></figure></div><p><code>SPC f e R</code> 或者重启 emacs</p></div></div></div><div id="outline-container-org8581aa6" class="outline-2"><h2 id="org8581aa6"><span class="section-number-2">2.</span> Spacemacs 美化</h2><div class="outline-text-2" id="text-2"></div><div id="outline-container-org195db10" class="outline-3"><h3 id="org195db10"><span class="section-number-3">2.1.</span> 字体</h3><div class="outline-text-3" id="text-2-1"><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 1:</span> 编程字体, 等宽中文字体以及不常见汉字字体</caption><colgroup><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left"> </th><th scope="col" class="org-left">font family name</th></tr></thead><tbody><tr><td class="org-left"><a href="https://github.com/be5invis/Iosevka/releases" target="_blank" rel="noopener">Iosevka (Source Code Pro Style) <i class="fa fa-external-link" aria-hidden="true"></i></a></td><td class="org-left">"Iosevka SS09"</td></tr><tr><td class="org-left"><a href="https://github.com/be5invis/Sarasa-Gothic/releases" target="_blank" rel="noopener">Sarasa Gothic (更纱黑体) <i class="fa fa-external-link" aria-hidden="true"></i></a></td><td class="org-left">"等距更纱黑体 SC"</td></tr><tr><td class="org-left"><a href="http://fonts.jp/hanazono/" target="_blank" rel="noopener">花園明朝 <i class="fa fa-external-link" aria-hidden="true"></i></a></td><td class="org-left">"HanaMinB"</td></tr></tbody></table><ul class="org-ul"><li>安装所有字体 iosevka-ss09-2.1.0.zip</li><li>安装所有 sarasa-gothic-sc-*.ttf 字体</li></ul><p>配置字体</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dotspacemacs-default-font <span class="quoted">'(<span class="string">"Iosevka SS09"</span></span><br><span class="line">                            <span class="keyword">:size</span> <span class="number">16</span></span><br><span class="line">                            <span class="keyword">:weight</span> normal</span><br><span class="line">                            <span class="keyword">:width</span> normal)</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgcfd613d" class="outline-3"><h3 id="orgcfd613d"><span class="section-number-3">2.2.</span> 字体: 使用 cnfonts 配置中英文对齐</h3><div class="outline-text-3" id="text-2-2"><p>使用 org-table 时中英文混排时字体需要对齐, 使用 <a href="https://github.com/tumashu/cnfonts" target="_blank" rel="noopener">cnfonts <i class="fa fa-external-link" aria-hidden="true"></i></a> 项目解决这一问题.</p></div><div id="outline-container-org3342f8d" class="outline-4"><h4 id="org3342f8d"><span class="section-number-4">2.2.1.</span> 安装</h4><div class="outline-text-4" id="text-2-2-1"><blockquote><p><code>dotspacemacs-additional-packages</code> 中添加 <code>cnfonts</code></p></blockquote></div></div><div id="outline-container-orgdd0a1df" class="outline-4"><h4 id="orgdd0a1df"><span class="section-number-4">2.2.2.</span> 配置</h4><div class="outline-text-4" id="text-2-2-2"><p><code>dotspacemacs/user-config</code> 中添加</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; Chinese and English fonts alignment</span></span><br><span class="line"><span class="list">(<span class="keyword">use-package</span> cnfonts</span><br><span class="line">  <span class="keyword">:config</span></span><br><span class="line">  <span class="list">(<span class="keyword">cnfonts-enable</span>)</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> cnfonts-use-face-font-rescale <span class="literal">t</span>)</span></span><br><span class="line">  )</span></span><br></pre></td></tr></table></figure></div><p>上面的 <code>(setq cnfonts-use-face-font-rescale t)</code> 用于<a href="https://github.com/tumashu/cnfonts#cnfonts-%25E4%25B8%258E-org-mode-%25E9%2585%258D%25E5%2590%2588%25E4%25BD%25BF%25E7%2594%25A8" target="_blank" rel="noopener">设置不同标题中文字体大小不同 <i class="fa fa-external-link" aria-hidden="true"></i></a>,比如 emacs 自带的 lenven 主题就支持这一特性.</p></div></div><div id="outline-container-org4a33b0f" class="outline-4"><h4 id="org4a33b0f"><span class="section-number-4">2.2.3.</span> 设置中英文对齐</h4><div class="outline-text-4" id="text-2-2-3"><blockquote><p>M-x cnfonts-edit-profile</p></blockquote><p>执行之后先不要进行任何操作, <code>SPC f f</code> 打开 <code>~/.emacs.d/cnfonts/v4/profile1.el</code>编辑文件, 在 <code>cnfonts--custom-set-fontnames</code> 的三行中的第一位分别加入已经安装的字体.</p><p>示例</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">setq</span> cnfonts--custom-set-fontnames</span><br><span class="line">      <span class="quoted">'((<span class="string">"Iosevka SS09"</span> <span class="string">"Ubuntu Mono"</span> <span class="string">"DejaVu Sans Mono"</span>)</span><br><span class="line">        (<span class="string">"等距更纱黑体 SC"</span> <span class="string">"Ubuntu Mono"</span> <span class="string">"隶书"</span> <span class="string">"新宋体"</span>)</span><br><span class="line">        (<span class="string">"HanaMinB"</span> <span class="string">"SimSun-ExtB"</span> <span class="string">"MingLiU-ExtB"</span>))</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="list">(<span class="keyword">setq</span> cnfonts--custom-set-fontsizes</span><br><span class="line">      <span class="quoted">'(</span><br><span class="line">        (<span class="number">14</span>   <span class="number">14.0</span> <span class="number">14.0</span>)</span><br><span class="line">        (<span class="number">16</span>   <span class="number">16.0</span> <span class="number">16.0</span>)</span><br><span class="line">        (<span class="number">18</span>   <span class="number">18.0</span> <span class="number">18.0</span>)</span><br><span class="line">        (<span class="number">20</span>   <span class="number">20.0</span> <span class="number">20.0</span>)</span><br><span class="line">        (<span class="number">22</span>   <span class="number">22.0</span> <span class="number">22.0</span>)</span><br><span class="line">        (<span class="number">24</span>   <span class="number">24.0</span> <span class="number">24.0</span>)</span><br><span class="line">        (<span class="number">26</span>   <span class="number">26.0</span> <span class="number">26.0</span>)</span><br><span class="line">        (<span class="number">28</span>   <span class="number">28.0</span> <span class="number">28.0</span>)</span><br><span class="line">        (<span class="number">30</span>   <span class="number">30.0</span> <span class="number">30.0</span>)</span><br><span class="line">        (<span class="number">32</span>   <span class="number">32.0</span> <span class="number">32.0</span>)</span><br><span class="line">        )</span>)</span></span><br></pre></td></tr></table></figure></div><p>再次执行 <code>M-x cnfonts-edit-profile</code>, 按照教程设置中英文对齐.</p><p>重启 emacs 后如果发现字体大小在载入 cnfonts 之后有改变, 应该是 profile 载入设置的问题. 检查 <code>~/.emacs.d/cnfonts/cnfonts.conf</code></p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">nil</span>)</span><span class="list">(<span class="list">(<span class="string">"profile1"</span> . <span class="number">2</span>)</span>)</span></span><br></pre></td></tr></table></figure></div><p>设置好最后的数字, index 从 1 开始. 使默认字体大小与 <code>cnfonts--custom-set-fontsizes</code> 中选择的配置相同.如果 <code>dotspacemacs-default-font :size</code> 为 14, 在这里的应该设置为 <code>1</code>.</p></div></div></div><div id="outline-container-orgb0774a6" class="outline-3"><h3 id="orgb0774a6"><span class="section-number-3">2.3.</span> <span class="todo label warning TODO">TODO</span> 主题: doom-themes</h3></div><div id="outline-container-orgf3b63e6" class="outline-3"><h3 id="orgf3b63e6"><span class="section-number-3">2.4.</span> <span class="todo label warning TODO">TODO</span> solaire-mode:</h3></div><div id="outline-container-orga8c6d9f" class="outline-3"><h3 id="orga8c6d9f"><span class="section-number-3">2.5.</span> mode line 显示时间</h3><div class="outline-text-3" id="text-2-5"><p>在 MacOS 全屏显示下可以方便地查看当前时间</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">display-time-mode</span> <span class="literal">t</span>)</span></span><br></pre></td></tr></table></figure></div></div></div></div><div id="outline-container-orgdce6e7c" class="outline-2"><h2 id="orgdce6e7c"><span class="section-number-2">3.</span> Spacemacs 使用技巧</h2><div class="outline-text-2" id="text-3"></div><div id="outline-container-orgc0553b2" class="outline-3"><h3 id="orgc0553b2"><span class="section-number-3">3.1.</span> 导航: 使用 avy</h3><div class="outline-text-3" id="text-3-1"><p><a href="https://github.com/abo-abo/avy" target="_blank" rel="noopener">avy Github <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>不要再使用重复按 <code>C-n</code> <code>C-p</code> 在当前文件在移动光标到目标位置了. 使用evil-avy-goto-char. 首先眼睛看准目标位置, 然后按下 <code>SPC j j</code>. 跟着提示的字符按下按键直接跳转到目标位置.</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 2:</span> avy 按键绑定</caption><colgroup><col class="org-left"><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left">命令</th><th scope="col" class="org-left">spacemacs 按键绑定</th><th scope="col" class="org-left">功能</th></tr></thead><tbody><tr><td class="org-left">avy-goto-char</td><td class="org-left">SPC j j</td><td class="org-left">跳转到字符</td></tr><tr><td class="org-left">avy-goto-word</td><td class="org-left">SPC j w</td><td class="org-left">跳转到单词</td></tr><tr><td class="org-left">avy-goto-line</td><td class="org-left">SPC j l</td><td class="org-left">跳转到行</td></tr></tbody></table><p>avy-goto-char 示例</p><p><img src="/2019/02/06/productivity/avy-goto-char.png"></p></div></div><div id="outline-container-orgff73048" class="outline-3"><h3 id="orgff73048"><span class="section-number-3">3.2.</span> 搜索: 使用 helm-swoop</h3><div class="outline-text-3" id="text-3-2"><p><a href="https://github.com/ShingoFukuyama/helm-swoop" target="_blank" rel="noopener">helm-swoop Github <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>不再重复地按 <code>C-s</code> 在当前文件中进行搜索, <code>C-s</code> 只适合简单的搜索场景. 使用 helm-swoop 进行预览式搜索.</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 3:</span> helm-swoop 按键绑定</caption><colgroup><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left">Key binding</th><th scope="col" class="org-left">Description</th></tr></thead><tbody><tr><td class="org-left">SPC s s</td><td class="org-left">execute helm-swoop</td></tr><tr><td class="org-left">SPC s S</td><td class="org-left">execute helm-multi-swoop</td></tr><tr><td class="org-left">SPC s C-s</td><td class="org-left">execute helm-multi-swoop-all</td></tr></tbody></table><p>示例</p><p><img src="/2019/02/06/productivity/helm-swoop.gif"></p></div></div><div id="outline-container-org97c6aa4" class="outline-3"><h3 id="org97c6aa4"><span class="section-number-3">3.3.</span> 搜索: 使用外部工具搜索文件</h3><div class="outline-text-3" id="text-3-3"><p><div class="note warning">            <p>spacemacs develop 分支特性: rg (ripgrep) 支持</p>          </div></p><p>仅仅搜索当前 buffer 内容是不够的, spacemacs 可以使用</p><ul class="org-ul"><li><a href="https://github.com/BurntSushi/ripgrep" target="_blank" rel="noopener">rg (ripgrep) <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://github.com/ggreer/the_silver_searcher" target="_blank" rel="noopener">ag (the silver searcher) <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://github.com/monochromegane/the_platinum_searcher" target="_blank" rel="noopener">pt (the platinum searcher) <i class="fa fa-external-link" aria-hidden="true"></i></a></li><li><a href="https://beyondgrep.com/" target="_blank" rel="noopener">ack <i class="fa fa-external-link" aria-hidden="true"></i></a></li></ul><p>等工具进行文件搜索. 如果以上的工具都找不到, spacemacs 就会调用 <code>grep</code>.</p><blockquote><p>dotspacemacs-search-tools, the default order is rg, ag, pt, ack then grep</p></blockquote><p>spacemacs 会按照系统路径中找到以上工具的顺序, 使用统一的界面进行调用.</p><p>推荐 Linux/MacOS 使用 <code>ripgrep</code> (super bleeding fast!), windows 用户使用 <code>pt</code>.</p><p>更多使用请查看<a href="http://develop.spacemacs.org/doc/DOCUMENTATION.html#searching" target="_blank" rel="noopener"> searching <i class="fa fa-external-link" aria-hidden="true"></i></a></p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 4:</span> helm search 按键绑定</caption><colgroup><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left">按键绑定</th><th scope="col" class="org-left">功能</th></tr></thead><tbody><tr><td class="org-left"><code>SPC /</code> or <code>SPC s p</code></td><td class="org-left">search project</td></tr><tr><td class="org-left"><code>SPC /</code> or <code>SPC s d</code></td><td class="org-left">search current directory</td></tr><tr><td class="org-left"><code>SPC s f</code></td><td class="org-left">search in arbitrary directory</td></tr></tbody></table></div></div></div><div id="outline-container-org35d4b2b" class="outline-2"><h2 id="org35d4b2b"><span class="section-number-2">4.</span> org-mode 使用技巧</h2><div class="outline-text-2" id="text-4"></div><div id="outline-container-orgdf13fb3" class="outline-3"><h3 id="orgdf13fb3"><span class="section-number-3">4.1.</span> org-mode 配置重要提示</h3><div class="outline-text-3" id="text-4-1"><p>spacemacs 使用 <code>org</code> ELPA 仓库中的版本, 而不是 emacs 自带的 org.</p><p><a href="http://develop.spacemacs.org/layers/+emacs/org/README.html#important-note" target="_blank" rel="noopener">所有与 org-mode 相关的配置都需要放在 with-eval-after-load 代码块中 <i class="fa fa-external-link" aria-hidden="true"></i></a>, 否则会载入 emacs 自带的 org 版本, 造成版本冲突从而引起各种奇怪的 org-mode 相关的报错.</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'org</span></span><br><span class="line">  <span class="comment">;; here goes your Org config :)</span></span><br><span class="line">  <span class="comment">;; ....</span></span><br><span class="line">  )</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-org5ec3761" class="outline-3"><h3 id="org5ec3761"><span class="section-number-3">4.2.</span> 中英文之间自动插入空格</h3><div class="outline-text-3" id="text-4-2"><p><a href="https://github.com/coldnew/pangu-spacing" target="_blank" rel="noopener">pangu-spacing Github <i class="fa fa-external-link" aria-hidden="true"></i></a></p><p>在 <code>dotspacemacs-additional-packages</code> 中加入 pangu-spacing, <code>SPC f e R</code> 自动下载安装.</p><p><code>dotspacemacs/user-config</code> 中加入配置</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">use-package</span> pangu-spacing</span><br><span class="line">  <span class="keyword">:config</span></span><br><span class="line">  <span class="list">(<span class="keyword">global-pangu-spacing-mode</span> <span class="number">1</span>)</span></span><br><span class="line">  <span class="comment">;; only insert real whitespace in some specific mode, but just add virtual space in other mode</span></span><br><span class="line">  <span class="list">(<span class="keyword">add-hook</span> <span class="quoted">'org-mode-hook</span></span><br><span class="line">            <span class="quoted">'(lambda ()</span><br><span class="line">               (set (make-local-variable 'pangu-spacing-real-insert-separtor) <span class="literal">t</span>))</span>)</span></span><br><span class="line">  )</span></span><br></pre></td></tr></table></figure></div></div></div><div id="outline-container-orgee9c973" class="outline-3"><h3 id="orgee9c973"><span class="section-number-3">4.3.</span> 运行 shell 命令, 不需要离开 emacs</h3><div class="outline-text-3" id="text-4-3"><p>有时在写文档时需要查看某些 shell 命令的运行结果, 运行简单的单个命令并不需要离开emacs, 可以在写文档时带来更好的体验.</p><p>比如在写 markdown 文档时, 使用<a href="https://github.com/yoshuawuyts/vmd" target="_blank" rel="noopener"> vmd <i class="fa fa-external-link" aria-hidden="true"></i></a> 预览效果, 只需要 <code>M-! vmd README.md</code> 即可.</p><p><code>M-x shell-command</code> 可以运行 shell 命令并在 minibuffer 中显示命令输出.</p><p><code>M-x shell-command-on-region</code> 可以将当前选中内容作为输入运行外部 shell 命令, 在minibuffer 中显示命令输出. 运行前加上 <code>C-u</code> 可以选择将命令输出替换当前选中内容.</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 5:</span> Running Shell Commands from Emacs</caption><colgroup><col class="org-left"><col class="org-left"></colgroup><thead><tr><th scope="col" class="org-left">按键绑定</th><th scope="col" class="org-left">命令</th></tr></thead><tbody><tr><td class="org-left">M-<code>!</code></td><td class="org-left">shell-command</td></tr><tr><td class="org-left">M-|</td><td class="org-left">shell-command-on-region</td></tr><tr><td class="org-left">C-u M-|</td><td class="org-left">shell-command-on-region, replace region with  output</td></tr></tbody></table></div></div><div id="outline-container-orgc5ed22d" class="outline-3"><h3 id="orgc5ed22d"><span class="section-number-3">4.4.</span> 关闭图片显示</h3><div class="outline-text-3" id="text-4-4"><p>在 org 文档插入图片后 emacs 会默认渲染图片. 在确认插入图片成功后, 编辑文本时图片会占用大量空间. 我们通常在编辑时会想关闭图片显示.</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"><caption class="t-above"><span class="table-number">Table 6:</span> 切换图片显示</caption><colgroup><col class="org-left"><col class="org-left"></colgroup><tbody><tr><td class="org-left"><code>M-x org-toggle-inline-images</code></td><td class="org-left"><code>C-c C-x C-v</code></td></tr></tbody></table></div></div><div id="outline-container-org2cd684a" class="outline-3"><h3 id="org2cd684a"><span class="section-number-3">4.5.</span> 转义</h3><div class="outline-text-3" id="text-4-5"><p>在需要转义字符时, 记住被包围在 <code>*</code> <code>/</code> <code>_</code> <code>=</code> <code>+</code> 之间的内容特殊字符大部分都不会被解析.</p></div><div id="outline-container-org9f465ba" class="outline-4"><h4 id="org9f465ba"><span class="section-number-4">4.5.1.</span> #+BEGIN_SRC 转义</h4><div class="outline-text-4" id="text-4-5-1"><p><code>#+BEGIN_SRC</code> org 文档会特殊解析, 有时候代码例子中需要原样输出时, 使用 <code>,#</code> 进行转义.</p><pre class="example">#+begin_src,#+begin_src,#+end_src#+end_src</pre></div></div><div id="outline-container-org20002c1" class="outline-4"><h4 id="org20002c1"><span class="section-number-4">4.5.2.</span> org-table 中转义 <code>|</code> 字符</h4><div class="outline-text-4" id="text-4-5-2"><p>需要在 or-table 中输出 <code>|</code> 字符时使用</p><blockquote><p><code>\vert{}</code></p></blockquote><p>进行转义.</p></div></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
      <category term="生产力" scheme="http://mpwang.github.io/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/"/>
    
  </entry>
  
  <entry>
    <title>更换 ox-reveal 为 org-re-reveal</title>
    <link href="http://mpwang.github.io/2019/02/04/swith-to-org-re-reveal/"/>
    <id>http://mpwang.github.io/2019/02/04/swith-to-org-re-reveal/</id>
    <published>2019-02-04T05:43:52.000Z</published>
    <updated>2019-10-20T15:58:48.000Z</updated>
    
    <content type="html"><![CDATA[<div id="content"><div class="tabs" id="org-toc" style="font-size: 12px;"><ul class="nav-tabs"><li class="tab"><a class="btn" href="#tab-orgeb2eeca">1. 问题</a></li><li class="tab"><a class="btn" href="#tab-orgc692330">2. 解决方法</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-orgeb2eeca"><ul><a href="#orgeb2eeca">1. 问题</a></ul></div><div class="tab-pane" id="tab-orgc692330"><ul><a href="#orgc692330">2. 解决方法</a><li><a href="#org4eb31e4">2.1. spacemacs 用户</a></li></ul></div></div></div><div id="outline-container-orgeb2eeca" class="outline-2"><h2 id="orgeb2eeca"><span class="section-number-2">1.</span> 问题</h2><div class="outline-text-2" id="text-1"><p>使用 Spacemacs 更新依赖包之后, org-mode 更新至 9.2 版本.<b><b>org-structure-template-alist</b></b> 的结构定义发生了变化, <b><b>ox-reveal</b></b> 的源码与Org 9.2 不兼容.</p><p>打开 org 文件出现以下的错误:</p><blockquote><p>In Org 9.2 the format was changed from something like</p><p>("s" "#+BEGIN_SRC ?\n#+END_SRC")to something like</p><p>("s" . "src")</p></blockquote><p><a href="https://github.com/yjwen/org-reveal/issues/363" target="_blank" rel="noopener">ox-reveal Original issue <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div></div><div id="outline-container-orgc692330" class="outline-2"><h2 id="orgc692330"><span class="section-number-2">2.</span> 解决方法</h2><div class="outline-text-2" id="text-2"><p>ox-reveal 项目已经很久没有更新了, 看起来应该没有再维护了.</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; Register auto-completion for speaker notes.</span></span><br><span class="line"><span class="list">(<span class="keyword">when</span> org-reveal-note-key-char</span><br><span class="line">  <span class="list">(<span class="keyword">add-to-list</span> <span class="quoted">'org-structure-template-alist</span></span><br><span class="line">               <span class="list">(<span class="keyword">list</span> org-reveal-note-key-char <span class="string">"#+BEGIN_NOTES\n\?\n#+END_NOTES"</span>)</span>)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;; needs to be updated as</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;; Register auto-completion for speaker notes.</span></span><br><span class="line"><span class="list">(<span class="keyword">when</span> org-reveal-note-key-char</span><br><span class="line">  <span class="list">(<span class="keyword">add-to-list</span> <span class="quoted">'org-structure-template-alist</span></span><br><span class="line">               <span class="list">(<span class="keyword">cons</span> org-reveal-note-key-char <span class="string">"NOTES"</span>)</span>)</span>)</span></span><br></pre></td></tr></table></figure></div><p>直接的解决方法更换 ox-reveal 为 <a href="https://gitlab.com/oer/org-re-reveal" target="_blank" rel="noopener">org-re-reveal <i class="fa fa-external-link" aria-hidden="true"></i></a></p></div><div id="outline-container-org4eb31e4" class="outline-3"><h3 id="org4eb31e4"><span class="section-number-3">2.1.</span> spacemacs 用户</h3><div class="outline-text-3" id="text-2-1"><p>将 org-re-reveal 添加到 <b><b>dotspacemacs-additional-packages</b></b></p><p>在 <b><b>dotspacemacs/user-config</b></b> 中添加</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'org</span></span><br><span class="line">  <span class="list">(<span class="keyword">require</span> <span class="quoted">'org-re-reveal</span>)</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-re-reveal-root <span class="string">"file://path-to-reveal.js"</span>)</span></span><br><span class="line">  )</span></span><br></pre></td></tr></table></figure></div><pre class="example">2019-10更新</pre><p>org layer 已经将原来的 org-reveal 更新为 org-re-reveal. 只需在 <code>.spacemacs</code> 中开启即可.</p><p>在 <code>dotspacemacs/layers</code> 中设置</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">dotspacemacs-configuration-layers</span><br><span class="line">   <span class="quoted">'(</span><br><span class="line">     (org :variables</span><br><span class="line">          org-enable-github-support <span class="literal">t</span></span><br><span class="line">          org-enable-reveal-js-support <span class="literal">t</span>)</span><br><span class="line">     )</span></span><br></pre></td></tr></table></figure></div><p>在 <code>dotspacemacs/user-config</code> 中设置</p><div class="org-src-container"><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">with-eval-after-load</span> <span class="quoted">'org</span></span><br><span class="line">  <span class="list">(<span class="keyword">require</span> <span class="quoted">'org-re-reveal</span>)</span></span><br><span class="line">  <span class="list">(<span class="keyword">setq</span> org-re-reveal-root <span class="string">"file://<path to="" reveal.js="">"</path></span>)</span>)</span></span><br></pre></td></tr></table></figure></div></div></div></div></div><div id="postamble" class="status"><p style="font-size: .7em; font-style: italic">Generated using <a href="https://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 29.0.50 (<a href="https://orgmode.org" target="_blank" rel="noopener">Org</a> mode 9.4.6)</p></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div id=&quot;content&quot;&gt;
&lt;div class=&quot;tabs&quot; id=&quot;org-toc&quot; style=&quot;font-size: 12px;&quot;&gt;
&lt;ul class=&quot;nav-tabs&quot;&gt;
&lt;li class=&quot;tab&quot;&gt;
&lt;a class=&quot;btn&quot; href=&quot;#tab
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
      <category term="Org-mode" scheme="http://mpwang.github.io/tags/Org-mode/"/>
    
  </entry>
  
  <entry>
    <title>How to easily replace host:port of a url in Python</title>
    <link href="http://mpwang.github.io/2018/12/31/python-replace-url-host/"/>
    <id>http://mpwang.github.io/2018/12/31/python-replace-url-host/</id>
    <published>2018-12-30T16:16:13.000Z</published>
    <updated>2019-02-08T17:32:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>for python3</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://example.com/about"</span></span><br><span class="line">parsed = urlparse(a)</span><br><span class="line">parsed = parsed._replace(netloc=<span class="string">"localhost:8000"</span>).geturl()</span><br><span class="line">print(parsed)</span><br><span class="line"><span class="comment"># 'http://localhost:8000/about'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;for python3&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>SQLAlchemy 使用自定义 Query 类</title>
    <link href="http://mpwang.github.io/2018/05/26/sqlalchemy-custom-query/"/>
    <id>http://mpwang.github.io/2018/05/26/sqlalchemy-custom-query/</id>
    <published>2018-05-26T09:53:33.000Z</published>
    <updated>2018-05-26T10:51:09.000Z</updated>
    
    <content type="html"><![CDATA[<h1>Session.query_property</h1><p>在 SQLAlchemy 中可以使用 session 的方法<code>query_property</code>方便的使用自定义的 query 类 <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>.</p><p>以下是官方的示例代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Session = scoped_session(sessionmaker())</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    query = Session.query_property()</span><br><span class="line"></span><br><span class="line"><span class="comment"># after mappers are defined</span></span><br><span class="line">result = MyClass.query.filter(MyClass.name==<span class="string">'foo'</span>).all()</span><br></pre></td></tr></table></figure><p><code>query_property</code>接收一个参数<code>cls</code>, 指定自定义的Query class (用户从<code>sqlalchemy.orm.Query</code>继承的子类), 而不是默认的Query.</p><p>示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Query</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassQuery</span><span class="params">(Query)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    query = Session.query_property(cls=MyClassQuery)</span><br><span class="line"></span><br><span class="line"><span class="comment"># after mappers are defined</span></span><br><span class="line"><span class="keyword">assert</span> isinstance(MyClass.query, MyClassQuery)</span><br></pre></td></tr></table></figure><p>以上的方法可以完成一些基本的需求, 但是问题是<code>MyClass.query</code>的类定义时和Session耦合在一起了.</p><p>假如我想使用自定义的Query类, 使用query构造出查询条件后,需要应用到不同的session上(也许几个session代表不同的数据库连接), 这就要求<code>My Class.query</code>在定义时需要与Session解耦, 最后使用<code>query.with_session</code>方法将query绑定到session上应用查询.</p><h1>自定义Query类, 与Session解耦</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例子使用了__init_subclass__方法, 要求python3.6+. 3.6之前的版本需要进行相应的修改.</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> (</span><br><span class="line">    Column,</span><br><span class="line">    String,</span><br><span class="line">    Integer,</span><br><span class="line">    and_,</span><br><span class="line">    orm,</span><br><span class="line">    create_engine</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session, sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm.base <span class="keyword">import</span> class_mapper, exc <span class="keyword">as</span> orm_exc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseQuery</span><span class="params">(orm.Query)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, with_default=False, **kwargs)</span>:</span></span><br><span class="line">        model_cls = self._mapper_zero().class_</span><br><span class="line">        <span class="keyword">if</span> with_default:</span><br><span class="line">            filters = model_cls._default_filters()</span><br><span class="line">            <span class="keyword">if</span> filters <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                self = self.enable_assertions(<span class="keyword">False</span>).filter(filters)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserQuery</span><span class="params">(BaseQuery)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryPropertyMixin</span>:</span></span><br><span class="line">    query_cls = BaseQuery</span><br><span class="line">    query: BaseQuery = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_default_filters</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_query_property</span><span class="params">(query_cls)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">query</span><span class="params">(object)</span>:</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    mapper = class_mapper(owner)</span><br><span class="line">                    <span class="keyword">if</span> mapper:</span><br><span class="line">                        <span class="comment"># custom query class</span></span><br><span class="line">                        <span class="keyword">return</span> query_cls(mapper)</span><br><span class="line">                <span class="keyword">except</span> orm_exc.UnmappedClassError:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> query()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls, **kwargs)</span>:</span></span><br><span class="line">        cls.query = QueryPropertyMixin._query_property(cls.query_cls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base, QueryPropertyMixin)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    query_cls = UserQuery</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_default_filters</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> and_(</span><br><span class="line">            cls.name != <span class="keyword">None</span>,</span><br><span class="line">            cls.fullname != <span class="keyword">None</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">'sqlite:///:memory:'</span>, echo=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">Session = scoped_session(sessionmaker(bind=engine))</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line">session.add(User(id=<span class="number">1</span>, name=<span class="string">'name'</span>, fullname=<span class="string">'fullname'</span>))</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> isinstance(User.query, UserQuery)</span><br><span class="line"></span><br><span class="line">record = User.query.filter_by(id=<span class="number">1</span>).with_session(session).one()</span><br><span class="line"><span class="keyword">assert</span> record.id == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">query_str = User.query(with_default=<span class="keyword">True</span>)</span><br><span class="line"><span class="keyword">assert</span> str(query_str).find(<span class="string">'User.name IS NOT NULL'</span>)</span><br></pre></td></tr></table></figure><p>首先定义自己的Query继承关系, BaseQuery继承<code>orm.Query</code>, 每个model如果需要有自己的特定查询类则继承BaseQuery. 在User中使用<code>query_cls</code>指定特定的查询类, 不定义则使用默认的BaseQuery.</p><p>核心点在于User模型继承了<code>QueryPropertyMixin</code>, 在<code>QueryPropertyMixin</code>使用了<code>__init_subclass__</code>方法控制子类在初始化时生成<code>query</code>对象.这样<code>User.query</code>对象就与session解耦, 在之后就使用<code>with_session</code>与具体session绑定进行查询了.</p><p>例子中还演示了如何在model类定义中一个default_filters, 代表某些情况中需要使用的filters, 方便查询特定条件的对象.</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="http://docs.sqlalchemy.org/en/latest/orm/contextual.html#sqlalchemy.orm.scoping.scoped_session.query_property" target="_blank" rel="noopener">SQLAlchemy session query_property</a> <a href="#fnref1" class="footnote-backref">↩</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;Session.query_property&lt;/h1&gt;
&lt;p&gt;在 SQLAlchemy 中可以使用 session 的方法&lt;code&gt;query_property&lt;/code&gt;方便的使用自定义的 query 类 &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a h
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
      <category term="SQLAlchemy" scheme="http://mpwang.github.io/tags/SQLAlchemy/"/>
    
  </entry>
  
  <entry>
    <title>Mac High Sierra 彻底删除bootcamp分区</title>
    <link href="http://mpwang.github.io/2018/05/05/delete-bootcamp-win10/"/>
    <id>http://mpwang.github.io/2018/05/05/delete-bootcamp-win10/</id>
    <published>2018-05-05T14:30:53.000Z</published>
    <updated>2018-05-05T15:40:19.000Z</updated>
    
    <content type="html"><![CDATA[<h1>bootcamp 无法删除 Windows 10分区</h1><p>很久之前在Mac上使用bootcamp安装了windows10, Mac升级到10.13.4 High Sierra之后发现自己几乎没用过win10.于是想删除bootcamp分区, 理想情况下使用bootcamp助理应该可以无痛删除win10分区. 然而mac在升级之后应该是使用了新的文件系统格式APFS.</p><p>打开bootcamp助理后, 提示错误: <code>启动磁盘不能被分区或恢复成单个分区</code>, 无法继续.</p><p>官方说明: <a href="https://support.apple.com/zh-cn/HT203913" target="_blank" rel="noopener">将 Boot Camp 升级到 Windows 8.1 或更高版本时，您可能会看到一则警告信息“启动磁盘不能被分区或恢复成单个分区”</a>。</p><p>于是开始折腾. 在没有做数据备份的情况下, 一路有惊无险, 记录解决过程如下.</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">警告：磁盘操作具有破坏性、高风险，建议操作前做好备份. 你必须十分清楚自己在做什么.</span><br></pre></td></tr></table></figure><h1>分区情况</h1><p>找开磁盘工具查看分区表, 这里借用网上找到的一张图片, 操作之前没有截图.</p><p><img src="/images/bootcamp.jpg" alt="分区"></p><p>我的情况是除了mac APFS分区顺时针有一个8G的未格式化可用空间, 40G的windows10分区, 以及一个800M的disk0s4额外分区(Microsoft 保留或者Windows 恢复分区).</p><p>使用<code>diskutil</code>工具查看分区表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil list</span><br><span class="line">/dev/disk0 (internal):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      GUID_partition_scheme                         251.0 GB   disk0</span><br><span class="line">   1:                        EFI EFI                     314.6 MB   disk0s1</span><br><span class="line">   2:                 Apple_APFS Container disk1         201.4 GB   disk0s2</span><br><span class="line">   3:       Microsoft Basic Data BOOTCAMP                39.8 GB    disk0s3</span><br><span class="line">   4:           Windows Recovery                         892.3 MB   disk0s4</span><br><span class="line"></span><br><span class="line">/dev/disk1 (synthesized):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      APFS Container Scheme -                      +201.4 GB   disk1</span><br><span class="line">                                 Physical Store disk0s2</span><br><span class="line">   1:                APFS Volume Macintosh HD            166.1 GB   disk1s1</span><br><span class="line">   2:                APFS Volume Preboot                 22.7 MB    disk1s2</span><br><span class="line">   3:                APFS Volume Recovery                517.8 MB   disk1s3</span><br><span class="line">   4:                APFS Volume VM                      3.2 GB     disk1s4</span><br></pre></td></tr></table></figure><p><strong>这里注意到8G的未格式化可用空间的分区在分区表中找不到</strong>.</p><p>这里也决定了我按照官方的操作方法无法成功. 在磁盘工具分区里删除选择disk04分区, 点击上图<code>-</code>号后, 应用里提示错误: <code>无法找到其中一个分区</code>. 我推测这里应该是找不到8G空间那个分区导致无法使用磁盘工具正常删除disk0s4分区.</p><p><img src="/images/bootcamp1.png" alt="删除失败"></p><h1>diskutil eraseVolume</h1><p>使用命令行工具删除disk0s4分区, 然后删除disk0s3分区(bootcamp分区). 这里顺序<span style="color: red"><strong>很重要</strong></span>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">╰─ sudo diskutil eraseVolume JHFS+ deleteme /dev/disk0s4</span><br><span class="line">Password:</span><br><span class="line">Started erase on disk0s4</span><br><span class="line">Unmounting disk</span><br><span class="line">Erasing</span><br><span class="line">Initialized /dev/rdisk0s4 as a 851 MB case-insensitive HFS Plus volume with a 8192k journal</span><br><span class="line">Mounting disk</span><br><span class="line">Finished erase on disk0s4 deleteme</span><br><span class="line"></span><br><span class="line">╰─ sudo diskutil eraseVolume JHFS+ deleteme /dev/disk0s3</span><br><span class="line">Started erase on disk0s3 BOOTCAMP</span><br><span class="line">Unmounting disk</span><br><span class="line">Erasing</span><br><span class="line">Initialized /dev/rdisk0s3 as a 37 GB case-insensitive HFS Plus volume with a 8192k journal</span><br><span class="line">Mounting disk</span><br><span class="line">Finished erase on disk0s3 deleteme</span><br></pre></td></tr></table></figure><p>这时使用磁盘工具, 选择根卷分区, 选择disk0s4分区, 点击减号, 选择disk0s3分区, 点击减号. 可以成功合并原来disk0s4 disk0s3的空间.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil list</span><br><span class="line">/dev/disk0 (internal):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      GUID_partition_scheme                         251.0 GB   disk0</span><br><span class="line">   1:                        EFI EFI                     314.6 MB   disk0s1</span><br><span class="line">   2:                 Apple_APFS Container disk1         201.4 GB   disk0s2</span><br><span class="line">   3:                  Apple_HFS deleteme                40.5 GB    disk0s3</span><br><span class="line"></span><br><span class="line">/dev/disk1 (synthesized):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      APFS Container Scheme -                      +201.4 GB   disk1</span><br><span class="line">                                 Physical Store disk0s2</span><br><span class="line">   1:                APFS Volume Macintosh HD            166.1 GB   disk1s1</span><br><span class="line">   2:                APFS Volume Preboot                 22.7 MB    disk1s2</span><br><span class="line">   3:                APFS Volume Recovery                517.8 MB   disk1s3</span><br><span class="line">   4:                APFS Volume VM                      2.1 GB     disk1s4</span><br></pre></td></tr></table></figure><p>这时已经将bootcamp分区 disk0s3 格式化成 HFS+ 格式. 但是由于那个8G空间分区无法在分区表中找到. 始终无法使用磁盘工具将8G空间分区和bootcamp分区合并到mac APFS分区中.</p><h1>diskutil mergePartitions</h1><p>根据网上找到的资料, 开始作死使用<code>diskutil mergePartitions</code>命令尝试合并分区.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil mergePartitions --help</span><br><span class="line">Usage:  diskutil mergePartitions [force] format name</span><br><span class="line">        DiskIdentifier|DeviceNode DiskIdentifier|DeviceNode</span><br><span class="line">Merge two or more pre-existing partitions into one. The first disk parameter</span><br><span class="line">is the starting partition; the second disk parameter is the ending partition;</span><br><span class="line">this given range of two or more partitions will be merged into one.</span><br><span class="line">All partitions in the range, except for the first one, must be unmountable.</span><br><span class="line">All data on merged partitions other than the first will be lost; data on the</span><br><span class="line">first partition will be lost as well if the "force" argument is given.</span><br><span class="line">If "force" is not given, and the first partition has a resizable file system</span><br><span class="line">(e.g. JHFS+), it will be grown in a data-preserving manner, even if a different</span><br><span class="line">file system is specified (in fact, your file system and volume name parameters</span><br><span class="line">are both ignored in this case). Also, if "force" is not given, and the first</span><br><span class="line">partition is not resizable, you will be prompted if you want to erase.</span><br><span class="line">However, if "force" is given, the first partition is always formatted. You</span><br><span class="line">should do this if you wish to reformat to a new file system type.</span><br><span class="line">Merged partitions are required to be ordered sequentially on disk.</span><br><span class="line">See `diskutil list` for the actual on-disk ordering; BSD slice identifiers</span><br><span class="line">may in certain circumstances not always be in numerical order but the</span><br><span class="line">top-to-bottom order given by diskutil list is always the on-disk order.</span><br><span class="line">Ownership of the affected disk is required.</span><br><span class="line">Example: diskutil mergePartitions JHFS+ NewName disk3s4 disk3s7</span><br><span class="line">         This example will merge all partitions *BETWEEN* disk3s4 and disk3s7,</span><br><span class="line">         preserving data on disk3s4 but destroying data on disk3s5, disk3s6,</span><br><span class="line">         disk3s7 and any invisible free space partitions between those disks;</span><br><span class="line">         disk3s4 will be grown to cover the full space if possible.</span><br></pre></td></tr></table></figure><p>发现无法成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil mergePartitions APFS randall disk0s2 disk0s3</span><br><span class="line">You cannot merge disks into an APFS Physical Store</span><br><span class="line">Instead, you can delete the partitions following the APFS Physical Store by</span><br><span class="line">using "diskutil eraseVolume free n &lt;disk&gt;" for all such partitions, and</span><br><span class="line">then by growing the corresponding APFS Container by its APFS Physical Store</span><br><span class="line">to fill the gap by using "diskutil apfs resizeContainer disk0s2 0"</span><br></pre></td></tr></table></figure><h1>diskutil apfs resizeContainer</h1><p>不得不赞mac命令行工具的提示真的做得非常好, 在这里发现了<span style="color: red">关键性的信息</span>:</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APFS格式分区可以使用diskutil apfs resizeContainer命令自动扩展空间到下一个可用分区.</span><br></pre></td></tr></table></figure><p>8G空间分区本身是未格式化的, 符合要求.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil apfs resizeContainer disk0s2 0</span><br><span class="line">Started APFS operation</span><br><span class="line">Aligning grow delta to 8,650,686,464 bytes and targeting a new physical store size of 210,007,728,128 bytes</span><br><span class="line">Determined the maximum size for the targeted physical store of this APFS Container to be 210,007,728,128 bytes</span><br><span class="line">Resizing APFS Container designated by APFS Container Reference disk1</span><br><span class="line">The specific APFS Physical Store being resized is disk0s2</span><br><span class="line">Verifying storage system</span><br><span class="line">Using live mode</span><br><span class="line">Performing fsck_apfs -n -x -l /dev/disk0s2</span><br><span class="line">Checking volume</span><br><span class="line">Checking the container superblock</span><br><span class="line">Checking the EFI jumpstart record</span><br><span class="line">Checking the space manager</span><br><span class="line">Checking the object map</span><br><span class="line">Checking the APFS volume superblock</span><br><span class="line">Checking the object map</span><br><span class="line">Checking the fsroot tree</span><br><span class="line">Checking the snapshot metadata tree</span><br><span class="line">Checking the extent ref tree</span><br><span class="line">Checking the snapshots</span><br><span class="line">Checking the APFS volume superblock</span><br><span class="line">Checking the object map</span><br><span class="line">Checking the fsroot tree</span><br><span class="line">Checking the snapshot metadata tree</span><br><span class="line">Checking the extent ref tree</span><br><span class="line">Checking the snapshots</span><br><span class="line">Checking the APFS volume superblock</span><br><span class="line">Checking the object map</span><br><span class="line">Checking the fsroot tree</span><br><span class="line">Checking the snapshot metadata tree</span><br><span class="line">Checking the extent ref tree</span><br><span class="line">Checking the snapshots</span><br><span class="line">Checking the APFS volume superblock</span><br><span class="line">Checking the object map</span><br><span class="line">Checking the fsroot tree</span><br><span class="line">Checking the snapshot metadata tree</span><br><span class="line">Checking the extent ref tree</span><br><span class="line">Checking the snapshots</span><br><span class="line">Verifying allocated space</span><br><span class="line">The volume /dev/disk0s2 appears to be OK</span><br><span class="line">Storage system check exit code is 0</span><br><span class="line">Growing APFS Physical Store disk0s2 from 201,357,041,664 to 210,007,728,128 bytes</span><br><span class="line">Modifying partition map</span><br><span class="line">Growing APFS data structures</span><br><span class="line">Finished APFS operation</span><br></pre></td></tr></table></figure><p>运行成功, 打分磁盘工具, 查看根卷分区, 发现8G空间分区已经被合并至APFS分区, 只剩下一个40G的bootcamp分区.</p><p>选择bootcamp分区, 点击减号, 应用成功. 成功将所有分区合并成一个完整大分区.</p><p>现在Mac只有一个分区了.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">╰─ diskutil list</span><br><span class="line">/dev/disk0 (internal):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      GUID_partition_scheme                         251.0 GB   disk0</span><br><span class="line">   1:                        EFI EFI                     314.6 MB   disk0s1</span><br><span class="line">   2:                 Apple_APFS Container disk1         250.7 GB   disk0s2</span><br><span class="line"></span><br><span class="line">/dev/disk1 (synthesized):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      APFS Container Scheme -                      +250.7 GB   disk1</span><br><span class="line">                                 Physical Store disk0s2</span><br><span class="line">   1:                APFS Volume Macintosh HD            168.9 GB   disk1s1</span><br><span class="line">   2:                APFS Volume Preboot                 22.7 MB    disk1s2</span><br><span class="line">   3:                APFS Volume Recovery                517.8 MB   disk1s3</span><br><span class="line">   4:                APFS Volume VM                      2.1 GB     disk1s4</span><br></pre></td></tr></table></figure><p>Done.</p><hr><p>参考: <a href="https://www.chadou.me/p/206" target="_blank" rel="noopener">BOOTCAMP 分区无法删除</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;bootcamp 无法删除 Windows 10分区&lt;/h1&gt;
&lt;p&gt;很久之前在Mac上使用bootcamp安装了windows10, Mac升级到10.13.4 High Sierra之后发现自己几乎没用过win10.
于是想删除bootcamp分区, 理想情况下使用
      
    
    </summary>
    
    
      <category term="Mac" scheme="http://mpwang.github.io/tags/Mac/"/>
    
  </entry>
  
  <entry>
    <title>如何使用sqlalchemy构造SQL语句</title>
    <link href="http://mpwang.github.io/2018/05/05/construct-sql/"/>
    <id>http://mpwang.github.io/2018/05/05/construct-sql/</id>
    <published>2018-05-05T10:14:23.000Z</published>
    <updated>2018-05-05T14:03:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>sqlalchemy作为ORM层工具可以方便地编程式操作数据库, 但有时与外部系统交互时需要生成raw sql语句, 利用sqlalchemy可能方便地动态构造成sql语句.</p><p>假设我们有两个类代表User, Address两张表.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'addresses'</span></span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    email_address = Column(String, nullable=<span class="keyword">False</span>)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">'users.id'</span>))</span><br><span class="line"></span><br><span class="line">    user = relationship(<span class="string">"User"</span>, lazy=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure><p>利用<code>Query</code>构造生需要的语句, 使用<code>compile</code><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>输出query代表的sql语句.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Query</span><br><span class="line"></span><br><span class="line">filters = &#123;<span class="string">'user_id'</span>: <span class="number">1</span>&#125;</span><br><span class="line">query = Query(Address).filter_by(**filters)</span><br><span class="line">query = query.statement.compile(compile_kwargs=&#123;<span class="string">'literal_binds'</span>: <span class="keyword">True</span>&#125;)</span><br><span class="line"><span class="keyword">print</span> query</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT addresses<span class="selector-class">.id</span>, addresses<span class="selector-class">.email_address</span>, addresses<span class="selector-class">.user_id</span>, users_1<span class="selector-class">.id</span>, users_1<span class="selector-class">.name</span>, users_1<span class="selector-class">.fullname</span>, users_1.password</span><br><span class="line">FROM addresses LEFT OUTER JOIN users AS users_1 ON users_1<span class="selector-class">.id</span> = addresses<span class="selector-class">.user_id</span> </span><br><span class="line">WHERE addresses<span class="selector-class">.user_id</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>注意输出中包含了<code>Address.user</code>字段代表的join操作, 如果不需要这些字段可以<code>lazyload</code><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>取消.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> lazyload</span><br><span class="line"></span><br><span class="line">filters = &#123;<span class="string">'user_id'</span>: <span class="number">1</span>&#125;</span><br><span class="line">query = Query(Address).filter_by(**filters)</span><br><span class="line">query = query.options(lazyload(<span class="string">'*'</span>))</span><br><span class="line">query = query.statement.compile(compile_kwargs=&#123;<span class="string">'literal_binds'</span>: <span class="keyword">True</span>&#125;)</span><br><span class="line"><span class="keyword">print</span> query</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT addresses<span class="selector-class">.id</span>, addresses<span class="selector-class">.email_address</span>, addresses.user_id</span><br><span class="line">FROM addresses </span><br><span class="line">WHERE addresses<span class="selector-class">.user_id</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="http://docs.sqlalchemy.org/en/latest/faq/sqlexpressions.html#how-do-i-render-sql-expressions-as-strings-possibly-with-bound-parameters-inlined" target="_blank" rel="noopener">How do I render SQL expressions as strings, possibly with bound parameters inlined?</a> <a href="#fnref1" class="footnote-backref">↩</a></p></li><li id="fn2" class="footnote-item"><p><a href="http://docs.sqlalchemy.org/en/latest/orm/loading_relationships.html#controlling-loading-via-options" target="_blank" rel="noopener">Controlling Loading via Options</a> <a href="#fnref2" class="footnote-backref">↩</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;sqlalchemy作为ORM层工具可以方便地编程式操作数据库, 但有时与外部系统交互时需要生成raw sql语句, 利用sqlalchemy可能方便地动态构造成sql语句.&lt;/p&gt;
&lt;p&gt;假设我们有两个类代表User, Address两张表.&lt;/p&gt;
&lt;figure cl
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
      <category term="SQLAlchemy" scheme="http://mpwang.github.io/tags/SQLAlchemy/"/>
    
  </entry>
  
  <entry>
    <title>Python项目入门培训文档</title>
    <link href="http://mpwang.github.io/2017/09/02/python-intro/"/>
    <id>http://mpwang.github.io/2017/09/02/python-intro/</id>
    <published>2017-09-01T16:42:02.000Z</published>
    <updated>2017-09-01T17:09:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1>Intro</h1><p>本篇文档是由近期给公司校招的新人（没有Python背景）准备的培训资料整理而来，学习计划以学员的自学为主。根据实践平均每周学员需要花费1-2天的时间，每周再加上一个小时跟踪和讲解相关内容。</p><p>教程并不是单纯的Python语言培训，侧重点在于让新人快速参与项目开发。</p><h1>Python学习计划</h1><h2>受众</h2><p>假定学员熟悉基本的编程概念，使用过Java/C/C++其中一门语言，有一定项目开发经验</p><h2>目标</h2><p>预计为期8周的阅读及学习计划，以完成每周设定的任务的方式引导学习Python语言以及相关开发知识，帮助学员进行Python项目开发</p><p>需要完成的任务包括：</p><ul><li>完成参考资料的阅读（扩展阅读不作要求）</li><li>完成一些具体的编程练习</li><li>阅读一些库的文档并编写例子初步掌握使用</li></ul><h2>进度反馈及跟踪</h2><p>每周会有例会跟踪进度，平时的反馈我们可以通过邮件交流</p><p>randall.wjz@gmail.com</p><h1>第1周 Intro</h1><h2>本周目标</h2><p>在开始学习Python语言的具体知识细节前了解一些背景知识，以及设置一个Python开发环境</p><h2>请完成以下材料的阅读</h2><h3>背景知识了解</h3><ol><li><p>简单的Python历史介绍</p><p><a href="https://www.15yan.com/story/1JKTBQvVk5e/" target="_blank" rel="noopener">人生苦短，我用Python</a></p></li><li><p>Python语言的设计哲学</p><ul><li><a href="https://www.python.org/dev/peps/pep-0020/" target="_blank" rel="noopener">The Zen of Python</a></li><li><a href="https://wiki.python.org/moin/PythonZenChineseTranslate" target="_blank" rel="noopener">中文翻译参考</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">The Zen of Python, by Tim Peters</span><br><span class="line"></span><br><span class="line">Beautiful is better than ugly.</span><br><span class="line">Explicit is better than implicit.</span><br><span class="line">Simple is better than complex.</span><br><span class="line">Complex is better than complicated.</span><br><span class="line">Flat is better than nested.</span><br><span class="line">Sparse is better than dense.</span><br><span class="line">Readability counts.</span><br><span class="line">Special cases aren&apos;t special enough to break the rules.</span><br><span class="line">Although practicality beats purity.</span><br><span class="line">Errors should never pass silently.</span><br><span class="line">Unless explicitly silenced.</span><br><span class="line">In the face of ambiguity, refuse the temptation to guess.</span><br><span class="line">There should be one-- and preferably only one --obvious way to do it.</span><br><span class="line">Although that way may not be obvious at first unless you&apos;re Dutch.</span><br><span class="line">Now is better than never.</span><br><span class="line">Although never is often better than right now.</span><br><span class="line">If the implementation is hard to explain, it&apos;s a bad idea.</span><br><span class="line">If the implementation is easy to explain, it may be a good idea.</span><br><span class="line">Namespaces are one honking great idea -- let&apos;s do more of those!</span><br></pre></td></tr></table></figure></li><li><p>Python社区</p><ul><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/intro/community.html" target="_blank" rel="noopener">社区</a></li><li>PEP，中文翻译为Python增强提议。这个词经常在Python学习过程中看到，了解什么是PEP</li><li>PSF，Python Software Foundation, Python软件基金会</li><li>PyCon,每年社区举办的Python开发者大会，youtube上可以找到与会演讲视频</li></ul></li><li><p>了解Python2和Python3的现状</p><ul><li><a href="https://wiki.python.org/moin/Python2orPython3" target="_blank" rel="noopener">Should I use Python 2 or Python 3 for my developmentactivity?</a></li><li>Python2版本将于2020年正式停止更新维护，Python语言的未来以及最新改进在Python3版本上进行</li><li>新项目应该默认使用Python3进行开发</li><li>现存的大量项目以及第三库使用Python2版本，流行的Python库大多兼容Python2/3版本</li><li>目前公司的项目使用Python2版本</li></ul></li></ol><h3>编程环境设置</h3><ol><li><p>选择Python解释器</p><p><a href="https://python-guide-pt-br.readthedocs.io/en/latest/starting/which-python/" target="_blank" rel="noopener">Picking anInterpreter</a></p></li><li><p>安装Python</p><p><a href="https://python-guide-pt-br.readthedocs.io/en/latest/starting/installation/" target="_blank" rel="noopener">Properly InstallingPython</a></p></li><li><p>了解pip</p><p>Python的包管理工具，类比Java语言的Maven工具</p><ul><li><a href="https://xin053.github.io/2016/07/02/pip%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">pip包管理器使用详解</a></li><li><a href="https://pip-cn.readthedocs.io/en/latest/quickstart.html" target="_blank" rel="noopener">文档</a></li></ul></li><li><p>IDE &amp; Editor</p><p>项目组使用PyCharm进行Python开发，请下载安装并熟悉使用</p><ul><li><a href="http://www.jianshu.com/p/259fdc97bfe2" target="_blank" rel="noopener">介绍</a></li><li><a href="https://www.jetbrains.com/pycharm/" target="_blank" rel="noopener">官网</a></li></ul><p>前端项目使用VS Code作为开发环境</p><ul><li><a href="https://jeasonstudio.gitbooks.io/vscode-cn-doc/content/md/%E7%BC%96%E8%BE%91%E5%99%A8/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E7%94%A8VSCode.html" target="_blank" rel="noopener">Why Visual Studio Code? -为什么选用VSCode</a></li><li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">官网</a></li></ul></li></ol><h1>编程练习</h1><ul><li>在本地安装设置好Python2.7开发环境</li><li>使用pip安装requests库，<a href="http://docs.python-requests.org/en/master/user/install/" target="_blank" rel="noopener">参考资料</a></li><li>安装并设置好PyCharm</li><li>使用PyCharm建立项目，编写程序使用requests使用GET请求访问<a href="http://www.bing.com" target="_blank" rel="noopener">http://www.bing.com</a>并输出内容，<a href="http://docs.python-requests.org/en/master/user/quickstart/#make-a-request" target="_blank" rel="noopener">参考资料</a></li></ul><h2>扩展阅读</h2><ul><li><a href="http://py3readiness.org/" target="_blank" rel="noopener">Python流行的第三方库支持Python3的情况</a></li><li>前端项目使用<a href="https://standardjs.com/readme-zhcn.html" target="_blank" rel="noopener">JavaScript StandardStyle</a> 作为代码风格标准</li><li><a href="https://pythonclock.org/" target="_blank" rel="noopener">pythonclock</a></li></ul><h1>第2周 开始Python学习</h1><h2>本周目标</h2><p>本周将进行为期三周的Python语言学习，每周将指定的一些练习题目，请尝试完成（来源于PythonKoan项目）。</p><p>阅读材料中将列出一些参考的Python学习教程，学员会有比较充足的时间进行自由的学习。</p><h2>Python Koan项目</h2><p>PythonKoan是通过TDD进行Python学习的一个项目，<a href="https://github.com/gregmalcolm/python_koans" target="_blank" rel="noopener">项目地址</a>请下载并按照文档设置，注意我们使用python2文件夹下的代码</p><p>每个题目都关于Python语言的一个特性，完成题目可以帮助掌握这个特性。如遇到题目涉及到的教程中没有提及的概念，可以跳过。 <a href="https://github.com/sourabhv/python-koans-solutions/tree/master/python3/koans" target="_blank" rel="noopener">Python Koan答案参考</a>（注意此答案使用Python3版本）</p><h2>阅读材料</h2><h3>快速入门</h3><ul><li><a href="https://stephensugden.com/crash_into_python/" target="_blank" rel="noopener">写给有经验程序员的Python入门教程</a>快速了解Python特性</li><li><a href="https://dzone.com/refcardz/core-python" target="_blank" rel="noopener">Python 核心特性</a> Section1-11</li></ul><h3>请完成以下教程</h3><ul><li><a href="https://pymbook.readthedocs.io/en/py2/" target="_blank" rel="noopener">Welcome to Python for you andme</a> （比较简洁，PEP8Guidelines，Virtualenv及之后章节可跳过)</li></ul><h2>编程练习 | 本周的Python Koan题目</h2><ul><li>about~asserts~.py</li><li>about~strings~.py</li><li>about~none~.py</li><li>about~lists~.py</li><li>about~listassignments~.py</li><li>about~dictionaries~.py</li><li>about~stringmanipulation~.py</li><li>about~tuples~.py</li><li>about~methods~.py</li><li>about~controlstatements~.py</li><li>about~trueandfalse~.py</li><li>about~sets~.py</li></ul><h1>第3周 继续Python Koan题目</h1><h2>本周目标</h2><h2>阅读材料</h2><h3>请完成以下教程</h3><ul><li><a href="https://docs.python.org/2.7/tutorial/index.html" target="_blank" rel="noopener">Python官方入门教程</a>(阅读2-9章节即可)</li></ul><h2>编程练习 | 本周的Python Koan题目</h2><ul><li>about~triangleproject~.py</li><li>about~exceptions~.py</li><li>about~triangleproject2~.py</li><li>about~iteration~.py</li><li>about~comprehension~.py</li><li>about~generators~.py</li><li>about~lambdas~.py</li><li>about~scoringproject~.py</li><li>about~classes~.py</li><li>about~newstyleclasses~.py</li><li>about~withstatements~.py</li><li>about~monkeypatching~.py</li><li>about~diceproject~.py</li><li>about~methodbindings~.py</li></ul><h1>第4周 decorator and context manager</h1><h2>本周目标</h2><p>相信大家对编程语言中的基于数据和基于函数的抽象都不陌生，现在来看一下Python对于基于语法的抽象的支持。</p><ul><li>了解Python中装饰器(decorator)的概念</li><li>了解Python中上下文管理器(context manager)的概念</li></ul><h2>阅读材料</h2><ul><li><a href="https://www.cnblogs.com/vamei/archive/2013/02/16/2820212.html" target="_blank" rel="noopener">装饰器</a>简短介绍</li><li><a href="https://www.thecodeship.com/patterns/guide-to-python-function-decorators/" target="_blank" rel="noopener">A guide to Python's functiondecorators</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/11/23/2772445.html" target="_blank" rel="noopener">上下文管理器</a>简短介绍</li><li><a href="http://arnavk.com/posts/python-context-managers/" target="_blank" rel="noopener">Python in the real world: ContextManagers</a></li></ul><h2>编程练习 | 本周的Python Koan题目</h2><ul><li>about~decoratingwithfunctions~.py</li><li>about~decoratingwithclasses~.py</li><li>about~inheritance~.py</li><li>about~multipleinheritance~.py</li><li>about~scope~.py</li><li>about~modules~.py</li><li>about~packages~.py</li><li>about~classattributes~.py</li><li>about~attributeaccess~.py</li><li>about~deletingobjects~.py</li><li>about~proxyobjectproject~.py</li><li>about~proxyobjectproject~.py</li><li>about~extracredit~.py</li><li>about~regex~.py</li></ul><h2>扩展阅读</h2><ul><li><a href="https://pymotw.com/2/contextlib/" target="_blank" rel="noopener">标准库中的context manager工具</a></li></ul><h2>参考书目</h2><p>学习了两个教程之后对Python语言已经有大致的了解，接下来如果需要深入学习，建议找一些严肃的书籍进行系统性的学习。</p><ul><li><a href="http://fwww.pythonbooks.org" target="_blank" rel="noopener">python books</a></li><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/intro/learning.html" target="_blank" rel="noopener">学习Python</a>资源</li><li><a href="https://www.fullstackpython.com/best-python-resources.html" target="_blank" rel="noopener">Best PythonResources</a>Full Stack Python 本身也是很好的学习资源</li></ul><h1>第5周 编程风格与命令行开发</h1><h2>本周目标</h2><p>了解Python编程风格及命令行开发工具.</p><p>Python code style 业界现在有两个标准，PEP8 以及 <a href="https://google.github.io/styleguide/pyguide.html" target="_blank" rel="noopener">Google Python StyleGuide</a>项目组采用PEP8标准，对于Google Style可以稍作了解</p><p>除了日常在IDE里进行Python开发，开发人员也应该掌握一些在命令行环境下进行编程和debug的技能</p><h2>阅读材料</h2><ul><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/writing/style.html" target="_blank" rel="noopener">代码风格</a><a href="http://docs.python-guide.org/en/latest/writing/style/" target="_blank" rel="noopener">英文版</a></li><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/dev/virtualenvs.html" target="_blank" rel="noopener">虚拟环境</a>virtualenv</li><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/dev/pip-virtualenv.html" target="_blank" rel="noopener">Pip和Virtualenv的更多配置</a></li><li><a href="http://pep8.org/" target="_blank" rel="noopener">PEP8</a>建议阅读这个美化过的排版，<a href="https://www.python.org/dev/peps/pep-0008/" target="_blank" rel="noopener">原版</a>地址</li><li><a href="https://github.com/google/yapf" target="_blank" rel="noopener">yapf</a> Google出品的自动化格式代码工具，建议了解一下</li></ul><h3>ipython</h3><ul><li><p><a href="https://ipython.org/" target="_blank" rel="noopener">官网</a></p></li><li><p>作为一个交互式shell, 用来代替默认的python命令行编程环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用以下命令安装python2.7版本的ipython</span><br><span class="line">pip install &apos;ipython&lt;=6.0.0&apos;</span><br></pre></td></tr></table></figure></li></ul><h3>pdb</h3><p>Python debuger, 交互式debug环境。类似于GDB</p><ul><li><a href="https://pymotw.com/2/pdb/index.html" target="_blank" rel="noopener">使用教程</a></li></ul><h3>vim</h3><p>命令行环境下的编辑器</p><ul><li><a href="http://www.openvim.com/" target="_blank" rel="noopener">交互式的VIM简短教程</a>十分炫酷的简短教程，掌握日常用到的最基本操作</li></ul><h2>编程练习</h2><p>本周没有具体的编程练习，请花一点时间熟悉一下pip/virtualenv/ipython/pdb/vim工具。</p><p>编辑器/IDE是非常重要的工具，在工作过程中几乎所有的开发时间都花这上面，所以不论你喜欢vim/emacs/vs code/atom/sublimetext，你应该熟悉你的编程器/IDE。花些时间去了解 你喜欢的编程器/IDE</p><p>适当设置好开发环境对于提高开发效率也相当重要，有兴趣可以了解一下扩展阅读里列出的工具</p><h2>扩展阅读</h2><ul><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/dev/env.html" target="_blank" rel="noopener">你的开发环境</a><a href="http://docs.python-guide.org/en/latest/dev/env/" target="_blank" rel="noopener">英文版</a></li><li><a href="https://aaaaaashu.gitbooks.io/mac-dev-setup/content/index.html" target="_blank" rel="noopener">Mac开发配置手册</a></li></ul><h3>windows开发环境</h3><p>个人推荐 Cygwin + ConEmu + zsh + oh-my-shell + CoreUtils</p><ul><li><a href="https://cygwin.com/install.html" target="_blank" rel="noopener">Cygwin</a></li><li><a href="https://conemu.github.io/" target="_blank" rel="noopener">ConEmu</a></li><li><a href="http://www.jeffjade.com/2015/07/29/2015-07-29-mac-musthave-software/" target="_blank" rel="noopener">终极Shell</a>在Cygwin环境中也可以使用zsh + oh-my-zsh</li><li><a href="http://gnuwin32.sourceforge.net/packages/coreutils.htm" target="_blank" rel="noopener">CoreUtils forWindows</a>常用的liunx命令windows移植</li><li><a href="http://www.jianshu.com/p/aa19380828bd" target="_blank" rel="noopener">配置豪华的 Windows 开发环境</a></li></ul><h1>第6周 标准库及其它</h1><h2>本周目标</h2><p>大概了解下Python标准库, 一些第三库/框架</p><h2>阅读材料</h2><h3>标准库</h3><ul><li><a href="https://www.cnblogs.com/vamei/archive/2012/07/18/2597212.html" target="_blank" rel="noopener">Python标准库——走马观花</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/08/31/2661870.html" target="_blank" rel="noopener">Python标准库01 正则表达式(re包)</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/09/05/2671198.html" target="_blank" rel="noopener">Python标准库03 路径与文件 (os.path包,glob包)</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/09/14/2684775.html" target="_blank" rel="noopener">Python标准库04 文件管理(部分os包，shutil包)</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/09/23/2698014.html" target="_blank" rel="noopener">Python标准库06 子进程(subprocess包)</a></li><li><a href="https://www.cnblogs.com/vamei/archive/2012/10/11/2720042.html" target="_blank" rel="noopener">Python标准库08 多线程与同步(threading包)</a></li></ul><h3>常用库</h3><ol><li><p>Oslo</p><p>Oslo是由openstack项目衍生出来的一系列python库，为openstack众多项目提供统一的公共功能。</p><blockquote><p>To produce a set of python libraries containing code shared byOpenStack projects. The APIs provided by these libraries should behigh quality, stable, consistent, documented and generallyapplicable</p></blockquote><ul><li><a href="https://wiki.openstack.org/wiki/Oslo" target="_blank" rel="noopener">官方Wiki Oslo库列表</a></li></ul><p>阅读使用和配置文档，大概了解这些包是用做什么的即可。</p><ul><li>oslo.cache</li><li>oslo.concurrency</li><li>oslo.config</li><li>oslo.log</li><li>oslo.policy</li><li>pbr</li></ul></li><li><p>SQLAlchemy</p><p>SQLAlchemy 是一个连接数据库的ORM框架 大概了解 SQLAlchemy的简单使用方式，不要求深入了解</p><ul><li><a href="https://www.sqlalchemy.org/" target="_blank" rel="noopener">官网</a></li><li><a href="http://www.jianshu.com/p/e6bba189fcbd" target="_blank" rel="noopener">简单介绍</a></li><li><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0014021031294178f993c85204e4d1b81ab032070641ce5000" target="_blank" rel="noopener">简单使用教程</a></li></ul></li></ol><h1>第7周 开源工具</h1><h2>本周目标</h2><p>了解一些开源工具及项目开发协作相关工具</p><p>由于列出的工具较多，不要求深入了解</p><h2>阅读材料</h2><h3>Markdown</h3><p><a href="https://www.fullstackpython.com/markdown.html" target="_blank" rel="noopener">Markdown语法</a>平时写文档时可以使用Markdown语法</p><p>示例网站 <a href="https://maxiang.io/" target="_blank" rel="noopener">https://maxiang.io/</a>可以看到左边为文本内容，右边为渲染后的效果。使用markdown语法，书写文档时不需要关心排版效果，可以专注于内容本身。</p><h3>Git &amp;&amp; Gerrit</h3><p>项目组使用Git进行代码版本管理，使用Git是一项必备技能。如果以前没有使用Git的经验，请务必花一些时间学习。</p><ul><li><a href="https://github.com/larrycai/sdcamp/blob/master/contents/1-chapter2-git-gerrit.markdown" target="_blank" rel="noopener">版本控制Git和代码审阅Gerrit</a></li><li><a href="https://lvwzhen.gitbooks.io/git-tutorial/content/" target="_blank" rel="noopener">Git教程</a></li><li><a href="https://gerrit-review.googlesource.com/Documentation/intro-quick.html" target="_blank" rel="noopener">Gerrit Code Review - A QuickIntroduction</a></li></ul><h3>Jenkins &amp;&amp; CI</h3><ul><li><a href="https://gwpost.gitbooks.io/jenkins-the-definitive-guide/content/Introducting%20Jenkins/jie_shao.html" target="_blank" rel="noopener">Jenkins与持续集成(CI)介绍</a></li></ul><h3>tox</h3><ul><li><a href="http://wsfdl.com/python/2015/02/01/Python%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B9%8BTox.html" target="_blank" rel="noopener">Python 的单元测试之tox</a></li><li><a href="https://tox.readthedocs.io/en/latest/" target="_blank" rel="noopener">tox官网介绍</a></li></ul><h3>运维利器 Ansible</h3><p>自动化运维工具，可以稍作了解，日常工作中可能会用到ansible工具来批量运行脚本</p><ul><li><a href="http://www.stay-stupid.com/?p=366" target="_blank" rel="noopener">Ansible 简介</a>阅读简介至ad-hoc部分即可</li><li><a href="https://ansible-tran.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">Ansible中文权威指南</a>如果有兴趣深入了解</li></ul><h1>第8周 实战</h1><h2>本周目标</h2><p>本周为编程练习，创建一个Python项目，并编程完成要求</p><p>这个项目是完成一个命令行工具，可以通过命令行调用来完成数据库表的CUDR操作</p><h2>编程练习</h2><h3>申请虚拟机作为开发机，要求CentOS7.2系统</h3><h3>配置pip文件</h3><h3>安装并配置PostgreSQL数据库</h3><p>tips: 可以使用 NaviCat pgAdmin 等数据库管理工具</p><p>配置数据库密码为 test123456</p><p>创建database, 名称: cudr</p><p>在 cudr 新建表，表名example</p><p>创建 sql 如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &quot;public&quot;.&quot;example&quot;;</span><br><span class="line">CREATE TABLE &quot;public&quot;.&quot;example&quot; (</span><br><span class="line">&quot;name&quot; varchar(127) COLLATE &quot;default&quot; NOT NULL,</span><br><span class="line">&quot;code&quot; varchar(63) COLLATE &quot;default&quot; NOT NULL</span><br><span class="line">)</span><br><span class="line">WITH (OIDS=FALSE)</span><br><span class="line">;</span><br><span class="line">ALTER TABLE &quot;public&quot;.&quot;example&quot; ADD PRIMARY KEY (&quot;name&quot;);</span><br></pre></td></tr></table></figure><h3>创建一个Python项目</h3><p>项目名称 cudr</p><p>项目结构请阅读<a href="https://pythonguidecn.readthedocs.io/zh/latest/writing/structure.html" target="_blank" rel="noopener">结构化你的工程</a>中仓库的结构一节，关于 Django Applications及之后的章节可跳过</p><p>在 requirements.txt 文件中指定项目依赖库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlalchemy</span><br><span class="line">click</span><br></pre></td></tr></table></figure><p>使用pip安装依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><ol><li><p>click 用于创建命令行工具</p><ul><li><a href="http://click.pocoo.org/5/" target="_blank" rel="noopener">官网</a></li><li><a href="http://www.jianshu.com/p/d2b61a892c32" target="_blank" rel="noopener">简单使用教程</a></li></ul></li><li><p>sqlalchemy 数据库ORM工具</p></li></ol><h3>编程</h3><p>在 cudr/core.py 中完成具体的代码工作</p><p>具体代码实现以及命令行使用参数的设计可以自由发挥</p><p>最终效果要求可以完成类似以下功能(不要求和下面示例代码中一样)</p><ul><li>创建</li><li>读取</li><li>修改</li><li>删除</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个数据库记录</span><br><span class="line">python core.py --create name1 code1</span><br><span class="line"># 读取</span><br><span class="line">python core.py --read name1</span><br><span class="line"># 修改 指定主键name1及更新的字段及字段的新值</span><br><span class="line">python core.py --update name1 name=name2</span><br><span class="line"># 删除</span><br><span class="line">python core.py --delete name2</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;Intro&lt;/h1&gt;
&lt;p&gt;本篇文档是由近期给公司校招的新人（没有Python背景）准备的培训资料整理而来，学习计
划以学员的自学为主。根据实践平均每周学员需要花费1-2天的时间，每周再加上一个小时
跟踪和讲解相关内容。&lt;/p&gt;
&lt;p&gt;教程并不是单纯的Python语言培训
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
      <category term="Tutorial" scheme="http://mpwang.github.io/tags/Tutorial/"/>
    
  </entry>
  
  <entry>
    <title>Python重构代码的一些模式</title>
    <link href="http://mpwang.github.io/2017/08/26/python-refactor-patterns/"/>
    <id>http://mpwang.github.io/2017/08/26/python-refactor-patterns/</id>
    <published>2017-08-26T14:02:56.000Z</published>
    <updated>2017-08-30T01:44:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>以下介绍一些<code>python idiom</code>，每当你在代码库中看到以下的模式可以参照以下的建议进行重构，让代码变得更加的<code>pythonic</code>，可读性更好，更容易维护。</p><p>代码示例Python版本为2.7</p><h1>enumerate</h1><blockquote class="blockquote-center"><p>需要使用列表的下标时，不要使用C风格的下标遍历</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lst = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> lst:</span><br><span class="line">    <span class="keyword">print</span> i, <span class="string">'--&gt;'</span>, lst[i]</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(lst)):</span><br><span class="line">    <span class="keyword">print</span> i, <span class="string">'--&gt;'</span>, lst[i]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line"><span class="keyword">for</span> idx, item <span class="keyword">in</span> enumerate(lst):</span><br><span class="line">    <span class="keyword">print</span> idx, <span class="string">'--&gt;'</span>, item</span><br></pre></td></tr></table></figure><h1>zip/izip</h1><blockquote class="blockquote-center"><p>同时遍历两个列表时，不要使用C风格的下标遍历</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lst1 = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line">lst2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(lst1)):</span><br><span class="line">    <span class="keyword">print</span> lst1[i]</span><br><span class="line">    <span class="keyword">print</span> lst2[i]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line"><span class="keyword">for</span> lst1_item, lst2_item <span class="keyword">in</span> zip(lst1, lst2):</span><br><span class="line">    <span class="keyword">print</span> lst1_item</span><br><span class="line">    <span class="keyword">print</span> lst2_item</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BETTER</span></span><br><span class="line"><span class="comment"># 不需要在内存中生成包含lst, lst2的第三个列表</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> izip</span><br><span class="line"><span class="keyword">for</span> lst1_item, lst2_item <span class="keyword">in</span> izip(lst1, lst2):</span><br><span class="line">    <span class="keyword">print</span> lst1_item</span><br><span class="line">    <span class="keyword">print</span> lst2_item</span><br></pre></td></tr></table></figure><h1>unpacking tuple</h1><h2>swap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line">y = <span class="number">-10</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line">tmp = x</span><br><span class="line">x = y</span><br><span class="line">y = tmp</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line">x, y = y, x</span><br></pre></td></tr></table></figure><h2>get element from tuple</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">words = [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cat'</span>]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line">foo = words[<span class="number">0</span>]</span><br><span class="line">bar = words[<span class="number">1</span>]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line">foo, bar, _ = words <span class="comment"># 使用 _ 如果你不需要这个值</span></span><br></pre></td></tr></table></figure><h1>Dict.setdefault/defaultdict</h1><blockquote class="blockquote-center"><p>处理字典中key不存在时的默认值</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># group words by frequency</span></span><br><span class="line">words = [(<span class="number">1</span>, <span class="string">'apple'</span>), (<span class="number">2</span>, <span class="string">'banana'</span>), (<span class="number">1</span>, <span class="string">'cat'</span>)]</span><br><span class="line">frequency = &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    <span class="keyword">if</span> freq <span class="keyword">not</span> <span class="keyword">in</span> frequency:</span><br><span class="line">        frequency[freq] = []</span><br><span class="line">    frequency[freq].append(word)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    frequency.setdefault(freq, []).append(word)</span><br></pre></td></tr></table></figure><p>如果你知道自己在做什么，use <a href="https://docs.python.org/2/library/collections.html#collections.defaultdict" target="_blank" rel="noopener">defaultdict</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BETTER</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line">frequency = defaultdict(list)</span><br><span class="line"><span class="keyword">for</span> freq, word <span class="keyword">in</span> words:</span><br><span class="line">    frequency[freq].append(word)</span><br></pre></td></tr></table></figure><h1>Dict.iteritems</h1><blockquote class="blockquote-center"><p>遍历字典</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">words = &#123;<span class="string">'apple'</span>: <span class="number">1</span>, <span class="string">'banana'</span>: <span class="number">2</span>, <span class="string">'cat'</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OK</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">    <span class="keyword">print</span> word, <span class="string">'--&gt;'</span>, words[word] <span class="comment"># 需要计算word的hash值</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GOOD</span></span><br><span class="line"><span class="keyword">for</span> word, freq <span class="keyword">in</span> words.items():</span><br><span class="line">    <span class="keyword">print</span> word, <span class="string">'--&gt;'</span>, freq</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BETTER</span></span><br><span class="line"><span class="comment"># 不需要在内存中生存包含words所有元素的中间结果</span></span><br><span class="line"><span class="keyword">for</span> word, freq <span class="keyword">in</span> words.iteritems():</span><br><span class="line">    <span class="keyword">print</span> word, <span class="string">'--&gt;'</span>, freq</span><br></pre></td></tr></table></figure><h1>for...else</h1><blockquote class="blockquote-center"><p>break and nobreak</p></blockquote><p>使用<code>for...else</code>模式处理遍历列表时搜索符合某些条件的元素<code>break</code>以及搜索不到符合条件元素时的情况。</p><p>有些人会认为<code>for...else</code>的语义让人迷惑所以不建议使用，但是正确地使用<code>for...else</code>模式会让代码的结构更加清晰。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># search if a word match some condition exists</span></span><br><span class="line">words = [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cat'</span>]</span><br><span class="line">condition = <span class="keyword">lambda</span> word: len(word) == <span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DON'T</span></span><br><span class="line">found = <span class="keyword">False</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">    <span class="keyword">if</span> condition(word):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Found'</span></span><br><span class="line">        found = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> found:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Not found'</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DO</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">    <span class="keyword">if</span> condition(word):</span><br><span class="line">        <span class="comment"># 处理存在符合condition的元素的情况</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Found'</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 处理没有符合condition元素的情况</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Not found'</span></span><br></pre></td></tr></table></figure><p><code>else</code>在<code>for...else</code>语法里的语义是<code>如果没有break发生</code>，也即是列表被完全遍历的情况。代码清晰地分成了两部分，你可以明确地看到他们属于同一个结构。</p><p><code>for...else</code>语法让人迷惑的地方就是在于<code>else</code>这个名字，根据python核心开发者Raymond Hettinger的说法，如果他们有机会回到过去修改这一语法的话，他们会将<code>else</code>修改为<code>nobreak</code>。</p><p>事实上如果不需要处理搜索到符合condition元素时的情况，只需要检查符合condition元素是否存在时，使用<code>any</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">existed = any(map(condition, words))</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> existed:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Not found'</span></span><br></pre></td></tr></table></figure><h1>try...except...else</h1><blockquote class="blockquote-center"><p>分开异常处理与正常情况</p></blockquote><p><code>try...except</code>语法大家都不陌生，大多数情况下简单地使用地<code>try...except...else</code>语法将臃肿的try block重构就可以让代码的结构更加清晰，将异常处理和正常情况清晰地区分开来。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_external_json</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"maybe valid json, maybe some plain text of error"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_with</span><span class="params">(result)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_error</span><span class="params">(e)</span>:</span></span><br><span class="line">    <span class="comment"># maybe log exception trace</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Oops'</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GOOD</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = json.loads(get_external_json())</span><br><span class="line">    do_something_with(result)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    handle_error(e)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BETTER</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 异常可能抛出点</span></span><br><span class="line">    result = json.loads(get_external_json())</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 异常处理</span></span><br><span class="line">    handle_error(e)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 正常情况</span></span><br><span class="line">    do_something_with(result)</span><br></pre></td></tr></table></figure><p><code>try...except...else</code>这个结构清晰地区分了异常可能的抛出点，异常处理及正常情况三种情况。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;以下介绍一些&lt;code&gt;python idiom&lt;/code&gt;，每当你在代码库中看到以下的模式可以参照以下的建议进行重构，让代码变得更加的&lt;code&gt;pythonic&lt;/code&gt;，可读性更好，更容易维护。&lt;/p&gt;
&lt;p&gt;代码示例Python版本为2.7&lt;/p&gt;
&lt;h1&gt;
      
    
    </summary>
    
    
      <category term="Python" scheme="http://mpwang.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Emacs: 编辑代码与工作效率</title>
    <link href="http://mpwang.github.io/2014/11/12/emcas-and-productivity/"/>
    <id>http://mpwang.github.io/2014/11/12/emcas-and-productivity/</id>
    <published>2014-11-11T16:00:00.000Z</published>
    <updated>2017-08-27T09:17:51.000Z</updated>
    
    <content type="html"><![CDATA[<h1>硬件</h1><blockquote class="blockquote-center"><p>投资硬件是最简单直接的提高工作效率的方法</p></blockquote><p>屏幕与键鼠是程序员与电脑之间的输出输入设置，是程序员每天工作接触时间最长的东西，硬件上的提升可以直接提高工作效率以及每天工作的心情。</p><h2>键盘的选择</h2><blockquote><p><a href="http://xahlee.info/kbd/keyboard_switch_mechanisms.html" target="_blank" rel="noopener">认识薄膜键盘，机械键盘与静电电容键盘</a></p></blockquote><h3>不差钱直接上静电电容键盘</h3><h3>机械键盘</h3><blockquote><p><a href="http://www.zhihu.com/question/23105050" target="_blank" rel="noopener">先说结论：只选红轴。</a></p></blockquote><p>键盘这东西最好一步到位一发退烧，不需要反复投入。就机械键盘说来，</p><ul><li>红轴与黑轴无冲，适合游戏玩家，不同的是按到底所需的力度红轴较小黑轴较大</li><li>茶轴与青轴敲击有段落感适合程序员与打字員，青轴所需力度较小但是声音比较吵，茶轴是最多人选择的键芯。综上选择茶轴机械键盘使用，然后可以考虑转向红轴。最重要的是实际试用自己最符合自己的手感</li></ul><h3>人体工程学键盘</h3><p>人体工程学键盘的选择见仁见智</p><h3>HHKB(Happy Hacking Keyboard)</h3><p>HHKB吹有很多，盲目买HHKB的更多。不引战，只说个人观点：<strong>HHKB不适合重度Emacs用户</strong></p><h3>键盘布局的选择</h3><p>市面上一般键盘所用的都是qwert布局的键盘，虽然有数据表示<a href="https://www.cnblogs.com/zhangshenjia/archive/2012/04/11/qwerty_dvorak_colemak.html" target="_blank" rel="noopener">dvorak布局</a>可以提高输入效率以及减少手指疲劳，但是较高的上手难度以及训练过渡期间几乎让你不会打字的痛苦都是使用dvorak布局的成本，而且不见得在你掌握新布局之后打字效率会有多大的提升。</p><p>作为程序员打字的速度并不是瓶颈，思考速度才是瓶颈，老老实实使用qwert布局就足够了。</p><h2>多屏幕</h2><p><a href="http://www.techug.com/post/programmer-mult-monitors.html" target="_blank" rel="noopener">多个显示器可以提高程序员的工作效率</a>，减少切换屏幕带来的上下文切换。从一家公司是否给员工配置多个显示器可以看出公司是否尊重程序员的工作。</p><p>无脑地使用两个显示器即可提高工作效率，你可能还需要屏幕支架。</p><h2>使用轨迹球，避免鼠标手</h2><p>Logitech M570 聊胜于无</p><h1>选择正确的编程字体</h1><p>windows 下自带的的 Consolas 以及 Mac 下自带的 Monaco 是不错的选择</p><p>英文的等宽字体: <a href="https://be5invis.github.io/Iosevka/" target="_blank" rel="noopener">Iosevka</a>, <a href="https://sourcefoundry.org/hack/" target="_blank" rel="noopener">Hack</a>, <a href="https://adobe-fonts.github.io/source-code-pro/" target="_blank" rel="noopener">Source Code Pro</a></p><p>中文的等宽字体: 文泉驿等宽微米黑, 微软雅黑</p><p>好多人还在使用Windows系统默认的字体，那效果用来看代码实在是惨不忍睹。一旦选择了任一个编程字体，只要15分钟，你几乎不可能还会用回默认的Courier New字体。</p><h2>Emacs中文与英文对齐</h2><p><a href="https://github.com/tumashu/cnfonts" target="_blank" rel="noopener">chinese-fonts-setup</a> 分别设置Emacs显示中英文时使用不同的字体和大小，帮助你对齐中英文，在我看来在写org文档时这是一个必备的扩展。在使用org-mode table对齐时特别有用。</p><h1>编辑器: Emacs</h1><blockquote class="blockquote-center"><p>Why it's worth to learn emacs, because the experience will not go away</p></blockquote><p>Emacs的学习曲线是比较陡峭，但是长期来说投资在Emacs上的时间是值得的。逻辑非常简单：</p><ul><li>程序员的工作需要进行大量的文本编辑工作</li><li>Emacs是非常强大的文本编辑器</li><li>所以Emacs可以提高程序员的工作效率</li></ul><h2>key binding</h2><p>当你在命令行界面使用bash时，你熟悉的<code>ctrl+a</code>跳至行首, <code>ctrl+e</code>跳至行末等快捷键其实就是来源于Emacs，事实上你使用的是bash依赖的<a href="https://cnswww.cns.cwru.edu/php/chet/readline/rluserman.html" target="_blank" rel="noopener">GNU readline</a>的默认emacs mode。</p><p>Mac OS下的cocoa应用默认有emacs按键绑定，你用发现在Mac下使用emacs按键绑定是很自然的事情。</p><p>大多数流行的IDE(Eclipse/JetBrains系列/VS Code)都可以设置为 emacs 布局的按键绑定。</p><p>熟悉了 emacs 的基本操作快捷键组合后很多地方都可以用得上。</p><h2>Emacs的编辑哲学</h2><p>为什么学习Emacs可以带来好处，因为Emacs会让你对于编辑文本的思考方式不再是基于字符的方法，取而代之的是逻辑上的<code>编辑动作</code>。</p><p>从最基本的两个命令（<code>M-x</code>调用命令，<code>ctrl+h</code>查找帮助）开始，你对于日常编辑文本的需求都会变成命令式的。</p><h3>例子</h3><p>排序，选中需要编辑的行，<code>M-x sort-lines</code>.</p><p>消除行末多余的空格，选中需要编辑的行，<code>M-x whitespace-cleanup</code>.</p><p>光标的移动，字符的删除不再是右移一个字符，删除一个字符。使用<code>ctrl</code>键组合进行基于字符的移动和删除，使用<code>meta</code>键组合进行基于词语的移动和删除。</p><ul><li><code>ctrl-f</code>右移一个字符 <code>meta-f</code>右移一个词语</li><li><code>ctrl-d</code>删除一个字符 <code>meta-d</code>删除一个词语</li></ul><p>文件内的跳转不再是基于上下左右移动光标，使用<code>ace-jump-mode</code>或者<code>avy-mode</code>你可以快速将光标定位于你想要跳转到的单词。</p><p><img src="/images/avy-goto-char.png" alt="jumping around"></p><h3>showcases</h3><p>想到知道 emacs 在日常的编辑文本工作中可以有多用。<a href="http://emacsrocks.com/" target="_blank" rel="noopener">Emacs Rocks</a>的一系列简短视频可以告诉你。掌握其中一些技巧可以让你在几秒钟内完成你之前也许需要用分钟来计算的任务。</p><h3>秘密武器：emacs lisp</h3><p>原生的emacs也许是很好，但是还不够好。Emacs的秘密在于它的扩展可以使用emacs lisp编程语言来写，Emacs 本身相当于emacs lisp的运行环境和解析器。</p><p>emacs lisp是一门完善的编程语言，所以程序员们可以方便地编写扩展来集成调用第三方的应用，也许是一个web api也许是一个命令行工具，然后提供给emacs使用。emacs用户可以方便的使用<code>M-x</code>进行调用，相当于将复杂的编辑需求抽象成一个<code>编辑动作</code>。</p><h3>杀手级应用</h3><p>emacs的用户群体已经超出了程序员的范围，现在有许多作家以及科学写作者都开始使用emacs，这些都是emacs的 <a href="http://orgmode.org/" target="_blank" rel="noopener">org-mode</a> 带来。简单的说来org-mode是一个使用emacs来写笔记的扩展，使用一种类似于markdown的语法。</p><p>我自己使用org-mode来组织笔记，编写内容然后生成<a href="https://github.com/fniessen/org-html-themes" target="_blank" rel="noopener">类似readthedocs风格的文档</a>，编写内容然后<a href="https://github.com/yjwen/org-reveal" target="_blank" rel="noopener">生成</a>用于<a href="http://lab.hakim.se/reveal-js/#/" target="_blank" rel="noopener">演讲分享的slides</a>。</p><p>emacs的另一个杀手级应用我个人认为是<a href="https://magit.vc" target="_blank" rel="noopener">magit</a>，在emacs里进行 git 的管理。<img src="/images/magit.png" alt="magit"></p><h1>结语</h1><p>提高工作效率，投资硬件是最简单直接生效最快的方法。程序员的日常工作需要大量的文本编辑，emacs很有用，但即使不使用emacs投资时间去掌握一个自己喜欢的编辑器/IDE也是值得的，因为每日的工作大量时间花费在编辑器/IDE里面。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;硬件&lt;/h1&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;p&gt;投资硬件是最简单直接的提高工作效率的方法&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;屏幕与键鼠是程序员与电脑之间的输出输入设置，是程序员每天工作接触时间最长的东西，硬件上的提
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
  </entry>
  
  <entry>
    <title>Scott H Young - 为什么要学&#39;没用&#39;的东西？</title>
    <link href="http://mpwang.github.io/2014/10/17/why-learn-useless-things/"/>
    <id>http://mpwang.github.io/2014/10/17/why-learn-useless-things/</id>
    <published>2014-10-16T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://www.scotthyoung.com/blog/" target="_blank" rel="noopener">Scott Young</a>是一位我很喜欢的博主，他关注于如何&quot;Learn fast, archieve more&quot;，并且身体力行。他最为人津津乐道的事迹是他的<a href="http://www.scotthyoung.com/blog/mit-challenge/" target="_blank" rel="noopener">MIT Challenge</a>，他在12个月的时间用一种苦行僧的生活方式，近似专业运动员训练般的高强度学习完成了MIT4年计算机系的课程学习并且通过了测试。</p><p><a href="http://www.scotthyoung.com/blog/2014/10/03/learn-useless-things/" target="_blank" rel="noopener">Why learn &quot;Useless&quot; Things</a>这篇博文分享了他关于为什么要学习“没用”的东西的观点。</p><p>大意概括Scott的观点如下：</p><ul><li>多学习知识能够增加人的启发式思考</li><li>因为对新领域知识的缺乏在学习新知识时推断当前学习的知识是否“有用”可能不准确，现在看来没用的知识说不定在日后会派上用场</li><li>即使所学的东西真的没用也可以让自己对现实理解的模型更加准确(an accurate model of reality)</li></ul><p>在与朋友闲聊时谈起在业余时间里评估与接触的各种技术与工具时也曾被人问起：“学这个有什么用？（看这种书有什么用？）不如...&quot;，Scott的观点我是十分赞同的，很好的回答了这种问题，对这个问题也曾思索过但是末能够像Scott那样清楚地表达出来。</p><p>在程序员的圈子时也有着什么工具框架API用到的时候再说这种观点，这种观点当然是没错的。但是在遇到新的问题，新的应用场景时如果根本就不知道某种工具/技术/理论的存在，又怎么能够快速找到合适的解决方案呢？很多重复制造出来的轮子就是在这种情况下出现的，所以说博识强记是没错的，博识当然有益，强记不必强求。我自己在最近一个项目里快速地做出了让客户满意的方案，这相当程序得益于我平时阅读博客文章，关注技术动向，遇到有可能用到的工具技术时多加留意并记录下来的习惯。</p><p>Steve Job应该是个相当好的例子，他在大学的时候去旁听了看起来与计算机毫无关系的美术字课程并著迷于书法和字体，并对排版产生了浓厚的兴趣。但是这却让他在日后设计苹果个人电脑时设计出了漂亮的字体帮助苹果赢得了市场。有时现在看来没用的知识，说不定日后真的会派上用场。</p><p>Scott的最后一个观点有些哲学意味，我却是最赞成与喜欢这个观点。霍金在《大设计》一书中提出的最核心观点就是不存在不依赖模型的理论。多学习一点知识也就会获得多一点对于世界的了解，帮助自己形成一个对于认识世界更加准确的模型。从任何意义上说真是有益的。很多人都会有记录日记与写文章的习惯，这能够帮助人思考，但是并不了解这是为什么。几年前的夏天我翻书柜时发现了一本朋友大学时认知心理学的教材，闲来无事读了一遍。却是让我了解到大脑如何主动接受信息的模型，对知识进行深度加工会加深神经元之间的联接从而加深记忆的理论。在那之后我就养成了读书写读书笔记，学习时做思维导图，使用Pocket与Evernote记录信息的习惯。虽然对于认知科学只是有很浅薄的认识，也许我了解的知识不是最准确或者是绝对意义上正确的，但是在自己的实践过程中行之有效并且有益，这就足够了。</p><p>开卷有益，古人诚不我欺。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;http://www.scotthyoung.com/blog/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Scott Young&lt;/a&gt;是一位我很喜欢的博主，他关注于如何&amp;quot;Learn fast, archieve more
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://mpwang.github.io/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
  <entry>
    <title>编程的技艺, 禅与道</title>
    <link href="http://mpwang.github.io/2014/10/15/chitchat---way-to-programming/"/>
    <id>http://mpwang.github.io/2014/10/15/chitchat---way-to-programming/</id>
    <published>2014-10-14T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><em><a href="http://www.douban.com/note/383111983/" target="_blank" rel="noopener">原文</a>备份</em></p><h1>风潮</h1><p>题目起得很大,实则谈的只是一点个人的随想. 首先要说文中并不过多涉及技术细节, 本人更不是什么大牛, 只是浅谈自己的一些不成熟并带有个人色彩的认识, 难免会有偏颇之处. 说得不对说得不好, 不要削我.</p><p>现在似乎有一股风潮(或者说近来有越吹越烈的趋势?), 与计算机, 软件开发或编程相关的事物有时会带上一些有宗教或艺术色彩的文字.来看看一些例子:</p><ul><li>流行的Javascript框架: Dojo(道场)</li><li>流行的PHP框架: Zend PHP(阿维斯陀经注解, 网上解释这是波斯琐罗亚斯德教的圣书, 不太知道应该怎么翻译)</li><li>来自外星人科技Lisp家族的杰作: 编程语言Qi(气)以及他的后继者Shen(神)</li><li>网站设计领域的著名网站: CSS Zen Garden(CSS禅意花园)</li><li>在寓言中暗喻程序员修仙之道的好书: The Tao of programming(编程之道)</li><li>硅谷创业之父Paul Graham文集, 畅销书: 黑客与画家</li><li>计算机领域中当之无愧的传世经典, 被有些好玩的程序员供起来上香奉养的神书: The Art of Computer Programming(计算机程序设计艺术)</li></ul><p>他们起这些名字难道是因为名字带上了宗教与艺术相关的词汇之后显得高大上(可以提升逼格)? 答案肯定是否定的. 以上的例子都是饱含智慧结晶的杰作, 不是随随便便被创作出来. 他们的作者似乎都认为编程是一门技艺, 到了相当的程度之后已经是一种境界一种艺术, 追求的事物用中国文化中代表无上境界的文字来说就是: 禅与道. 不闻乎古人有言: 技可进乎道, 艺可通乎神.</p><p>曾经看过MIT关于SICP的远古上课视频, 记忆深刻的是在第一课上那个教授在黑板上写下大大的两个单词: Computer Science, 然后回过头来对学生们说了一句话, 大意是We are going to learn computer science, but it's not about computer and not about science. 那么究竟是about what? 这么深奥的说法今天还是无法参透啊, 但是可以作为类比吧, 编程究竟又是关于什么的呢. 编程也不仅仅是像程序们自嘲的那样: 我们程序员只是IT民工, 工地搬砖的. 即使是搬砖的, 还是可以有点小追求的.</p><p>在围棋领域中说棋士追求下棋的境界, 人们不会觉得那是他们在扯谈, 而画画, 写作, 作诗, 编曲更是直接与艺术挂钩了. 即使在工程学领域, 作为外行人也曾听闻建筑学上有&quot;建筑是凝固的音乐&quot;这一说法. 它们都有一个共同点, 那就是它们都是一种创造性活动. 而编程作为一种创造性活动, 也是一门技艺. 想写出让人赞叹的程序需要有高超的技巧以及相当的审美观, 如何组织程序, 写出优美的代码, 处理问题逻辑, 考虑系统架构, 设计解决方案就好像画家画画, 作家写书, 同样需要有创造性与灵感以及问题领域的专业知识, 充满挑战与乐趣, 可以称作是工程与美学的结合. 而软件开发更是关于方法论与如何组织人的活动的学问, 研究的是比较玄乎的东西, 不是硬梆梆冷冰冰的计算机硬件. 不同于建筑学此等可以用百年为单位来计数有着悠久历史的学科, 编程或者说是软件开发作为一个行业的历史比较短, 毕竟计算机的大规模普及也只是近代的事情. 关于软件开发没有人知道什么方式是最好的, 所有人都在摸索中前进. 与木匠厨师等职业的经验类似, 前人总结的best practice都是在实践中累积下来的经验之谈, 关于怎么开发软件与编程没有最好的定式, 只有合适实用与否之分. 你没见过厨师做菜的时候切菜要精确到厘米, 下佐料要精确毫克的吧, 即使是有, 这样做出来的菜可以适应不同的食材, 满足不同人的口味吗?</p><p>既然编程是一门技艺, 那么就可以去追求它. 在提升思维质量以及累积领域特定的专业知识之外, 编程这个活动还带有强烈的个人色彩, 其中有得审美因素的影响. 在大量的实践与博识之后, 在编程中就会带上个人的品味. 而品味的形成又会促使技艺的提高, 毕竟口味变刁了, 就会对代码有种精神洁癖或者变成细节控, 逼使自己去让程序变得更符合自己的审美, 在打磨的过程中让程序的品质得到提高. 所以要提高自己的技艺就要努力地形成以及提高自己的品味, 而品味的形成离不开大量的实践与广泛的见识. 写程序与写书本质上非常类似, 不同的是用的是编程语言而不是自然语言. 说起编程语言为什么叫做语言呢, 那是因为在计算机的虚拟世界里, 程序员们在用一种机器可以理解的&quot;语言&quot;来和计算机交流, 告诉他外面的世界是怎么样的, 想要让机器如何运作, 自由地进行创造, 所以称作为&quot;语言&quot;. 但是随着计算机性能的提高以及编译器理论的发展, 在离开与硬件紧密相连的领域, 现在的程序员越来越重视代码的可读性, 编程有着社交属性, 代码还是写给人看的, 翻译成机器指令的工作就交给编译器.</p><p>程序员是工程师, 是problem solver, 问题解决者. 编程员使用工具, 创造工具, 开发软件, 解决问题. 在选择什么工具, 如何创造工具, 如何开发软件, 怎么解决问题的过程中不可避免因为各自审美观与方法论的不同, 各自的答案就会带上个人色彩, 程序员圈子存在着的许多争论就因此而生. 说起来程序员在某些问题上立场鲜明, 与现实中不同党派的支持者政见不同非常类似. 最出名的莫过于Vi与Emacs哪个是最好编辑器之争(顺利一提我是Emacs党, 这篇文章就是在Emacs下写的), 最常见的就各种编程语言支持者之间的争论, 还有类unix vs. Windows, 各种IDE, 解决同个问题的不同库之间的争论等等, 程序员的圈子多姿多彩, 很热闹的啊.</p><p>程序员都是高级的工具使用者与方法论者, 个人觉得实践出真知, 程序员应该抱着实用主义的心态, 不人云亦云地去盲目迷信某种方法论与崇拜某种工具. 在这里说一说个人的一些看法:</p><h1>大规模应用要用云服务器</h1><p>现在这个云服务器概念非常热门, 谷歌的GAE和亚马逊的AWS就不用说了, 国内的大互联网公司都在开展自己的云服务器服务(新浪云, 阿里云, 腾讯云, 百度云, 就连京东也来掺一脚). 但是不是现在大规模的应用和网站就得要用云服务器了? It depends. 提供一个<a href="http://highscalability.com/blog/2014/7/21/stackoverflow-update-560m-pageviews-a-month-25-servers-and-i.html" target="_blank" rel="noopener">例子</a>, StackExchange由100多个网站构成，其中包括了Alexa排名第54的StackOverflow(相信这个网站不会陌生)。StackExchang有400万用户，每月5.6亿PV，但只用25台服务器. 它的Windows服务器运行的操作系统版本是Windows 2012 R2，Linux服务器运行Centos 6.4.5.6亿PV, 25台服务器, 其中有11台运行的Web服务器是微软的IIS. 好像现在一提Web服务器就想起Apache和Nginx, 微软家的IIS不太受欢迎, 但是SO的例子还是说IIS很好用的.</p><h1>设计模式很牛逼</h1><p>听说面试经常会问到? 诚然了解各种设计模式的概念并在合适的地方使用它是有益的. 但是反对将它捧得太高, 在代码中为了用它而用它, 好像用了设计模式代码就闪闪发光, 品质立马提高. 了解设计模式之后, 反而会破除对它的迷信. 可能有人会提<a href="http://coolshell.cn/articles/3320.html" target="_blank" rel="noopener">JDK源码里面用了23种设计模式的例子</a>来支持使用设计模式, 但是个人觉得如果你同时了解Java和设计模式, 你就会发现设计模式的使用正是因为Java这种语言比较冗余缺乏表达力, 所以需求显式地使用设计模式来弥补它的不足. 谷歌的研究主管Peter Norvig在一篇1998年的<a href="http://norvig.com/design-patterns/" target="_blank" rel="noopener">文章</a>中就讨论了动态语言中设计模式, 你可以看到在表达能力比较强的动态语言(还可以推广到一些强类型的函数式语言)中有些设计模式已经被隐式地包含了, 不需要显式地去使用它. 但是理解各种设计模式的概念能够让你在代码中将它们识别出来, 并在必要的合适的地方使用它们来绕过语言的缺憾来达到目的. 就像Head First Design pattern一书说的, 不能去强行修改代码来迎合某种设计模式. 八封一下, 王垠大神在博客中也有说过每当他在代码中清除一个设计模式, 他的代码就变得更加简洁, 更加容易理解(此等境界, 目前仰望中).</p><h1>哪种编程语言最好</h1><p>各种争论之中, 编程语言之争好像是最激烈的, 到处都可以看到不同语言之间的支持者在掐架. 我是right tool for the right job的支持者, 我不会用C来写生成动态网页的程序, 也不会用Haskell来做系统管理的任务. 如果有一种编程语言是最好的, 那一种编程语言就足够了, 那为什么会有这么多编程语言, 而且新语言还在不停地诞生? 近来比较热门的新语言有Go, Rust, JVM平台上的Ceylon, 编译成C的Nimrod, Erlan平台(BVM)上的Elixir. 答案就是没有最好的编程语言, 只有合适的编程语言. 要完成特定的任务就选用特定的语言与相应的工具. 新语言的出现是因为编程语言的理论研究(像新的类型系统)在发展, 程序员的需求在同样也变化, 而越是热门的语言变化就越慢, 当有人感到现在的语言满足不了需要时, 新的编程语言就被创造出来. 多了解几门语言之后就会发现, 类似的编程概念与经验在各种语言之间是相通的, 不同是各种编程语言各自独有的特性与概念. 八卦一下垠神在博客中有说过他不羡慕各种编程语言的特性, 因为他了解背后编译器是怎么实现它们的, 如果他想要他就可以做出来. 他貌似写过很多编译器当乐趣消遣. 他最近加入了<a href="http://sourcegraph.com/" target="_blank" rel="noopener">sourcegraph</a>, 其中对Python/Ruby代码的分析就是以他的工作为基础的.</p><h1>敏捷开发</h1><p>推荐<a href="http://coolshell.cn/articles/3745.html" target="_blank" rel="noopener">一篇陈皓的文章</a>. 在我离开之前的公司时, 公司内部有着推广敏捷开发的氛围, 各种各样的讲座,分享会, 在团队内部推行daily stand-up meeting, 但是即使是使用了scrum, story, rapid iteration等概念, 实际工作中字官僚主义横行, 项目的流程还是老一套的样子, 只学其形不见其真意. 个人就不多说, 只想说方法论只是方法论, 能不能够真正去使用这种哲学做出好东西来才是重点. 原教旨主义绝对不可取.</p><p>作为一个普通的程序员, 想成为一个好的程序员还有太多东西需要学习啊.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;&lt;a href=&quot;http://www.douban.com/note/383111983/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;原文&lt;/a&gt;备份&lt;/em&gt;&lt;/p&gt;
&lt;h1&gt;风潮&lt;/h1&gt;
&lt;p&gt;题目起得很大,实则谈的只是一点个人的随想.
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://mpwang.github.io/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
  <entry>
    <title>Common Lisp - 想说爱你不容易</title>
    <link href="http://mpwang.github.io/2014/10/14/common-lisp-too-hard-to-love/"/>
    <id>http://mpwang.github.io/2014/10/14/common-lisp-too-hard-to-love/</id>
    <published>2014-10-13T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><em><a href="http://www.douban.com/note/227176889/" target="_blank" rel="noopener">原文</a>备份</em></p><p>前阵子由阮一峰翻译出版的黑客与画家一书似乎激起了不少人对于Lisp的兴趣，出于个人兴趣开始学习Lisp有一段时间，在这里写写自己接触Lisp过程的感想。</p><p>Lisp目前有两种主要的dialect: Common Lisp和Scheme。</p><p>Scheme对于Scheme我了解不深只用过其中一种dialect: Racket一段时间。Racket有一个非常方便使用的IDE: DrRacket(它附带了很多教学包)以及非常详细的文档说明，学习期间阅读了&lt;<htdp>&gt;和&lt;<the little="" schemer="">&gt;，在了解Lisp的基本思想之后我发现Scheme很难使用(也许是我没有深入学习），来google了一些Scheme和Common Lisp的比较后，我转向了Common Lisp。</the></htdp></p><h1>Welcome to Common Lisp</h1><p>首先来看一下CL的实现列表，看一下还真不少啊，商业收费和免费开源都有，想当初为选择哪一个实现好纠结了一段时间。从好的方面说，有这么多的实现可以让人选择在不同环境下用不同的实现，但是这也带来了问题：社区的分化和库的通用性问题。如果不想代码只能在特定的CL实现上运行，写代码的就要考虑不同CL实现之间的通用性，真是让人头疼。</p><h1>IDE</h1><p>写CL用什么IDE呢？google一下你会告诉大家都用Emacs+SLIME(少部分人用Vim+SLIMV，但是我相信Lisp程序员最终还是用回到Emacs的怀抱的）。Eclipse也有CL的插件Cusp，但个人感觉并不好用。</p><p>来看看典型的Common Lisp工作环境：Emacs + SLIME。你需要掌握：</p><ol><li>Common Lisp语言</li><li>Common Lisp实现的特定细节 比如run time options，实现对于CL的扩展等</li><li>Emacs: 包括基本操作，配置初始文件(.emcas or .emacs.d/init.el)设置好SLIME</li><li>Paredit: Emcas的extension，用于方便地编辑括号与Lisp表达式</li><li>SLIME: 基本操作</li></ol><p>好吧，并不是说Emacs不好，事实上Emcas+SLIME对于熟练的程序员来说是一个非常强力的编程环境，但是对于没有接触过Emacs的程序员来说，在学习CL的过程中就要同时学习使用Emacs，当然长期来说是有好处，但是这么陡峭的学习曲线已经足于让大多数初学者望而止步。</p><p>在这里要提一下，CL是一种比较verbose的语言，有些函数名像multiple-value-bind destructuring-bind是相当的长，没有好的编辑器支持补全功能的话会容易写错。如果没有自动缩进功能的话，lisp code写起来是相当痛苦的。</p><h1>Modern Features</h1><p>Lisp是一门相当古老的语言，资深的Common Lisper会告诉你X语言的Y特性可以在Lisp中找到或者通过Z的方式用Lisp实现，但是不可否认的是Common Lisp语言本身缺少对一些现今重要的编程概念/工具的支持。</p><p>Common Lisp是在94年完成了标准化，标准给具体的实现留下了相当大的空间，Network programming、Thread、GUI都没有覆盖到。也有人说委员会决定了能够经得起时间考验的核心部分，这些个随时间变动的部分就留给具体的实现。当然这些都可以通过库来支持，但是问题也随之而来，不同的实现+不同的库的选择无疑给程序员带来了难题。(支持不同实现的网络编程库有USOCKET,支持不同实现的线程库有bordeaux-threads，当然它们也不是100% portable的)</p><p>由于历史原因，Common Lisp没有在不同的数据结构之间建立一个统一的抽象，因为一开始CL中所有的数据结构都是用List实现的(Use Lists For Everything - ULFE)。CL有两套分别用于List和Vector的函数，一套用于Sequence抽象(List/Vector/String)的函数，一套用于hash-table的函数。在提供不同数据结构统一的抽象这一点上Clojure做得非常好。</p><p>缺少字面值hash-table(可以通过reader macro在某种程度上实现)，用过Javascript和Clojure的应该都明白它的强大之处，最近Java7也加入了类似的功能。</p><h1>Library &amp; Hacker Culture</h1><p>许多关于CL的抱怨都是关于库的，CL库的数量比较少(相比于Java/C/C++这些主流语言)，而且大多数库都是poor-documented的，缺少详细的说明和例子。写高质量文档对于程序员来说不是件简单轻松的事，而且CL作为一种冷门语言市场上没有太多职位提供给CL程序员，所以也就没有那么人能够得到金钱支持或贡献个人时间来写免费开源的库。我一直听到有人说Lisp是多么多么强大，是的，Lisp非常强大，我知道，但是如果一种编程语言不能容易地与外部世界打交道的话，It doesn't make sense.</p><p>举个例子，用Common Lisp来做XML处理，上Cliki找一下发现有不少啊，我应该用哪一个呢？随便点开看看，发现大多数文档中API的说明不太清楚。而且不是资深的CLer的话也缺少相应的知识来回答下面的问题：哪个库更好？这个库可不可以信任？它有没有bugs? 性能怎么样？它是在活跃的开发中还是已经停止维护了(dead-project)？</p><p>为什么会样子，这个现象也与Lisp的Hacker文化有关。Lisp是给Hacker准备的语言，它的强大力量只会在越过了陡峭的学习曲线的某一点后显示出来。因为Common Lisp的表达能力是这么的强大几个人甚至一个smart guy单枪匹马就能够写出足够复杂的程序来，所以大规模的CL hacker合作项目比较少。结果就是每个Hacker都有自己的solution,开发者开发它用来解决的自己工作项目的特定问题，后来开源出来了并不代表它适用于其它用户。Common Lisp的强大反而阻碍了库的标准化，而且Common Lisp也没有类似CPAN for Perl这样的东西存在。</p><p>QuickLisp的出现是一个福音，能够解决库的依赖问题以及自己下载相应的库，目前有700个上下的库。</p><p>Reddit.com讲述了他们从Common Lisp迁移到Python上的原因，主要也是缺少库的问题。</p><h1>Advantages</h1><p>在克服了这么多困难之后，你还是选择了Common Lisp，有什么好处呢？</p><h2>Macro</h2><p>Common Lisp的强大的Macro会让你轻松的扩展CL本身来迎合自己的需求，最终形成一个用来解决你的特定问题的DSL。Lisp语言的Macro提供了语法层次上的抽象，让你可以将反复在程式上出现的模式抽象出来，这也是Lisp强大以及和其它语言区分开来的一个原因。</p><h2>多范式</h2><p>Common Lisp的多范式编程可以让你自由地表达自己思想，指令式编程？没有问题，面向对象？没有问题，函数式编程？没有问题，混合着一起使用都没有问题。</p><h2>REPL（Read-Evaluate-Print-Loop)</h2><p>Lisp为人津津乐道的功能就是它的快速原型开发， 为什么快，因为它全程提供了一个REPL环境，在编译型语言中你需要经历写代码-编译-运行-试错-修改-编译...的流程，而在Lisp语言中你可以实时地更新代码，基本是一边写代码一边在ＲＥＰＬ中测试然后马上修改然后马上得到新的程序然后继续试验，从编写代码到看到代码的输出的循环是如此的短以至于它极高的提高了程序员的生产率（当然这只是理想情况），read-time compile-time run-time基本上是没有区别的（对于macro来说read-time与compile-time有所区别，这里不详谈），这就是用Lisp能够快速开发出软件原型的原因。PG在这篇被CLer反复提到的文章(Beating the Averages)中提到他开发ViaWeb的故事，Common Lisp就是它的秘密武器。可能最后你的程序会迁移到其它语言/平台上，但是你可以快速地构建出软件的雏形。</p><h1>End</h1><p>Common Lisp真的是让人又爱又恨，不过就算不用CL学习它也用对你有所帮助。新技术层出不穷，而Common Lisp会继续稳定地保持下去，它会继续被用于人工智能领域，研究机构，用于解决复杂度非常高的问题，大公司开发的内部工具。然而对于一般的程序员来说，想用Common Lisp作为自己的首要编程语言真的不太容易。在过去50多年的历史Lisp都没能流行起来，未来也许也不会流行起来。如果问哪种Lisp dialect有可能流行起来的话，Clojure 应该就是其中的佼佼者，作为一门新兴的语言它正在吸引越来越多人的眼光，许多人选择它的程序员有着Rudy/Python/Java/Common Lip的背景，基于JVM平台得益于java ecosystem它天生就解决了库的问题。</p><p>PS：对于common lisp还有building system和deployment/delivery的问题没有谈，因为没有用CL做过实际项目这些并不了解，但是也知道其中也有被人诟病的地方。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;&lt;a href=&quot;http://www.douban.com/note/227176889/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;原文&lt;/a&gt;备份&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;前阵子由阮一峰翻译出版的黑客与画家一书似乎激起了不少人对于Lisp
      
    
    </summary>
    
    
      <category term="Lisp" scheme="http://mpwang.github.io/tags/Lisp/"/>
    
      <category term="CommonLisp" scheme="http://mpwang.github.io/tags/CommonLisp/"/>
    
  </entry>
  
  <entry>
    <title>using emacs under mac</title>
    <link href="http://mpwang.github.io/2013/08/10/using-emacs-under-mac/"/>
    <id>http://mpwang.github.io/2013/08/10/using-emacs-under-mac/</id>
    <published>2013-08-09T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>在mac下折腾了emacs有一段时间了，写点经验分享一下，顺便一提，mac下cocoa应用全局的emacs按键绑定太舒服了。</p><h1>安装Emacs</h1><p>mac默认安装了emacs的，不过版本比较旧(22.x)，而且只能在终端下使用，这里选用homebrew来安装Emacs, 首先安装<a href="http://brew.sh/" target="_blank" rel="noopener">homebrew</a>：</p><pre><code>ruby -e &quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)&quot;# --cocoa选项表示安装带图形化界面的emacsbrew install emacs --cocoa</code></pre><p>安装后brew会提示你可以运行一个命令将emacs 24.3版本链接到/Applications下，这样在应用程序中可以直接双击打开emacs。</p><h1>Mac下的设置</h1><p>使用emacs可能会遇到键位设置的问题，有些键盘上没有option键只有alt键，使用发现alt键不起作用，用来运用<code>M-x</code>的绑定变成了<code>Esc-x</code>。解决方法如下：</p><p>在自带的终端下使用: 偏好设置 -&gt; 设置 -&gt; 键盘 -&gt; 勾上使用option键作为meta键</p><p>在iterm2下使用:Preferences -&gt; Profiles -&gt; 选择配置文件 -&gt;　keys　-&gt;　在Left/Right option key acts 选项选择 +Esc</p><p>在图形化界面下设置需要在emacs初始文件(~/.emacs.d/init.el)中加上：</p><pre><code>（when (eq system-type 'darwin);; use option key as meta key(setq mac-option-modifier 'meta)）</code></pre><h1>以daemon的方式使用emacs</h1><p>双击Emacs.app每次都会重新打开一个新的进程来跑emacs, 我更喜欢emacs server + emacs client的方式。用<code>emacs --daemon</code>的方式找开一个后台跑的emacs服务进程，再来emacsclient来连接。</p><p>在~/.bash_profile(使用zsh的话就是~/.zshrc)中加入以下alias</p><pre><code># 启动emacs后台进程alias emdaemon=&quot;emacs --daemon&quot;# 结束emacs后台进程alias emkill=&quot;emacsclient -e '(kill-emacs)'&quot;# 新建emacs窗口来编辑文件alias ec=&quot;emacsclient -c $@&quot;</code></pre><p>在init.el中加上</p><pre><code>(setq window-system-default-frame-alist  '(    ;; if frame created on Macintosh Cocoa display    (ns     (menu-bar-lines . 1)     (tool-bar-lines . nil)     ;; mouse     (mouse-wheel-mode . 1)     (mouse-wheel-follow-mouse . t)     (mouse-avoidance-mode . 'exile)     ;; face     (font . &quot;Monaco 12&quot;)     ;; frame size     (width . 96)     (height . 60)     )    ;; if on term    (nil     (menu-bar-lines . 0)     (tool-bar-lines . 0)     ;; (background-color . &quot;black&quot;)     ;; (foreground-color . &quot;white&quot;)     )    )  )</code></pre><p><a href="http://emacser.com/daemon.htm" title="使用Emacs daemon" target="_blank" rel="noopener">Emacs中文网这篇文章</a>有更详细的介绍关于emacsclient新建frame设置的介绍。</p><h1>参考文章</h1><ul><li><a href="http://kelly-mclaughlin.com/2012/07/27/emacs-daemon.html" target="_blank" rel="noopener">Setting up the Emacs daemon on OS X</a></li><li><a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html" target="_blank" rel="noopener">Using Emacs as a Server</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在mac下折腾了emacs有一段时间了，写点经验分享一下，顺便一提，mac下cocoa应用全局的emacs按键绑定太舒服了。&lt;/p&gt;
&lt;h1&gt;安装Emacs&lt;/h1&gt;
&lt;p&gt;mac默认安装了emacs的，不过版本比较旧(22.x)，而且只能在终端下使用，这里选用homebr
      
    
    </summary>
    
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
      <category term="Mac" scheme="http://mpwang.github.io/tags/Mac/"/>
    
  </entry>
  
  <entry>
    <title>windows下搭建jekyll环境</title>
    <link href="http://mpwang.github.io/2013/08/08/windowsjekyll/"/>
    <id>http://mpwang.github.io/2013/08/08/windowsjekyll/</id>
    <published>2013-08-07T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<h1>安装Ruby</h1><p>Jekyll是基于Ruby的静态网页生成工具，使用rubyinstaller在windows下安装Ruby. <a href="http://rubyinstaller.org/downloads/" target="_blank" rel="noopener">下载链接</a>.在RubyInstallersArchives下选择合适的版本，64位系统选择(x64)结尾的安装文件。</p><p>安装rubyinstaller到D:\Ruby200. 确保安装时在安装界面中选中添加ruby到环境变量的选项。</p><h2>安装Ruby DevKit</h2><p><a href="http://rubyinstaller.org/downloads/" target="_blank" rel="noopener">下载链接</a>.在Development Kit下选择合适版本。下回来的文件是个7z的自解压包，解压到D:\Rubydevkit. 运行</p><pre><code>ruby dk.rb initruby hk.rb install</code></pre><h1>安装jekyll</h1><p>理论到直接运行</p><pre><code>gem install jekyll</code></pre><p>就可以安装jekyll了，但是国内的网络环境（你懂的）可能访问不到rubygems，因为rubygem的服务使用了Amazon的云服务器。但是可以使用淘宝的国内镜像：<a href="http://ruby.taobao.org/" target="_blank" rel="noopener">http://ruby.taobao.org/</a>.</p><pre><code>$ gem sources --remove https://rubygems.org/$ gem sources -a http://ruby.taobao.org/$ gem sources -l*** CURRENT SOURCES ***http://ruby.taobao.org# 请确保只有 ruby.taobao.org</code></pre><p>先用<code>gem sources -l</code>看看，有些情况下是默认使用http://rubygems.org 而不是https://rubygems.org</p><pre><code>gem install jekyll</code></pre><p>下载jekyll</p><p>至此jekyll就成功安装并且可以使用了。</p><h1>安装Python</h1><p>Jekyll使用Pygments在高亮代码，而Pygments是基于Python的。首先安装Python, windows上选用<a href="http://portablepython.com/wiki/PortablePython3.2.1.1/" target="_blank" rel="noopener">Portable Python</a>。安装到D:\Portable_Python</p><p>然后将Portable Python下的App\Scripts和App目录添加到环境变量PATH中。</p><h2>安装easy install</h2><p>easy install是Python库的管理软件，类似于gem对于Ruby。我们安装easy install来安装Pygments. <a href="https://pypi.python.org/pypi/setuptools/0.9.8#windows" target="_blank" rel="noopener">https://pypi.python.org/pypi/setuptools/0.9.8#windows</a>,在python官网这一节介绍中可以找到怎么在windows下安装easy installer的说明，保存<a href="https://bitbucket.org/pypa/setuptools/raw/bootstrap/ez_setup.py" target="_blank" rel="noopener">ez_setup.py</a>到本地，比如说D:\</p><pre><code>python ez_setup.py</code></pre><h2>安装Pygments#</h2><pre><code>easy_install Pygments</code></pre><h1>安装git</h1><p>用jekyll写博客少不了用git啦，下载安装<a href="http://msysgit.github.io/" target="_blank" rel="noopener">msysgit</a>.把安装界面上的选项全部勾上，选项全部默认就好。</p><h1>第一个模板</h1><p>现在jekyll环境已经成功搭建了，下个jekyll bootstrap模板体验一下。在开始菜单中找开git bash.</p><pre><code>cd /Dgit clone https://github.com/jekyllbootstrap/theme-the-program.gitcd theme-the-programjekyll serve</code></pre><p>访问http://localhost:4040</p><h1>深入了解jekyll</h1><p>了解jekyll的配置和各个文件的作用，这篇文章是个很好的入门：<a href="jiyeqian.github.io/2012/07/host-your-pages-at-github-using-jekyll/">基于jekyll的github建站指南</a></p><h1>参考文章</h1><ul><li><a href="http://blog.chengyunfeng.com/?p=437" target="_blank" rel="noopener">在Windows系统配置Jekyll</a></li><li><a href="jiyeqian.github.io/2012/07/host-your-pages-at-github-using-jekyll/">基于jekyll的github建站指南</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;安装Ruby&lt;/h1&gt;
&lt;p&gt;Jekyll是基于Ruby的静态网页生成工具，使用rubyinstaller在windows下安装Ruby. &lt;a href=&quot;http://rubyinstaller.org/downloads/&quot; target=&quot;_blank&quot; rel=
      
    
    </summary>
    
    
      <category term="Jekyll" scheme="http://mpwang.github.io/tags/Jekyll/"/>
    
      <category term="Ruby" scheme="http://mpwang.github.io/tags/Ruby/"/>
    
      <category term="Git" scheme="http://mpwang.github.io/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Setup Clojure with SLIME under Emacs</title>
    <link href="http://mpwang.github.io/2012/08/24/setup-clojure-with-slime-under-emacs/"/>
    <id>http://mpwang.github.io/2012/08/24/setup-clojure-with-slime-under-emacs/</id>
    <published>2012-08-23T16:00:00.000Z</published>
    <updated>2017-08-05T11:30:25.000Z</updated>
    
    <content type="html"><![CDATA[<hr><p>Updated:</p><blockquote><p>Swank Clojure is deprecated in favour of nrepl.el</p></blockquote><p><a href="https://github.com/kingtim/nrepl.el" target="_blank" rel="noopener">nrepl.el on Github</a></p><hr><h2>Clojure Side</h2><ul><li>Clojure</li><li><a href="https://github.com/technomancy/leiningen" target="_blank" rel="noopener">Leiningen</a></li></ul><h2>Emcas Side</h2><ul><li>Emcas (normally with SLIME installed)</li><li>clojure-mode</li></ul><p>Basically what you need is leiningen on Clojure side and clojure-mode on Emacs side.</p><h2>Setup lein</h2><p>Install lein according to the instructions on its index.For lein 2.0 add such line into your global user profile <strong>.lein/profiles.clj</strong>.</p><pre><code>{:user {:plugins [[lein-swank &quot;1.4.4&quot;]]}}</code></pre><p>If you still use lein 1.x, you need such steps.</p><ul><li>run <code>lein plugin install lein-swank 1.4.4</code></li><li>add <code>:dev-dependencies [[lein-swank &quot;1.4.4&quot;]]</code> to your project.clj</li></ul><h2>Setup clojure-mode</h2><p>Download <a href="https://github.com/technomancy/clojure-mode" target="_blank" rel="noopener">clojure-mode.el</a>, place it under your emacs load path, add such line to your .emacs file.</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">require</span> 'clojure-mode)</span><br></pre></td></tr></table></figure><p>You may install <strong>paredit</strong> and <strong>rainbow-delimiters</strong> to enhance experience for writting Clojure code with Emacs.</p><h2>Start up SLIME with Clojure</h2><p>Now</p><pre><code>M-x clojure-jack-in</code></pre><p><strong>Warn: conflit with inferior-lisp-program</strong></p><p>Sometimes you work under Emacs with Common Lisp before, you may see Emacs pop up with a window of error message when run the command above. That's might be caused by the previous compiled swank version for common lisp.</p><p><strong>Comment out</strong> your setup for Common Lisp in your .emacs like below and try again:</p><pre><code>(setq inferior-lisp-program &quot;sbcl --noinform&quot;)</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;Updated:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Swank Clojure is deprecated in favour of nrepl.el&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/king
      
    
    </summary>
    
    
      <category term="Lisp" scheme="http://mpwang.github.io/tags/Lisp/"/>
    
      <category term="Clojure" scheme="http://mpwang.github.io/tags/Clojure/"/>
    
      <category term="Emacs" scheme="http://mpwang.github.io/tags/Emacs/"/>
    
  </entry>
  
</feed>
